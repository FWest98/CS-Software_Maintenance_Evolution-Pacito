Pattern changes caused by commit: 212dff13ec8636755b5239c00a8c1eda25ee816b

From: Mediator-0
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-381.txt 

commit 212dff13ec8636755b5239c00a8c1eda25ee816b
Author: Michael Stack <stack@apache.org>

    HDFS-927 DFSInputStream retries too many times for new block location



==================================
 Issue HDFS-927 Description 
=======================================

Project: Hadoop HDFS
-----------------

-----------------
Title: [HDFS-927] DFSInputStream retries too many times for new block locations
-----------------

-----------------
Summary: DFSInputStream retries too many times for new block locations
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Closed
-----------------

-----------------
Created at: Tue, 26 Jan 2010 21:36:13 +0000
-----------------

-----------------
Resolved at: Tue, 9 Feb 2010 20:28:33 +0000
-----------------

-----------------
Assigned to: Todd Lipcon
-----------------

-----------------
Description: 

I think this is a regression caused by <a
href="https://issues.apache.org/jira/browse/HDFS-127" title="DFSClient block read failures
cause open DFSInputStream to become unusable" class="issue-link"
data-issue-key="HDFS-127"><del>HDFS-127</del></a> &#8211; DFSInputStream is supposed to
only go back to the NN max.block.acquires times, but in trunk it goes back twice as many -
the default is 3, but I am counting 7 calls to getBlockLocations before an exception is
thrown.
 

-----------------

-----------------
Comments: 

New Comment: 
The crux of this issue is that the original <a
href="https://issues.apache.org/jira/browse/HDFS-127" title="DFSClient block read failures
cause open DFSInputStream to become unusable" class="issue-link"
data-issue-key="HDFS-127"><del>HDFS-127</del></a> patch was bad. I'm not sure why it
caused an infinite loop on 0.20 but not on later branches, but either way it doesn't do
what it was supposed to.This patch adds test cases to check infinite loop behavior and
also to verify that the correct number of retries are taken. I also took the approach I
outlined at <a
href="https://issues.apache.org/jira/browse/HDFS-127?focusedCommentId=12803077&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12803077"
class="external-link"
rel="nofollow">https://issues.apache.org/jira/browse/HDFS-127?focusedCommentId=12803077&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12803077</a>
to fix <a href="https://issues.apache.org/jira/browse/HDFS-127" title="DFSClient block
read failures cause open DFSInputStream to become unusable" class="issue-link"
data-issue-key="HDFS-127"><del>HDFS-127</del></a>'s retry logic. 


New Comment: 
-1 overall.  Here are the results of testing the latest attachment <br/>  <a
href="http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt"
class="external-link"
rel="nofollow">http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt</a><br/>
 against trunk revision 903381.    +1 @author.  The patch does not contain any @author
tags.    +1 tests included.  The patch appears to include 8 new or modified tests.    +1
javadoc.  The javadoc tool did not generate any warning messages.    +1 javac.  The
applied patch does not increase the total number of javac compiler warnings.    +1
findbugs.  The patch does not introduce any new Findbugs warnings.    +1 release audit. 
The applied patch does not increase the total number of release audit warnings.    -1 core
tests.  The patch failed core unit tests.    +1 contrib tests.  The patch passed contrib
unit tests.Test results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/testReport/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/testReport/</a><br/>Findbugs
warnings: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html</a><br/>Checkstyle
results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/artifact/trunk/build/test/checkstyle-errors.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/artifact/trunk/build/test/checkstyle-errors.html</a><br/>Console
output: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/console"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/207/console</a>This
message is automatically generated. 


New Comment: 
arg, same flaky NoClassDefFound Hudson junk. resubmitting 


New Comment: 
-1 overall.  Here are the results of testing the latest attachment <br/>  <a
href="http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt"
class="external-link"
rel="nofollow">http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt</a><br/>
 against trunk revision 903381.    +1 @author.  The patch does not contain any @author
tags.    +1 tests included.  The patch appears to include 8 new or modified tests.    +1
javadoc.  The javadoc tool did not generate any warning messages.    +1 javac.  The
applied patch does not increase the total number of javac compiler warnings.    +1
findbugs.  The patch does not introduce any new Findbugs warnings.    +1 release audit. 
The applied patch does not increase the total number of release audit warnings.    -1 core
tests.  The patch failed core unit tests.    +1 contrib tests.  The patch passed contrib
unit tests.Test results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/testReport/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/testReport/</a><br/>Findbugs
warnings: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html</a><br/>Checkstyle
results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/artifact/trunk/build/test/checkstyle-errors.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/artifact/trunk/build/test/checkstyle-errors.html</a><br/>Console
output: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/console"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/console</a>This
message is automatically generated. 


New Comment: 
Can anyone explain this hudson result? it says -1 core tests, but the Test results page
shows no failures... 


New Comment: 
In the <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/106/testReport/"
class="external-link" rel="nofollow">test result</a>, there are 51 tests less than the
previous build.  I bet the build encountered some problem.  Let's try again. 


New Comment: 
-1 overall.  Here are the results of testing the latest attachment <br/>  <a
href="http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt"
class="external-link"
rel="nofollow">http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt</a><br/>
 against trunk revision 903906.    +1 @author.  The patch does not contain any @author
tags.    +1 tests included.  The patch appears to include 8 new or modified tests.    +1
javadoc.  The javadoc tool did not generate any warning messages.    +1 javac.  The
applied patch does not increase the total number of javac compiler warnings.    +1
findbugs.  The patch does not introduce any new Findbugs warnings.    +1 release audit. 
The applied patch does not increase the total number of release audit warnings.    -1 core
tests.  The patch failed core unit tests.    -1 contrib tests.  The patch failed contrib
unit tests.Test results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/testReport/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/testReport/</a><br/>Findbugs
warnings: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html</a><br/>Checkstyle
results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/artifact/trunk/build/test/checkstyle-errors.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/artifact/trunk/build/test/checkstyle-errors.html</a><br/>Console
output: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/console"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/108/console</a>This
message is automatically generated. 


New Comment: 
Yet another test-patch snafu... NoClassDefFound errors, etc....I guess will resubmit?
Hudson is becoming useless. 


New Comment: 
-1 overall.  Here are the results of testing the latest attachment <br/>  <a
href="http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt"
class="external-link"
rel="nofollow">http://issues.apache.org/jira/secure/attachment/12431471/hdfs-927.txt</a><br/>
 against trunk revision 903906.    +1 @author.  The patch does not contain any @author
tags.    +1 tests included.  The patch appears to include 8 new or modified tests.    +1
javadoc.  The javadoc tool did not generate any warning messages.    +1 javac.  The
applied patch does not increase the total number of javac compiler warnings.    +1
findbugs.  The patch does not introduce any new Findbugs warnings.    +1 release audit. 
The applied patch does not increase the total number of release audit warnings.    -1 core
tests.  The patch failed core unit tests.    -1 contrib tests.  The patch failed contrib
unit tests.Test results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/testReport/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/testReport/</a><br/>Findbugs
warnings: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html</a><br/>Checkstyle
results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/artifact/trunk/build/test/checkstyle-errors.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/artifact/trunk/build/test/checkstyle-errors.html</a><br/>Console
output: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/console"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/213/console</a>This
message is automatically generated. 


New Comment: 
The three test-patches above all failed, but none of them had any failures in common
except for org.apache.hadoop.hdfsproxy.TestProxyUtil.testSendCommand which is almost
certainly related to recent security work...So please ignore the -1s. This patch is well
unit tested by existing as well as new tests. 


New Comment: 
The patch looks good to me resetting the 'failures' data member at the head of the two
read methods above the chooseDataNode calls.  I like the comment clarifying the intent of
'failures'.I ran the test suite and it looks like it all passed but result fell off the
top of my screen.  Will be back in morning with whether all tests passed for me locally. 


New Comment: 
+1 on commit.  When I ran:<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">$ ANT_HOME=/usr/bin/ant ant
-Dfindbugs.home=/Users/stack/bin/findbugs-1.3.9 -Djava5.home=/<span
class="code-object">System</span>/Library/Frameworks/JavaVM.framework/Versions/1.5/Home/
-Dforrest.home=/Users/stack/bin/apache-forrest-0.8 -Dcurl.cmd=/usr/bin/curl
-Dpatch.file=/tmp/hdfs-927.txt test-patch</pre></div></div>on my local machine I got
this...<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java">...     [exec] There appear to be 114 release audit
warnings before the patch and 114 release audit warnings after applying the patch.    
[exec]      [exec]      [exec]      [exec]      [exec] +1 overall.       [exec]     
[exec]     +1 @author.  The patch does not contain any @author tags.     [exec]     
[exec]     +1 tests included.  The patch appears to include 8 <span
class="code-keyword">new</span> or modified tests.     [exec]      [exec]     +1 javadoc. 
The javadoc tool did not generate any warning messages.     [exec]      [exec]     +1
javac.  The applied patch does not increase the total number of javac compiler warnings.  
  [exec]      [exec]     +1 findbugs.  The patch does not introduce any <span
class="code-keyword">new</span> Findbugs warnings.     [exec]      [exec]     +1 release
audit.  The applied patch does not increase the total number of release audit warnings.   
 [exec]      [exec]      [exec]      [exec]      [exec]
======================================================================     [exec]
======================================================================     [exec]    
Finished build.     [exec]
======================================================================     [exec]
======================================================================     [exec]     
[exec] BUILD SUCCESSFULTotal time: 12 minutes 47 seconds</pre></div></div> 


New Comment: 
I also ran full hdfs test suite.  All tests passed though it failed in test-cactus:<div
class="code panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">/Users/stack/checkouts/hdfs/trunk/build.xml:588: The following error
occurred <span class="code-keyword">while</span> executing <span
class="code-keyword">this</span> line:/Users/stack/checkouts/hdfs/trunk/build.xml:569: The
following error occurred <span class="code-keyword">while</span> executing <span
class="code-keyword">this</span>
line:/Users/stack/checkouts/hdfs/trunk/src/contrib/build.xml:48: The following error
occurred <span class="code-keyword">while</span> executing <span
class="code-keyword">this</span> line:java.lang.NoSuchMethodError:
org.apache.cactus.integration.ant.CactusTask.addClasspathEntry(Ljava/lang/<span
class="code-object">String</span>;)VTotal time: 65 minutes 17 seconds</pre></div></div>No
cactus on my machine... 


New Comment: 
Should the failure count be reset per block, but not per read?Also, I tried the patch. 
TestReadWhileWriting and TestFiHFlush failed although they do not seem related to the
patch. 


New Comment: 
Hey Nicholas. Thanks for taking a look.<blockquote>Should the failure count be reset per
block, but not per read?</blockquote>This doesn't match my expectation. Consider the case
of HBase, where a region server opens a single region (which may very well be a single
block) and holds it open for days at a time. During the time while it's open, it may
experience sporadic errors every once in a while due to a network blip or what have you.
Just because the reader saw an error at 12pm, 3pm, and 6pm doesn't mean it should fail
when it sees one at 9pm. Any successful read operation should reset the count, regardless
of which block is being accessed, don't you think? 


New Comment: 
&gt; ... don't you think?<br/>I actually mean "per read per block", i.e. within a singe
read, there are 3 retries for each block.I have no problem if we want to do it "per read".
 Stack, what do you think? 


New Comment: 
Ah, I see what you're saying. So, if you do a read that crosses a block boundary A-B, and
get 2 errors at the end of block A, and 2 errors at the start of block B, you should still
be OK?I could go either way here. Part of me thinks that if you have errors on both sides
of a block boundary for a single read, your client is probably in a bad state and you're
likely to fail either way?Since some are considering this an 0.20.2 blocker, could we get
this commited as a solid improvement over what's there now (which makes very little sense)
and then discuss whether the block boundary case should be improved? 


New Comment: 
.bq I actually mean "per read per block", i.e. within a singe read, there are 3 retries
for each block.That would be better in that with the current patch, on a 3 block file, if
we hiccupped the first read on each block, we'd trip the failures count though if we'd
been counting on a block basis, the read would have gone through.That said, I'd be fine
with Todds patch &#8211; its nice and clean, semantically and code-wise &#8211; going in
and in a new issue working on the Tsz suggested improvement. 


New Comment: 
<blockquote>on a 3 block file, if we hiccupped the first read on each
block,</blockquote>This would only be the case if you spanned all three blocks with a
single read() op. Not likely to happen unless you're calling read() once with a 200MB
buffer or something <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/smile.png" height="16"
width="16" align="absmiddle" alt="" border="0"/> 


New Comment: 
.bq This would only be the case if you spanned all three blocks with a single read() op.
Not likely to happen unless you're calling read() once with a 200MB buffer or something
Yeah, I was just thinking this while out on an errand.  My conjecture is way too
contrived.So, @Tsz, extra +1 on the Todd patch. 


New Comment: 
Same for me.  +1 on the patch. 


New Comment: 
Here's a branch-0.20 patch (nee hdfs-127-branch20-redone-v2.txt from <a
href="https://issues.apache.org/jira/browse/HDFS-127" title="DFSClient block read failures
cause open DFSInputStream to become unusable" class="issue-link"
data-issue-key="HDFS-127"><del>HDFS-127</del></a>) 


New Comment: 
Patch for branch-0.21. I haven't run this one through the full suite of tests yet. 


New Comment: 
I applied the TRUNK patch. 


New Comment: 
Integrated in Hadoop-Hdfs-trunk-Commit #183 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/183/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/183/</a>)<br/>
    DFSInputStream retries too many times for new block location 


New Comment: 
Ran tests on branch-0.21. Everything passed except two unrelated failures already tracked
by other jiras. 


New Comment: 
How we want to run the vote on this?  Will i start with 0.20 first? 


New Comment: 
Sure, 0.20 sounds good. 


New Comment: 
Tests passed on branch-0.20. 


New Comment: 
We ran a vote on applying patch to 0.20 and 0.21 branches and vote passed (Follow the
thread that starts here <a
href="http://www.mail-archive.com/hbase-dev@hadoop.apache.org/msg17043.html"
class="external-link"
rel="nofollow">http://www.mail-archive.com/hbase-dev@hadoop.apache.org/msg17043.html</a>).Patches
have been applied to 0.20 and 0.21 branches.Thanks for the patch Todd Lipcon. 


New Comment: 
Integrated in Hdfs-Patch-h2.grid.sp2.yahoo.net #146 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/146/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/146/</a>) 


New Comment: 
Integrated in Hadoop-Hdfs-trunk #275 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk/275/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk/275/</a>) 


