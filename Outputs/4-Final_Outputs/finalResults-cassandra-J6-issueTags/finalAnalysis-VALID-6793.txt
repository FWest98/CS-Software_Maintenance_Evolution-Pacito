Pattern changes caused by commit: 783e5d4c5fab46b1e5964f2743e053351bfe85d1

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1

From: Template Method-3
To:   Template Method-2


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-6793.txt 

commit 783e5d4c5fab46b1e5964f2743e053351bfe85d1
Author: Pavel Yaskevich <xedin@apache.org>

    fix SecondaryIndex LelevedManifest save upon snapshot
    patch by Pavel Yaskevich; reviewed by Jonathan Ellis for CASSANDRA-4230



==================================
 Issue CASSANDRA-4230 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4230] Deleting a CF always produces an error and that CF remains in an unknown state
-----------------

-----------------
Summary: Deleting a CF always produces an error and that CF remains in an unknown state
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 9 May 2012 10:28:59 +0000
-----------------

-----------------
Resolved at: Tue, 15 May 2012 17:10:30 +0000
-----------------

-----------------
Assigned to: Pavel Yaskevich
-----------------

-----------------
Description: 

From the CLI perspective:

<span class="error">&#91;default@Disco&#93;</span> drop column
family client; <br/>null<br/>org.apache.thrift.transport.TTransportException<br/>	at
org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)<br/>	at
org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)<br/>	at
org.apache.thrift.transport.TFramedTransport.readFrame(TFramedTransport.java:129)<br/>	at
org.apache.thrift.transport.TFramedTransport.read(TFramedTransport.java:101)<br/>	at
org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)<br/>	at
org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378)<br/>	at
org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297)<br/>	at
org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204)<br/>	at
org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69)<br/>	at
org.apache.cassandra.thrift.Cassandra$Client.recv_system_drop_column_family(Cassandra.java:1222)<br/>	at
org.apache.cassandra.thrift.Cassandra$Client.system_drop_column_family(Cassandra.java:1209)<br/>	at
org.apache.cassandra.cli.CliClient.executeDelColumnFamily(CliClient.java:1301)<br/>	at
org.apache.cassandra.cli.CliClient.executeCLIStatement(CliClient.java:234)<br/>	at
org.apache.cassandra.cli.CliMain.processStatementInteractive(CliMain.java:219)<br/>	at
org.apache.cassandra.cli.CliMain.main(CliMain.java:346)

Log:

 INFO <span
class="error">&#91;MigrationStage:1&#93;</span> 2012-05-09 11:25:35,686
ColumnFamilyStore.java (line 634) Enqueuing flush of
Memtable-schema_columnfamilies@225225949(978/1222 serialized/live bytes, 21 ops)<br/> INFO
<span class="error">&#91;FlushWriter:3&#93;</span> 2012-05-09 11:25:35,687 Memtable.java
(line 266) Writing Memtable-schema_columnfamilies@225225949(978/1222 serialized/live
bytes, 21 ops)<br/> INFO <span class="error">&#91;FlushWriter:3&#93;</span> 2012-05-09
11:25:35,748 Memtable.java (line 307) Completed flushing
/var/lib/cassandra/data/system/schema_columnfamilies/system-schema_columnfamilies-hc-34-Data.db
(1041 bytes)<br/> INFO <span class="error">&#91;MigrationStage:1&#93;</span> 2012-05-09
11:25:35,749 ColumnFamilyStore.java (line 634) Enqueuing flush of
Memtable-schema_columns@213209572(586/732 serialized/live bytes, 12 ops)<br/> INFO <span
class="error">&#91;FlushWriter:3&#93;</span> 2012-05-09 11:25:35,750 Memtable.java (line
266) Writing Memtable-schema_columns@213209572(586/732 serialized/live bytes, 12 ops)<br/>
INFO <span class="error">&#91;FlushWriter:3&#93;</span> 2012-05-09 11:25:35,812
Memtable.java (line 307) Completed flushing
/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-28-Data.db (649
bytes)<br/> INFO <span class="error">&#91;CompactionExecutor:20&#93;</span> 2012-05-09
11:25:35,814 CompactionTask.java (line 114) Compacting
[SSTableReader(path='/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-27-Data.db'),
SSTableReader<br/>(path='/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-25-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-26-Data.db'),
SSTableReader(path<br/>='/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-28-Data.db')]<br/>
INFO <span class="error">&#91;MigrationStage:1&#93;</span> 2012-05-09 11:25:35,918
ColumnFamilyStore.java (line 634) Enqueuing flush of Memtable-Client@864320066(372/465
serialized/live bytes, 6 ops)<br/> INFO <span class="error">&#91;FlushWriter:3&#93;</span>
2012-05-09 11:25:35,919 Memtable.java (line 266) Writing Memtable-Client@864320066(372/465
serialized/live bytes, 6 ops)<br/> INFO <span
class="error">&#91;CompactionExecutor:20&#93;</span> 2012-05-09 11:25:35,945
CompactionTask.java (line 225) Compacted to <span
class="error">&#91;/var/lib/cassandra/data/system/schema_columns/system-schema_columns-hc-29-Data.db,&#93;</span>.
 22,486 to 20,621 (~91% of orig<br/>inal) bytes for 2 keys at 0.150120MB/s.  Time:
131ms.<br/> INFO <span class="error">&#91;FlushWriter:3&#93;</span> 2012-05-09
11:25:36,013 Memtable.java (line 307) Completed flushing
/var/lib/cassandra/data/Disco/Client/Disco-Client-hc-5-Data.db (407 bytes)<br/>ERROR <span
class="error">&#91;MigrationStage:1&#93;</span> 2012-05-09 11:25:36,043 CLibrary.java
(line 158) Unable to create hard link<br/>com.sun.jna.LastErrorException: errno was
17<br/>        at org.apache.cassandra.utils.CLibrary.link(Native Method)<br/>        at
org.apache.cassandra.utils.CLibrary.createHardLink(CLibrary.java:150)<br/>        at
org.apache.cassandra.db.Directories.snapshotLeveledManifest(Directories.java:343)<br/>    
   at
org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:1450)<br/>
       at
org.apache.cassandra.db.ColumnFamilyStore.snapshot(ColumnFamilyStore.java:1483)<br/>      
 at org.apache.cassandra.db.DefsTable.dropColumnFamily(DefsTable.java:512)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:403)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:270)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:214)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)

ERROR <span
class="error">&#91;Thrift:3&#93;</span> 2012-05-09 11:25:36,048
CustomTThreadPoolServer.java (line 204) Error occurred during processing of
message.<br/>java.lang.RuntimeException: java.util.concurrent.ExecutionException:
java.io.IOError: java.io.IOException: Unable to create hard link from
/var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:372)<br/>        at
org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:191)<br/>    
   at
org.apache.cassandra.service.MigrationManager.announceColumnFamilyDrop(MigrationManager.java:182)<br/>
       at
org.apache.cassandra.thrift.CassandraServer.system_drop_column_family(CassandraServer.java:948)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_drop_column_family.getResult(Cassandra.java:3348)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_drop_column_family.getResult(Cassandra.java:3336)<br/>
       at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)<br/>       
at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)<br/>        at
org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)<br/>
       at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.util.concurrent.ExecutionException: java.io.IOError: java.io.IOException: Unable to
create hard link from /var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br/>
       at java.util.concurrent.FutureTask.get(FutureTask.java:83)<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:368)<br/>        ...
11 more<br/>Caused by: java.io.IOError: java.io.IOException: Unable to create hard link
from /var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at
org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:1454)<br/>
       at
org.apache.cassandra.db.ColumnFamilyStore.snapshot(ColumnFamilyStore.java:1483)<br/>      
 at org.apache.cassandra.db.DefsTable.dropColumnFamily(DefsTable.java:512)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:403)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:270)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:214)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        ... 3 more<br/>Caused
by: java.io.IOException: Unable to create hard link from
/var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at
org.apache.cassandra.utils.CLibrary.createHardLink(CLibrary.java:163)<br/>        at
org.apache.cassandra.db.Directories.snapshotLeveledManifest(Directories.java:343)<br/>    
   at
org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:1450)<br/>
       ... 10 more<br/>ERROR <span class="error">&#91;MigrationStage:1&#93;</span>
2012-05-09 11:25:36,051 AbstractCassandraDaemon.java (line 134) Exception in thread
Thread<span class="error">&#91;MigrationStage:1,5,main&#93;</span><br/>java.io.IOError:
java.io.IOException: Unable to create hard link from
/var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at
org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:1454)<br/>
       at
org.apache.cassandra.db.ColumnFamilyStore.snapshot(ColumnFamilyStore.java:1483)<br/>      
 at org.apache.cassandra.db.DefsTable.dropColumnFamily(DefsTable.java:512)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:403)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:270)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:214)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)

        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by: java.io.IOException: Unable to
create hard link from /var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)<br/>        at
org.apache.cassandra.utils.CLibrary.createHardLink(CLibrary.java:163)<br/>        at
org.apache.cassandra.db.Directories.snapshotLeveledManifest(Directories.java:343)<br/>    
   at
org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:1450)<br/>
       ... 10 more<br/> INFO <span class="error">&#91;CompactionExecutor:22&#93;</span>
2012-05-09 11:25:36,052 CompactionTask.java (line 114) Compacting <span
class="error">&#91;SSTableReader(path=&#39;/var/lib/cassandra/data/Disco/Client/Disco-Client-hc-5-Data.db&#39;),
SSTableReader(path=&#39;/var/lib/cassandra/data/Disco/Client/Disco-Client-hc-4-Data.db&#39;)&#93;</span><br/>
INFO <span class="error">&#91;CompactionExecutor:22&#93;</span> 2012-05-09 11:25:36,187
CompactionTask.java (line 225) Compacted to <span
class="error">&#91;/var/lib/cassandra/data/Disco/Client/Disco-Client-hc-6-Data.db,&#93;</span>.
 728 to 458 (~62% of original) bytes for 8 keys at 0.003235MB/s.  Time:
135ms.

Schema:

CREATE COLUMN FAMILY Client WITH<br/>       key_validation_class =
UUIDType AND<br/>       comparator = UTF8Type AND<br/>       column_metadata = [ 
{
column_name: key, validation_class: BytesType }                           { column_name:
name, validation_class: UTF8Type }                           { column_name: userid,
validation_class: UUIDType, index_type: KEYS }
                         ] AND<br/>      
compression_options = 
{ sstable_compression:SnappyCompressor, chunk_length_kb:64 }

AND<br/>       compaction_strategy = LeveledCompactionStrategy AND<br/>      
compaction_strategy_options = 
{ sstable_size_in_mb: 10 }
 AND<br/>       gc_grace =
432000;

State of data dir after deletion attempt:
<ol>	<li>ls -lah
/var/lib/cassandra/data/Disco/Client/<br/>total 76K<br/>drwxr-xr-x  3 cassandra cassandra
4.0K May  9 11:25 .<br/>drwxr-xr-x 17 cassandra cassandra 4.0K May  3 12:34
..<br/><del>rw-r</del><del>r</del>-  2 cassandra cassandra  420 May  9 11:25
Client-old.json<br/><del>rw-r</del><del>r</del>-  1 cassandra cassandra  418 May  7 18:04
Client.Client_userid_idx-old.json<br/><del>rw-r</del><del>r</del>-  1 cassandra cassandra 
418 May  7 18:04 Client.Client_userid_idx.json<br/><del>rw-r</del><del>r</del>-  1
cassandra cassandra  418 May  9 11:25 Client.json<br/><del>rw-r</del><del>r</del>-  1
cassandra cassandra   46 May  9 11:25
Disco-Client-hc-6-CompressionInfo.db<br/><del>rw-r</del><del>r</del>-  1 cassandra
cassandra  458 May  9 11:25 Disco-Client-hc-6-Data.db<br/><del>rw-r</del><del>r</del>-  1
cassandra cassandra  976 May  9 11:25
Disco-Client-hc-6-Filter.db<br/><del>rw-r</del><del>r</del>-  1 cassandra cassandra  208
May  9 11:25 Disco-Client-hc-6-Index.db<br/><del>rw-r</del><del>r</del>-  1 cassandra
cassandra 4.3K May  9 11:25
Disco-Client-hc-6-Statistics.db<br/><del>rw-r</del><del>r</del>-  4 cassandra cassandra  
46 May  7 18:04
Disco-Client.Client_userid_idx-hc-2-CompressionInfo.db<br/><del>rw-r</del><del>r</del>-  4
cassandra cassandra   92 May  7 18:04
Disco-Client.Client_userid_idx-hc-2-Data.db<br/><del>rw-r</del><del>r</del>-  4 cassandra
cassandra  496 May  7 18:04
Disco-Client.Client_userid_idx-hc-2-Filter.db<br/><del>rw-r</del><del>r</del>-  4
cassandra cassandra   26 May  7 18:04
Disco-Client.Client_userid_idx-hc-2-Index.db<br/><del>rw-r</del><del>r</del>-  4 cassandra
cassandra 4.3K May  7 18:04
Disco-Client.Client_userid_idx-hc-2-Statistics.db<br/>drwxr-xr-x  6 cassandra cassandra
4.0K May  9 11:25 snapshots</li></ol> 

-----------------

-----------------
Comments: 

New Comment: 
probably related to <a href="https://issues.apache.org/jira/browse/CASSANDRA-4219"
title="Problem with creating keyspace after drop" class="issue-link"
data-issue-key="CASSANDRA-4219"><del>CASSANDRA-4219</del></a> 


New Comment: 
From the exception message I see that it's related to the JNA hardlinks while it does a
snapshot:<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>ERROR [MigrationStage:1] 2012-05-09
11:25:36,043 CLibrary.java (line 158) Unable to create hard
linkcom.sun.jna.LastErrorException: errno was 17...Caused by:
java.util.concurrent.ExecutionException: java.io.IOError: java.io.IOException: Unable to
create hard link from /var/lib/cassandra/data/Disco/Client/Client.json to
/var/lib/cassandra/data/Disco/Client/snapshots/1336559135918-Client/Client.json (errno
17)</pre></div></div>and errno of 17 means "File exists" so this is something with
snapshot or the system rather then migrations. 


New Comment: 
Since snapshot dirs include a timestamp, perhaps we should just move along if it already
exists. 


New Comment: 
Yeah, we probably should do just that. 


New Comment: 
But why would it attempt the same snapshot twice?  Sounds like there's a real bug here. 


New Comment: 
snapshot on compaction is one way it can happen. 


New Comment: 
Yeah, it's only called in snapshotWithoutFlush so if you try to drop CF in the middle of
compaction snapshoting files it would be the only way to lead to such behavior. I think
what we need to do here is to stop compaction and run drop after that... 


New Comment: 
<blockquote>snapshot on compaction is one way it can happen.</blockquote>I suppose there's
a really small chance of that happening if you happen to time it just right, but that
wouldn't explain it being easily reproducible (since the compaction and drop snapshots
generate their snapshot name independently).Also, snapshot-on-compaction is off by
default, I doubt André has it enabled.  André, can you confirm? 


New Comment: 
I suppose you mean this:<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>$ cat /etc/cassandra/cassandra.yaml |grep
snapshot |grep compac# Whether or not to take a snapshot before each compaction. 
Besnapshot_before_compaction: false</pre></div></div>I did not enable it. 


New Comment: 
I have figured out that this problem is caused only when LeveledCompaction is used for
Secondary Index, it seems like when index's leveled manifest is snapshoted it uses the
wrong name. 


New Comment: 
Do we need this in 1.0 too? 


New Comment: 
No, this bug came together with directory-per-CF which was added into 1.1. 


New Comment: 
simpler v2 attached 


New Comment: 
Heh, I overlooked that possibility, +1. 


New Comment: 
Andre, can you please test and confirm that everything works as expected before we commit
it? 


New Comment: 
It works, thanks! 


New Comment: 
committed 


New Comment: 
Note: Issue reproduced on cassandra 2.0.12 (datastax for windows)<br/>Log: refer to
cassandraDEBUG.log attached file. 


