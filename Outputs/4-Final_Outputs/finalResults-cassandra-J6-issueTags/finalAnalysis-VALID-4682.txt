Pattern changes caused by commit: 34e2ae59a9f8040d8c33a274fd0dd35822beee5c

From: Decorator-0
To:   Decorator-1

From: Mediator-2
To:   Mediator-3


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4682.txt 

commit 34e2ae59a9f8040d8c33a274fd0dd35822beee5c
Author: Jonathan Ellis <jbellis@apache.org>

    Add "install" command to cassandra.bat
    patch by Ben Coverston; reviewed by jbellis for CASSANDRA-292



==================================
 Issue CASSANDRA-292 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-292] Cassandra should be runnable as a Windows service
-----------------

-----------------
Summary: Cassandra should be runnable as a Windows service
-----------------

-----------------
Issue type: New Feature
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 14 Jul 2009 00:56:15 +0000
-----------------

-----------------
Resolved at: Mon, 22 Aug 2011 20:57:44 +0000
-----------------

-----------------
Assigned to: Benjamin Coverston
-----------------

-----------------
Description: 

In addition to the tarballs already distributed, Cassandra should distribute an exe
installer that can install the Cassandra daemon as a Windows service.

Tomcat's NSIS
scripts can be used as a reference for the installer: <a
href="http://svn.apache.org/repos/asf/tomcat/trunk/res/" class="external-link"
rel="nofollow">http://svn.apache.org/repos/asf/tomcat/trunk/res/</a><br/>Apache Commons
Daemon's procrun would probably be used to create the Win32 service: <a
href="http://commons.apache.org/daemon/procrun.html" class="external-link"
rel="nofollow">http://commons.apache.org/daemon/procrun.html</a>
 

-----------------

-----------------
Comments: 

New Comment: 
a simple wix installer could probably install the files and configure the service <a
href="http://wix.sourceforge.net/" class="external-link"
rel="nofollow">http://wix.sourceforge.net/</a>I guess that assumes that cassandra is
stable on windows. 


New Comment: 
I would ask that whoever picks this up be willing to maintain it in the long term. There
simply isn't that many people who are genuinely interested in Cassandra on Windows; if
it's a one-time contribution it is likely to languish and leave people with a bad
impression when they do try to use it.See the existing batch files, (or the Maven pom file
for that matter), as an example of this. 


New Comment: 
The attached windows.zip file contains a contrib that allows you to run Cassandra as a
WIndows Service.  It should be unzipped under the contrib directory.  It includes an Ant
build script and unit test.  I've included in the bin directory everything needed to use
it and building it isn't technically necessary.Items to note:<ul>	<li>Uses Apache
Procrun</li>	<li>Simple service.bat file to install/remove service (&gt;service
install)</li>	<li>Delegates to CassandraDaemon class</li>	<li>Binaries included for 32 bit
and 64 bit</li>	<li>Configuration  utility included (cassandraw.exe)</li>	<li>Tested
against Cassandra 0.6.1 and 0.6.3</li>	<li>Tested on Windows XP (32bit), Windows 7 (64bit)
and Windows Server 2008 R1/R2 (64bit)</li></ul>Please review the README.txt file. 


New Comment: 
service.bat issues:<br/>1. missed %CASSANDRA_HOME%\conf in CLASSPATH, without which
Cassandra won't start.<br/>2. line 95 just a misspellingActually no need to set global
CASSANDRA_HOME environment variable, Cassandra is running fine without it, especially on
development machines, where we run it from different places. 


New Comment: 
Thank you for testing the contrib!  In response to your comments on 10, July:<ul>	<li>I've
fixed the typo on line 95.</li></ul><ul>	<li>In regards to "CASSANDRA_HOME" not being
necessary, you are technically correct but "ONLY" you plan to run Cassandra as a service
directly from source tree (contrib\windows\bin).  If CASSANDRA_HOME is not set, the
service.bat script will create it and set it to the root of the Cassandra source tree
(note: I found a bug where I was setting CASSANDRA_HOME to the "contrib" directory in the
script if it wasn't defined and this is probably why you had a problem.)  However, the
script is designed such that you can use it to install and run a Cassandra instance from
any location "and" for the windows/bin directory to be anywhere on your system.  Without
it, that flexibility is missing and the only way to run Cassandra as a service would be
from a source distribution.  Further, the cassandra.bat file uses CASSANDRA_HOME in a
similar way.  If you are using that to start Cassandra, you are technically using
CASSANDRA_HOME just only internal to the bat file.</li></ul><ul>	<li>In regards to
requiring %CASSANDRA_HOME%\conf in the CLASSPATH, this is not true as long CASSANDRA_HOME
is set properly.  What Cassandra uses and expects is a storage-conf system variable
(-Dstorage-conf).  As far as I know this is the proper way to tell Cassandra where the
configuration file is.  Cassandra also uses storage-conf to find log4j's configuration
file.  So, the service.bat (and cassandra.bat) does the following:	<ul>		<li>Sets a
CASSANDRA_CONF variable: CASSANDRA_CONF=%CASSANDRA_HOME%\conf</li>		<li>Sets storage-conf:
-Dstorage-config="%CASSANDRA_CONF%"</li>	</ul>	</li></ul>My best guess is that since I was
not setting the CASSANDRA_HOME properly in the situation where is was not already defined,
this would cause the service installation to have storage-conf set improperly.  I've fixed
this.I've attached a new zip file called windows_u1.zip file (update 1) that fixes the
typo and sets CASSANDRA_HOME properly to the root of the src distribution "if" it is not
already defined.  I've also changed the script to use %~dp0 instead of %CD%.  I've tested
the installation without CASSANDRA_HOME from the contrib area and it seems to work and
updated the README.txt.  The only files that are different are the service.bat and
README.txt. 


New Comment: 
Fixed some small bugs and typos in service.bat.  Updated README.txt. 


New Comment: 
Bumping this to 0.7.1 because that is probably the time frame that Gary will have time to
review. 


New Comment: 
When Cassandra fails to start due to <a
href="https://issues.apache.org/jira/browse/CASSANDRA-1348" title="Failed to delete
commitlog when restarting service" class="issue-link"
data-issue-key="CASSANDRA-1348"><del>CASSANDRA-1348</del></a>, Windows service is still
running and can't detect that Cassandra failed to start and can't be restarted
automatically with Windows service Recovery options. 


New Comment: 
The last time I dealt with making java a service on windows, the Java Service Wrapper was
the best service wrapper available.  Procrun (<a
href="http://commons.apache.org/daemon/procrun.html" class="external-link"
rel="nofollow">http://commons.apache.org/daemon/procrun.html</a>) is probably worth
looking at too.Since these are windows users, we probably want to provide an installer
that manages all these things as well.  Jeremy is right, wix is probably the best tool for
that. 


New Comment: 
<a href="http://coderjournal.com/2010/06/run-cassandra-as-a-windows-service/"
class="external-link"
rel="nofollow">http://coderjournal.com/2010/06/run-cassandra-as-a-windows-service/</a> has
what looks (to this non-windows expert) like a good explanation of how to set this up
manually. 


New Comment: 
Added an option to the cassandra.bat. If you run 'cassandra.bat install' on the command
line it will install cassandra as a service using the Apache Daemon. 


New Comment: 
Added a shutdown hook s.t. the service will stop when connections are active. 


New Comment: 
Is there a reason to keep the commented-out lines in cassandra.bat? 


New Comment: 
Only the explanatory comments, I'll get rid of the extra ones. 


New Comment: 
cleaned up comments in the .bat file 


New Comment: 
committed (w/ update to README and NEWS) 


