Pattern changes caused by commit: 8deaa64751c6db3bdb8b3ef5920ab6cca9cbd50a

From: Decorator-1
To:   Decorator-0

From: Mediator-3
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4684.txt 

commit 8deaa64751c6db3bdb8b3ef5920ab6cca9cbd50a
Author: Jonathan Ellis <jbellis@apache.org>

    avoid retaining references to dropped CFS objects in CompactionManager.estimatedCompactions
    patch by Dan LaRocque; reviewed by jbellis for CASSANDRA-2708



==================================
 Issue CASSANDRA-2708 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2708] memory leak in CompactionManager's estimatedCompactions
-----------------

-----------------
Summary: memory leak in CompactionManager's estimatedCompactions
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 25 May 2011 20:51:53 +0000
-----------------

-----------------
Resolved at: Mon, 22 Aug 2011 21:49:21 +0000
-----------------

-----------------
Assigned to: Dan LaRocque
-----------------

-----------------
Description: 

CompactionManager's estimatedCompactions map seems to hold all or most ColumnFamilyStores
in the system as keys.  Keys are never removed from estimatedCompactions.

I have a
project that embeds Cassandra as a storage backend.  Some of my integration tests create
and drop a single keyspace and pair of column families a hundred or 150 times in one JVM. 
These tests always OOM'd.  Loading some near-death heapdumps in mat suggested
CompactionManager's estimatedCompactions held over 80% of total heap via its
ColumnFamilyStore keys.  estimatedCompactions had the only inbound reference to these
CFSs, and the CFSs themselves had invalid = true.

As a workaround, I changed
estimatedCompactions to a WeakReference-keyed map (using Guava MapMaker).  My integration
tests no longer OOM.

I'm generally unfamiliar with Cassandra's guts.  I don't know
whether weak referencing the keys of estimatedCompactions is correct (or ideal).  But,
that did seem to confirm my guess that retained references to dead CFSs in
estimatedCompactions were swamping my heap after lots of Keyspace+ColumnFamily drops.
 

-----------------

-----------------
Comments: 

New Comment: 
Attaching 3-line patch against cassandra-0.7 r1127675 


New Comment: 
Sorry Dan, I missed this when you first submitted it.  Committed for 0.7.9.  Thanks for
the help! 


