Pattern changes caused by commit: 577cb2c7600c6e26f5a2a252cb157769e861ece9

From: Abstract Factory-1
To:   Abstract Factory-2

From: Factory Method-1
To:   Factory Method-2

From: Decorator-2
To:   Decorator-1

From: Facade-0
To:   Facade-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-8637.txt 

commit 577cb2c7600c6e26f5a2a252cb157769e861ece9
Author: Brandon Williams <brandonwilliams@apache.org>

    Always collect hint tombstones.
    Patch by brandonwilliams, reviewed by slebresne for CASSANDRA-5068



==================================
 Issue CASSANDRA-5068 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-5068] CLONE - Once a host has been hinted to, log messages for it repeat every 10 mins even if no hints are delivered
-----------------

-----------------
Summary: CLONE - Once a host has been hinted to, log messages for it repeat every 10 mins even if no hints are delivered
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Thu, 13 Dec 2012 23:50:04 +0000
-----------------

-----------------
Resolved at: Mon, 11 Feb 2013 19:06:24 +0000
-----------------

-----------------
Assigned to: Brandon Williams
-----------------

-----------------
Description: 

We have "0 row" hinted handoffs every 10 minutes like clockwork. This impacts our ability
to monitor the cluster by adding persistent noise in the handoff metric.

Previous
mentions of this issue are here:<br/><a
href="http://www.mail-archive.com/user@cassandra.apache.org/msg25982.html"
class="external-link"
rel="nofollow">http://www.mail-archive.com/user@cassandra.apache.org/msg25982.html</a>

The
hinted handoffs can be scrubbed away with<br/>nodetool -h 127.0.0.1 scrub system
HintsColumnFamily<br/>but they return after anywhere from a few minutes to multiple hours
later.

These started to appear after an upgrade to 1.1.6 and haven't gone away despite
rolling cleanups, rolling restarts, multiple rounds of scrubbing, etc.

A few things we've
noticed about the handoffs:<br/>1. The phantom handoff endpoint changes after a non-zero
handoff comes through

2. Sometimes a non-zero handoff will be immediately followed by an
"off schedule" phantom handoff to the endpoint the phantom had been using before

3. The
sstable2json output seems to include multiple sub-sections for each handoff with the same
"deletedAt" information.

The phantom handoff endpoint changes after a non-zero handoff
comes through:<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-11
06:57:35,093 HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to
endpoint /10.10.10.1<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span>
2012-12-11 07:07:35,092 HintedHandOffManager.java (line 392) Finished hinted handoff of 0
rows to endpoint /10.10.10.1<br/> INFO <span
class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-11 07:07:37,915
HintedHandOffManager.java (line 392) Finished hinted handoff of 1058 rows to endpoint
/10.10.10.2<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-11
07:17:35,093 HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to
endpoint /10.10.10.2<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span>
2012-12-11 07:27:35,093 HintedHandOffManager.java (line 392) Finished hinted handoff of 0
rows to endpoint /10.10.10.2

Sometimes a non-zero handoff will be immediately followed by
an "off schedule" phantom handoff to the endpoint the phantom had been using before:<br/>
INFO <span class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-12 21:47:39,335
HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to endpoint
/10.10.10.3<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-12
21:57:39,335 HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to
endpoint /10.10.10.3<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span>
2012-12-12 22:07:43,319 HintedHandOffManager.java (line 392) Finished hinted handoff of
1416 rows to endpoint /10.10.10.4<br/> INFO <span
class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-12 22:07:43,320
HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to endpoint
/10.10.10.3<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span> 2012-12-12
22:17:39,357 HintedHandOffManager.java (line 392) Finished hinted handoff of 0 rows to
endpoint /10.10.10.4<br/> INFO <span class="error">&#91;HintedHandoff:1&#93;</span>
2012-12-12 22:27:39,337 HintedHandOffManager.java (line 392) Finished hinted handoff of 0
rows to endpoint /10.10.10.4

The first few entries from one of the json files:<br/>{<br/>
   "0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa": {<br/>        "ccf5dc203a2211e20000e154da71a9bb":

{            "deletedAt": -9223372036854775808,             "subColumns": []        }
,
<br/>        "ccf603303a2211e20000e154da71a9bb": 
{            "deletedAt":
-9223372036854775808,             "subColumns": []        }
, 
 

-----------------

-----------------
Comments: 

New Comment: 
Cloning <a href="https://issues.apache.org/jira/browse/CASSANDRA-3733" title="Once a host
has been hinted to, log messages for it repeat every 10 mins even if no hints are
delivered" class="issue-link"
data-issue-key="CASSANDRA-3733"><del>CASSANDRA-3733</del></a> as it seems to be the same
issue. 


New Comment: 
When there are zero-row hinted handoffs the output of "list HintsColumnFamily"<br/>might
show that 9 of 12 nodes in a ring have a row key like this:<br/>9 of 12 nodes in a ring
might have a row key like this:<br/>RowKey: 755555555555555555555555555555541 of the 12
nodes will have a different row key than all the rest:<br/>RowKey:
15555555555555555555555555555554another 1-2 nodes might not have any RowKeys at all 


New Comment: 
Somehow you've got an empty hints row there that hasn't gotten compacted away.  Not sure
how that's possible since we only ever do one handoff at a time per target, and each
handoff does a full compaction after it's delivered hints successfully. 


New Comment: 
reproduced this in 1.2.0 after a rolling restart of the cluster 


New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman"
class="user-hover" rel="mkjellman">Michael Kjellman</a> can you post logs? 


New Comment: 
I'm not sure how we're getting into this situation with an empty hint row (machine
restarted before compaction finished?) but one thing we can do to mitigate it is remove
the check that we replayed &gt; 0 rows before compacting.  It shouldn't really be
necessary since the isEmpty check on hintStore should prevent it, unless something like
this has happened. 


New Comment: 
a bit messy due to the repair log lines<div class="code panel" style="border-width:
1px;"><div class="codeContent panelContent"><pre
class="code-java">tem-local-ib-671-Data.db<span class="code-quote">'),
SSTableReader(path='</span>/data2/cassandra/system/local/system-local-ib-672-Data.db<span
class="code-quote">'),
SSTableReader(path='</span>/data2/cassandra/system/local/system-local-ib-670-Data.db')]
INFO [CompactionExecutor:45] 2013-01-10 21:57:11,166 CompactionTask.java (line 267)
Compacted 4 sstables to [/data/cassandra/system/local/system-local-ib-673,].  975 bytes to
590 (~60% of original) in 214ms = 0.002629MB/s.  4 total rows, 1 unique.  Row merge counts
were {1:0, 2:0, 3:0, 4:1, } INFO [GossipStage:1] 2013-01-10 21:57:16,342 Gossiper.java
(line 772) InetAddress /10.8.30.102 is now dead. INFO [GossipStage:1] 2013-01-10
21:59:01,958 Gossiper.java (line 790) Node /10.8.30.102 has restarted, now UP INFO
[GossipStage:1] 2013-01-10 21:59:01,959 Gossiper.java (line 758) InetAddress /10.8.30.102
is now UP INFO [HintedHandoff:2] 2013-01-10 21:59:01,960 HintedHandOffManager.java (line
293) Started hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:2]
2013-01-10 21:59:02,000 ColumnFamilyStore.java (line 647) Enqueuing flush of
Memtable-hints@479784922(38/69 serialized/live bytes, 46 ops) INFO [FlushWriter:9]
2013-01-10 21:59:02,001 Memtable.java (line 424) Writing Memtable-hints@479784922(38/69
serialized/live bytes, 46 ops) INFO [FlushWriter:9] 2013-01-10 21:59:02,195 Memtable.java
(line 458) Completed flushing /data2/cassandra/system/hints/system-hints-ib-187-Data.db
(85 bytes) <span class="code-keyword">for</span> commitlog position
ReplayPosition(segmentId=1357883369951, position=806355) INFO [CompactionExecutor:60]
2013-01-10 21:59:02,200 CompactionTask.java (line 120) Compacting
[SSTableReader(path=<span
class="code-quote">'/data2/cassandra/system/hints/system-hints-ib-187-Data.db'</span>),
SSTableReader(path='/data2/cassandra/system/hints/system-hints-ib-186-Data.db')] INFO
[CompactionExecutor:60] 2013-01-10 21:59:02,431 CompactionTask.java (line 267) Compacted 2
sstables to [/data2/cassandra/system/hints/system-hints-ib-188,].  32,814 bytes to 32,729
(~99% of original) in 230ms = 0.135708MB/s.  8 total rows, 7 unique.  Row merge counts
were {1:8, 2:0, } INFO [HintedHandoff:2] 2013-01-10 21:59:02,432 HintedHandOffManager.java
(line 408) Finished hinted handoff of 47 rows to endpoint /10.8.30.102 INFO
[GossipStage:1] 2013-01-10 21:59:11,999 StorageService.java (line 1288) Node /10.8.30.102
state jump to normal INFO [GossipStage:1] 2013-01-10 21:59:12,003 ColumnFamilyStore.java
(line 647) Enqueuing flush of Memtable-peers@1233529943(306/5247 serialized/live bytes, 21
ops) INFO [FlushWriter:10] 2013-01-10 21:59:12,004 Memtable.java (line 424) Writing
Memtable-peers@1233529943(306/5247 serialized/live bytes, 21 ops) INFO [FlushWriter:10]
2013-01-10 21:59:12,265 Memtable.java (line 458) Completed flushing
/data2/cassandra/system/peers/system-peers-ib-589-Data.db (351 bytes) <span
class="code-keyword">for</span> commitlog position ReplayPosition(segmentId=1357883369951,
position=806482) INFO [GossipStage:1] 2013-01-10 21:59:12,272 ColumnFamilyStore.java (line
647) Enqueuing flush of Memtable-local@1657301357(69/69 serialized/live bytes, 2 ops) INFO
[FlushWriter:9] 2013-01-10 21:59:12,273 Memtable.java (line 424) Writing
Memtable-local@1657301357(69/69 serialized/live bytes, 2 ops) INFO [FlushWriter:9]
2013-01-10 21:59:12,455 Memtable.java (line 458) Completed flushing
/data2/cassandra/system/local/system-local-ib-674-Data.db (129 bytes) <span
class="code-keyword">for</span> commitlog position ReplayPosition(segmentId=1357883369951,
position=806675) WARN [MemoryMeter:1] 2013-01-10 21:59:30,213 Memtable.java (line 191)
setting live ratio to minimum of 1.0 instead of 0.09066707435830113 INFO [MemoryMeter:1]
2013-01-10 21:59:30,214 Memtable.java (line 207) CFS(Keyspace=<span
class="code-quote">'evidence'</span>, ColumnFamily=<span
class="code-quote">'messages'</span>) liveRatio is 1.0 (just-counted was 1.0). 
calculation took 7ms <span class="code-keyword">for</span> 55 columns INFO
[HintedHandoff:1] 2013-01-10 22:00:20,287 HintedHandOffManager.java (line 293) Started
hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:1]
2013-01-10 22:00:20,288 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 INFO [<span class="code-object">Thread</span>-50] 2013-01-10
22:02:39,618 StorageService.java (line 2304) Starting repair command #1, repairing 1
ranges <span class="code-keyword">for</span> keyspace evidence INFO
[AntiEntropySessions:1] 2013-01-10 22:02:39,637 AntiEntropyService.java (line 652) [repair
#815023d0-5bb4-11e2-906d-dd50a26832ff] <span class="code-keyword">new</span> session: will
sync /10.8.25.101, /10.8.30.14 on range
(28356863910078205288614550619314017620,42535295865117307932921825928971026436] <span
class="code-keyword">for</span> evidence.[fingerprints, messages] INFO
[AntiEntropySessions:1] 2013-01-10 22:02:39,646 AntiEntropyService.java (line 857) [repair
#815023d0-5bb4-11e2-906d-dd50a26832ff] requesting merkle trees <span
class="code-keyword">for</span> fingerprints (to [/10.8.30.14, /10.8.25.101]) INFO
[ValidationExecutor:1] 2013-01-10 22:02:39,665 ColumnFamilyStore.java (line 647) Enqueuing
flush of Memtable-fingerprints@1756165009(409626/409626 serialized/live bytes, 53 ops)
INFO [FlushWriter:11] 2013-01-10 22:02:39,666 Memtable.java (line 424) Writing
Memtable-fingerprints@1756165009(409626/409626 serialized/live bytes, 53 ops) INFO
[FlushWriter:11] 2013-01-10 22:02:39,871 Memtable.java (line 458) Completed flushing
/data2/cassandra/evidence/fingerprints/evidence-fingerprints-ib-195-Data.db (349405 bytes)
<span class="code-keyword">for</span> commitlog position
ReplayPosition(segmentId=1357883369951, position=3000340) WARN [MemoryMeter:1] 2013-01-10
22:02:39,917 Memtable.java (line 191) setting live ratio to minimum of 1.0 instead of
0.03491183672633014 INFO [MemoryMeter:1] 2013-01-10 22:02:39,917 Memtable.java (line 207)
CFS(Keyspace=<span class="code-quote">'evidence'</span>, ColumnFamily=<span
class="code-quote">'messages'</span>) liveRatio is 1.0 (just-counted was 1.0). 
calculation took 19ms <span class="code-keyword">for</span> 106 columns INFO
[AntiEntropyStage:1] 2013-01-10 22:05:31,251 AntiEntropyService.java (line 214) [repair
#815023d0-5bb4-11e2-906d-dd50a26832ff] Received merkle tree <span
class="code-keyword">for</span> fingerprints from /10.8.25.101 WARN [MemoryMeter:1]
2013-01-10 22:05:53,141 Memtable.java (line 191) setting live ratio to minimum of 1.0
instead of 0.0038005359709140643 INFO [MemoryMeter:1] 2013-01-10 22:05:53,142
Memtable.java (line 207) CFS(Keyspace=<span class="code-quote">'evidence'</span>,
ColumnFamily=<span class="code-quote">'fingerprints'</span>) liveRatio is 1.0
(just-counted was 1.0).  calculation took 6ms <span class="code-keyword">for</span> 10
columns INFO [MemoryMeter:1] 2013-01-10 22:08:53,699 Memtable.java (line 207)
CFS(Keyspace=<span class="code-quote">'brts'</span>, ColumnFamily=<span
class="code-quote">'evidence_index'</span>) liveRatio is 3.018170276918194 (just-counted
was 3.018170276918194).  calculation took 24ms <span class="code-keyword">for</span> 235
columns INFO [HintedHandoff:2] 2013-01-10 22:10:20,290 HintedHandOffManager.java (line
293) Started hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:2]
2013-01-10 22:10:20,291 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 WARN [MemoryMeter:1] 2013-01-10 22:12:57,094 Memtable.java
(line 191) setting live ratio to minimum of 1.0 instead of 0.033105659834837216 INFO
[MemoryMeter:1] 2013-01-10 22:12:57,095 Memtable.java (line 207) CFS(Keyspace=<span
class="code-quote">'evidence'</span>, ColumnFamily=<span
class="code-quote">'messages'</span>) liveRatio is 1.0 (just-counted was 1.0). 
calculation took 18ms <span class="code-keyword">for</span> 213 columns INFO
[HintedHandoff:1] 2013-01-10 22:20:20,293 HintedHandOffManager.java (line 293) Started
hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:1]
2013-01-10 22:20:20,294 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 INFO [HintedHandoff:2] 2013-01-10 22:30:20,296
HintedHandOffManager.java (line 293) Started hinted handoff <span
class="code-keyword">for</span> host: a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP:
/10.8.30.102 INFO [HintedHandoff:2] 2013-01-10 22:30:20,297 HintedHandOffManager.java
(line 408) Finished hinted handoff of 0 rows to endpoint /10.8.30.102 INFO
[HintedHandoff:1] 2013-01-10 22:40:20,299 HintedHandOffManager.java (line 293) Started
hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:1]
2013-01-10 22:40:20,300 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 WARN [MemoryMeter:1] 2013-01-10 22:44:25,510 Memtable.java
(line 191) setting live ratio to minimum of 1.0 instead of 0.03129749755193589 INFO
[MemoryMeter:1] 2013-01-10 22:44:25,510 Memtable.java (line 207) CFS(Keyspace=<span
class="code-quote">'evidence'</span>, ColumnFamily=<span
class="code-quote">'messages'</span>) liveRatio is 1.0 (just-counted was 1.0). 
calculation took 20ms <span class="code-keyword">for</span> 387 columns WARN
[MemoryMeter:1] 2013-01-10 22:47:55,174 Memtable.java (line 191) setting live ratio to
minimum of 1.0 instead of 0.013355315914417125 INFO [MemoryMeter:1] 2013-01-10
22:47:55,175 Memtable.java (line 207) CFS(Keyspace=<span
class="code-quote">'evidence'</span>, ColumnFamily=<span
class="code-quote">'fingerprints'</span>) liveRatio is 1.0 (just-counted was 1.0). 
calculation took 11ms <span class="code-keyword">for</span> 63 columns INFO
[HintedHandoff:2] 2013-01-10 22:50:20,302 HintedHandOffManager.java (line 293) Started
hinted handoff <span class="code-keyword">for</span> host:
a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP: /10.8.30.102 INFO [HintedHandoff:2]
2013-01-10 22:50:20,307 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 INFO [HintedHandoff:1] 2013-01-10 23:00:20,304
HintedHandOffManager.java (line 293) Started hinted handoff <span
class="code-keyword">for</span> host: a1429d88-a084-46b2-a92d-81bb43b7ccc4 with IP:
/10.8.30.102 INFO [HintedHandoff:1] 2013-01-10 23:00:20,305 HintedHandOffManager.java
(line 408) Finished hinted handoff of 0 rows to endpoint
/10.8.30.102</pre></div></div>digest version<div class="code panel" style="border-width:
1px;"><div class="codeContent panelContent"><pre class="code-java">INFO [HintedHandoff:1]
2013-01-10 22:00:20,288 HintedHandOffManager.java (line 408) Finished hinted handoff of 0
rows to endpoint /10.8.30.102 INFO [HintedHandoff:2] 2013-01-10 22:10:20,291
HintedHandOffManager.java (line 408) Finished hinted handoff of 0 rows to endpoint
/10.8.30.102 INFO [HintedHandoff:1] 2013-01-10 22:20:20,294 HintedHandOffManager.java
(line 408) Finished hinted handoff of 0 rows to endpoint /10.8.30.102 INFO
[HintedHandoff:2] 2013-01-10 22:30:20,297 HintedHandOffManager.java (line 408) Finished
hinted handoff of 0 rows to endpoint /10.8.30.102 INFO [HintedHandoff:1] 2013-01-10
22:40:20,300 HintedHandOffManager.java (line 408) Finished hinted handoff of 0 rows to
endpoint /10.8.30.102 INFO [HintedHandoff:2] 2013-01-10 22:50:20,307
HintedHandOffManager.java (line 408) Finished hinted handoff of 0 rows to endpoint
/10.8.30.102 INFO [HintedHandoff:1] 2013-01-10 23:00:20,305 HintedHandOffManager.java
(line 408) Finished hinted handoff of 0 rows to endpoint /10.8.30.102 INFO
[HintedHandoff:2] 2013-01-10 23:10:20,308 HintedHandOffManager.java (line 408) Finished
hinted handoff of 0 rows to endpoint /10.8.30.102 INFO [HintedHandoff:1] 2013-01-10
23:20:20,311 HintedHandOffManager.java (line 408) Finished hinted handoff of 0 rows to
endpoint /10.8.30.102 INFO [HintedHandoff:2] 2013-01-10 23:30:20,314
HintedHandOffManager.java (line 408) Finished hinted handoff of 0 rows to endpoint
/10.8.30.102 INFO [HintedHandoff:1] 2013-01-10 23:40:20,317 HintedHandOffManager.java
(line 408) Finished hinted handoff of 0 rows to endpoint /10.8.30.102</pre></div></div> 


New Comment: 
Hmm, so it did correctly compact just before logging:<div class="preformatted panel"
style="border-width: 1px;"><div class="preformattedContent panelContent"><pre> INFO
[HintedHandoff:2] 2013-01-10 21:59:02,432 HintedHandOffManager.java (line 408) Finished
hinted handoff of 47 rows to endpoint /10.8.30.102</pre></div></div>I'm not sure why
anything would be left after that. 


New Comment: 
I'm also seeing this, running 1.1.8 <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/smile.png" height="16"
width="16" align="absmiddle" alt="" border="0"/> 


New Comment: 
I ran into this in 1.2, and the problem is definitely old sstables full of tombstones
being left behind:<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre> activity                                   
                                                    | timestamp    | source        |
source_elapsed-------------------------------------------------------------------------------------------------+--------------+---------------+----------------
                                                                            
execute_cql3_query | 21:10:25,847 | 10.179.64.227 |              0                        
                                                      Parsing statement | 21:10:25,847 |
10.179.64.227 |             39                                                            
                 Peparing statement | 21:10:25,847 | 10.179.64.227 |            208       
                                                           Determining replicas to query |
21:10:25,847 | 10.179.64.227 |            316 Executing seq scan across 2 sstables for
[min(-9223372036854775808), min(-9223372036854775808)] | 21:10:25,870 | 10.179.64.227 |   
      23223                                                          Read 0 live cells and
13800 tombstoned | 21:10:25,928 | 10.179.64.227 |          81432                          
                               Read 0 live cells and 13068 tombstoned | 21:10:26,015 |
10.179.64.227 |         168213                                                            
       Scanned 2 rows and matched 2 | 21:10:26,016 | 10.179.64.227 |         169206       
                                                                        Request complete |
21:10:26,016 | 10.179.64.227 |         169585</pre></div></div>The problem appears to
occur here:<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre> INFO [GossipStage:1] 2013-02-04
22:54:34,828 Gossiper.java (line 754) InetAddress /10.179.111.137 is now UP INFO
[GossipStage:1] 2013-02-04 22:54:34,830 Gossiper.java (line 754) InetAddress
/10.179.65.102 is now UP INFO [HintedHandoff:1] 2013-02-04 22:54:34,830
HintedHandOffManager.java (line 297) Started hinted handoff for host:
5b49c861-0cf6-48dc-872a-7fcb89429dae with IP: /10.179.111.137 INFO [HintedHandoff:2]
2013-02-04 22:54:34,830 HintedHandOffManager.java (line 297) Started hinted handoff for
host: 0fd1d3b1-0f73-40fd-ab36-9f4b9636a205 with IP: /10.179.65.102 INFO [HintedHandoff:2]
2013-02-04 22:54:41,039 ColumnFamilyStore.java (line 678) Enqueuing flush of
Memtable-hints@164677298(1020984/1020984 serialized/live bytes, 39151 ops) INFO
[FlushWriter:2] 2013-02-04 22:54:41,041 Memtable.java (line 453) Writing
Memtable-hints@164677298(1020984/1020984 serialized/live bytes, 39151 ops) INFO
[CompactionExecutor:8] 2013-02-04 22:54:41,043 CompactionTask.java (line 112) Compacting
[SSTableReader(path='/var/lib/cassandra/data/system/hints/system-hints-ib-1-Data.db')]
INFO [FlushWriter:2] 2013-02-04 22:54:41,200 Memtable.java (line 487) Completed flushing
/var/lib/cassandra/data/system/hints/system-hints-ib-2-Data.db (166760 bytes) for
commitlog position ReplayPosition(segmentId=1360018215672, position=11404848) INFO
[CompactionExecutor:9] 2013-02-04 22:54:41,215 CompactionManager.java (line 452) SSTables
for user defined compaction are already being compacted. INFO [HintedHandoff:2] 2013-02-04
22:54:41,216 HintedHandOffManager.java (line 412) Finished hinted handoff of 13909 rows to
endpoint /10.179.65.102 INFO [CompactionExecutor:8] 2013-02-04 22:54:41,444
CompactionTask.java (line 272) Compacted 1 sstables to
[/var/lib/cassandra/data/system/hints/system-hints-ib-3,].  625,567 bytes to 625,567
(~100% of original) in 401ms = 1.487749MB/s.  2 total rows, 2 unique.  Row merge counts
were {1:2, } INFO [HintedHandoff:1] 2013-02-04 22:54:41,445 HintedHandOffManager.java
(line 412) Finished hinted handoff of 13230 rows to endpoint
/10.179.111.137</pre></div></div>The problem is that with concurrent delivery we end up in
a state where we have two sstables that contain tombstones, each containing some portion
of them for the endpoints that were delivered to.  Since we never replay any rows again,
we never compact again, and thus never evict the tombstones.I think I'm back to what I
proposed before of just removing the replayed &gt; 0 check and letting isEmpty check
handle the common case. 


New Comment: 
Shouldn't the "I have &gt; X % tombstones in this sstable" code kick in? 


New Comment: 
We see this in 1.1.9 as well. 


New Comment: 
<blockquote>Shouldn't the "I have &gt; X % tombstones in this sstable" code kick
in?</blockquote>As in the tombstone-aggressive code in STS?  I suspect we're ending up
under the min compaction threshold all the time. 


New Comment: 
I believe this is a consequence of <a
href="https://issues.apache.org/jira/browse/CASSANDRA-5241" title="Fix forceBlockingFlush"
class="issue-link" data-issue-key="CASSANDRA-5241"><del>CASSANDRA-5241</del></a>. Now
while we should probably fix <a
href="https://issues.apache.org/jira/browse/CASSANDRA-5241" title="Fix forceBlockingFlush"
class="issue-link" data-issue-key="CASSANDRA-5241"><del>CASSANDRA-5241</del></a>, relying
on tombstone being always fully collected feels a bit fragile and not very useful since we
have the isEmpty check at the beginning of the delivery. So +1 on the patch. 


