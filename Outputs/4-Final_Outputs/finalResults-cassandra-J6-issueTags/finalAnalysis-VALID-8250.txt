Pattern changes caused by commit: 01fcb8cac25b1f617d16a3f72672ecafc02fe458

From: Abstract Factory-1
To:   Abstract Factory-2

From: Factory Method-1
To:   Factory Method-2

From: Decorator-2
To:   Decorator-1

From: Facade-0
To:   Facade-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-8250.txt 

commit 01fcb8cac25b1f617d16a3f72672ecafc02fe458
Author: Aleksey Yeschenko <aleksey@apache.org>

    Fix ALTER TABLE overriding compression options with defaults;
    patch by Aleksey Yeschenko, reviewed by Jonathan Ellis for
    CASSANDRA-4996



==================================
 Issue CASSANDRA-4996 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4996] After changing the compaction strategy, compression_strategy  always returning back to the "SnappyCompressor" through CQL 2.2.0
-----------------

-----------------
Summary: After changing the compaction strategy, compression_strategy  always returning back to the "SnappyCompressor" through CQL 2.2.0
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 27 Nov 2012 08:06:46 +0000
-----------------

-----------------
Resolved at: Thu, 13 Dec 2012 19:50:44 +0000
-----------------

-----------------
Assigned to: Aleksey Yeschenko
-----------------

-----------------
Description: 

faced very strange behaviour when changing compression_parameters of exisiting CF. After
changing the compaction strategy, compression_strategy returning back to the
"SnappyCompressor".

Using cassandra version 1.1.5.<br/><span class="error">&#91;cqlsh
2.2.0 | Cassandra 1.1.5 | CQL spec 2.0.0 | Thrift protocol 19.32.0&#93;</span><br/>I have
one column family with following paramters:

cqlsh &gt; describe columnfamily
auditlog_01;<br/>CREATE TABLE auditlog_01 (<br/>lid text PRIMARY KEY,<br/>dscn
text,<br/>asid text,<br/>soapa text<br/>) WITH<br/>comment='' AND<br/>comparator=text
AND<br/>read_repair_chance=0.100000 AND<br/>gc_grace_seconds=864000
AND<br/>default_validation=text AND<br/>min_compaction_threshold=4
AND<br/>max_compaction_threshold=32 AND<br/>replicate_on_write='true'
AND<br/>compaction_strategy_class='SizeTieredCompactionStrategy'
AND<br/>compaction_strategy_options:sstable_size_in_mb='5'
AND<br/>compression_parameters:sstable_compression='SnappyCompressor';

Changing
compression strategy to 'DeflateCompressor

cqlsh&gt; ALTER TABLE auditlog_01 WITH
compression_parameters:sstabl<br/>e_compression = 'DeflateCompressor' AND
compression_parameters:chunk_length_kb =<br/> 64;<br/>cqlsh&gt; describe columnfamily
auditlog_01;

CREATE TABLE auditlog_01 (<br/>lid text PRIMARY KEY,<br/>dscn text,<br/>asid
text,<br/>soapa text<br/>) WITH<br/>  comment='' AND<br/>  comparator=text AND<br/> 
read_repair_chance=0.100000 AND<br/>  gc_grace_seconds=864000 AND<br/> 
default_validation=text AND<br/>  min_compaction_threshold=4 AND<br/> 
max_compaction_threshold=32 AND<br/>  replicate_on_write='true' AND<br/> 
compaction_strategy_class='SizeTieredCompactionStrategy' AND<br/> 
compaction_strategy_options:sstable_size_in_mb='5' AND<br/> 
compression_parameters:chunk_length_kb='64' AND<br/> 
compression_parameters:sstable_compression='DeflateCompressor';

it's sucessfuly changed
the compression strategy to 'DeflateCompressor, after that when i am trying to change the
compaction strategy, compression strategy returing back to
"SnappyCompressor".<br/>cqlsh&gt; alter table auditlog_01 with
compaction_strategy_class='Le<br/>veledCompactionStrategy' AND
compaction_strategy_options:sstable_size_in_mb=5;<br/>cqlsh&gt; describe columnfamily
auditlog_01;

CREATE TABLE auditlog_01 (<br/>  lid text PRIMARY KEY,<br/>dscn
text,<br/>asid text,<br/>soapa text<br/>) WITH<br/>  comment='' AND<br/>  comparator=text
AND<br/>  read_repair_chance=0.100000 AND<br/>  gc_grace_seconds=864000 AND<br/> 
default_validation=text AND<br/>  min_compaction_threshold=4 AND<br/> 
max_compaction_threshold=32 AND<br/>  replicate_on_write='true' AND<br/> 
compaction_strategy_class='SizeTieredCompactionStrategy' AND<br/> 
compaction_strategy_options:sstable_size_in_mb='5' AND<br/> 
compression_parameters:sstable_compression='SnappyCompressor';
 

-----------------

-----------------
Comments: 

New Comment: 
I've run into this in the past, also.It was introduced in 1.1 when compression was turned
on by default.  The problem is that CFPropDefs class is shared by both CREATE and ALTER
statements' code path and to provide the "default on" functionality, the
sstable_compression value is statically set inside this class.  Then, because the ALTER
statement provided does not define the value (and thus override the default), it ends up
switching it back to the default.  This is also present in CQL 3 as far as I know.  I
think the fix will be to remove the defaulting from CFPropDefs and add it over in the
CREATE code path, since that is where the "default on" behavior is needed.Also, notice
that on your ALTER command, it did not actually change the compaction_strategy_class as
you requested, but that is probably another issue. 


New Comment: 
Patch for 1.2 is similar - not sure whether it should go into 1.2.0 or rc1. 


New Comment: 
Can you summarize the fix? 


New Comment: 
Basically what <a
href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=derek.bromenshenkel"
class="user-hover" rel="derek.bromenshenkel">Derek Bromenshenkel</a> suggested:<br/>1)
Remove the default strategy from CFPropDefs<br/>2) Set default strategy in
CreateColumnFamilyStatement<br/>3) Leave AlterTableStatement as is (mostly, cql3 version
of it needed a slight fix) 


New Comment: 
+1 


New Comment: 
If I trust the changelog this has been committed, so closing. 


New Comment: 
Thanks, committed. 


