Pattern changes caused by commit: 98708d817f8df91be4cfcba06c9523027fab881c

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-7437.txt 

commit 98708d817f8df91be4cfcba06c9523027fab881c
Author: Pavel Yaskevich <xedin@apache.org>

    fix assumption error in CLI when updating/describing keyspace
    patch by Pavel Yaskevich; reviewed by Dave Brosius for CASSANDRA-4322



==================================
 Issue CASSANDRA-4322 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4322] Error in CLI when updating keyspace
-----------------

-----------------
Summary: Error in CLI when updating keyspace
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 8 Jun 2012 16:03:39 +0000
-----------------

-----------------
Resolved at: Tue, 11 Sep 2012 11:18:47 +0000
-----------------

-----------------
Assigned to: Pavel Yaskevich
-----------------

-----------------
Description: 

To repro:

1. Open the cli<br/>2. Create a keyspace:<br/>  create keyspace ks1 with
placement_strategy = SimpleStrategy and strategy_options =

{replication_factor:1}
;<br/>3. Update the keyspace:<br/>  update keyspace ks1 with
strategy_options = 
{replication_factor:3}
;

The output is:

<span
class="error">&#91;default@unknown&#93;</span> create keyspace ks1 with placement_strategy
= SimpleStrategy and strategy_options = 
{replication_factor:1}
;                         
     <br/>8ecd5e16-e0f7-37e7-850e-38ee1a3a510e<br/>Waiting for schema agreement...<br/>...
schemas agree across the cluster<br/><span class="error">&#91;default@unknown&#93;</span>
update keyspace ks1 with strategy_options = 
{replication_factor:3}
;                     
                  <br/>857af387-6677-3e39-bdf6-e1132673c25b<br/>Waiting for schema
agreement...<br/>... schemas agree across the
cluster<br/>org.apache.thrift.protocol.TProtocolException: Required field 'keyspace' was
not present! Struct: describe_keyspace_args(keyspace:null)<br/><span
class="error">&#91;default@unknown&#93;</span>

The problem is that the patch in <a
href="https://issues.apache.org/jira/browse/CASSANDRA-4052" title="Add way to force the
cassandra-cli to refresh it&#39;s schema" class="issue-link"
data-issue-key="CASSANDRA-4052"><del>CASSANDRA-4052</del></a> assumes the CLI is
authenticated to a working keyspace.  getKSMetaData in executeUpdateKeySpace is called
with keySpace, which is null.

Changing this to keyspaceName partially solves it, we now
get:

<span class="error">&#91;default@unknown&#93;</span> update keyspace ks1 with
strategy_options = 
{replication_factor:3}
;<br/>Not authenticated to a working
keyspace.<br/>18d750fc-19d9-30f0-b8b9-18b2e4a0a0d4<br/>Waiting for schema
agreement...<br/>... schemas agree across the cluster<br/>Not authenticated to a working
keyspace.

This comes from replayAssumptions in getKSMetaData.

It seems that the refresh
code needs to be reworked slightly to not assume the CLI is authenticated to a keyspace.
 

-----------------

-----------------
Comments: 

New Comment: 
don't allow updating or dropping of a keyspace unless you authenticate to it (use ks). 


New Comment: 
This patch breaks backwards compatibility, so now operations that used to not require
setting a keyspace do.  Do we aim to keep the cassandra-cli interface compatible within
the same x.x release? 


New Comment: 
patch allows to create keyspace without being authorized to one + fixes describe. 


New Comment: 
+1 patch LGTM 


