Pattern changes caused by commit: feae9efa42a3395fce2447e97258ffdbe19d31cb

From: Abstract Factory-1
To:   Abstract Factory-2

From: Factory Method-1
To:   Factory Method-2

From: Decorator-2
To:   Decorator-1

From: Facade-0
To:   Facade-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-9078.txt 

commit feae9efa42a3395fce2447e97258ffdbe19d31cb
Author: Jonathan Ellis <jbellis@apache.org>

    Fix trying to load deleted row into row cache on startup
    patch by jbellis; reviewed by dbrosius for CASSANDRA-4463



==================================
 Issue CASSANDRA-4463 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4463] Nodes Don't Restart: Assertion Error on Serializing Cache provider
-----------------

-----------------
Summary: Nodes Don't Restart: Assertion Error on Serializing Cache provider
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 24 Jul 2012 21:47:17 +0000
-----------------

-----------------
Resolved at: Thu, 18 Apr 2013 18:32:12 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

I stopped Cassandra on one of our 1.1.2 nodes and I couldn't start it any more.
System.log didn't have much useful info but output.log had
this:

java.lang.AssertionError<br/>        at
org.apache.cassandra.cache.SerializingCacheProvider$RowCacheSerializer.serialize(SerializingCacheProvider.java:43)<br/>
       at
org.apache.cassandra.cache.SerializingCacheProvider$RowCacheSerializer.serialize(SerializingCacheProvider.java:39)<br/>
       at
org.apache.cassandra.cache.SerializingCache.serialize(SerializingCache.java:116)<br/>     
  at org.apache.cassandra.cache.SerializingCache.put(SerializingCache.java:174)<br/>      
 at org.apache.cassandra.cache.InstrumentingCache.put(InstrumentingCache.java:45)<br/>    
   at
org.apache.cassandra.db.ColumnFamilyStore.initRowCache(ColumnFamilyStore.java:430)<br/>   
    at org.apache.cassandra.db.Table.open(Table.java:124)<br/>        at
org.apache.cassandra.db.Table.open(Table.java:97)<br/>        at
org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:204)<br/>
       at
org.apache.cassandra.service.AbstractCassandraDaemon.init(AbstractCassandraDaemon.java:254)<br/>
       at
com.netflix.priam.cassandra.NFThinCassandraDaemon.init(NFThinCassandraDaemon.java:41)<br/>
       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>        at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)<br/>       
at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br/>
       at java.lang.reflect.Method.invoke(Method.java:597)<br/>        at
org.apache.commons.daemon.support.DaemonLoader.load(DaemonLoader.java:212)<br/>Cannot load
daemon<br/>Service exit with a return value of 3

Deleting the stuff in saved_caches
folder fixed the problem.
 

-----------------

-----------------
Comments: 

New Comment: 
This is still happening in 1.1.5. I just had to perform some maintenance and restart
service and I got this again:java.lang.AssertionError<br/>        at
org.apache.cassandra.cache.SerializingCacheProvider$RowCacheSerializer.serialize(SerializingCacheProvider.java:43)<br/>
       at
org.apache.cassandra.cache.SerializingCacheProvider$RowCacheSerializer.serialize(SerializingCacheProvider.java:39)<br/>
       at
org.apache.cassandra.cache.SerializingCache.serialize(SerializingCache.java:116)<br/>     
  at org.apache.cassandra.cache.SerializingCache.put(SerializingCache.java:174)<br/>      
 at org.apache.cassandra.cache.InstrumentingCache.put(InstrumentingCache.java:45)<br/>    
   at
org.apache.cassandra.db.ColumnFamilyStore.initRowCache(ColumnFamilyStore.java:446)<br/>   
    at org.apache.cassandra.db.Table.open(Table.java:124)<br/>        at
org.apache.cassandra.db.Table.open(Table.java:97)<br/>        at
org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:206)<br/>
       at
org.apache.cassandra.service.AbstractCassandraDaemon.init(AbstractCassandraDaemon.java:290)<br/>
       at
com.netflix.priam.cassandra.NFThinCassandraDaemon.init(NFThinCassandraDaemon.java:41)<br/>
       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>        at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)<br/>       
at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br/>
       at java.lang.reflect.Method.invoke(Method.java:597)<br/>        at
org.apache.commons.daemon.support.DaemonLoader.load(DaemonLoader.java:212)<br/>Cannot load
daemon<br/>Service exit with a return value of 3 


New Comment: 
Null CFs are not allowed in the row cache.  The normal read path checks this as
follows:<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java">.           ColumnFamily data =
getTopLevelColumns(QueryFilter.getIdentityFilter(filter.key, <span
class="code-keyword">new</span> QueryPath(columnFamily)),                                 
                 <span class="code-object">Integer</span>.MIN_VALUE,                      
                            <span class="code-keyword">true</span>);            <span
class="code-keyword">if</span> (sentinelSuccess &amp;&amp; data != <span
class="code-keyword">null</span>)               
CacheService.instance.rowCache.replace(key, sentinel, data);</pre></div></div>We need to
check this during cache population at startup as well, since the cache is only saved
intermittently &#8211; a row that contained data when the cache was saved, and
subsequently invalidated, will read as null on the following startup. 


New Comment: 
extraneous semi at end of line.do you want to increment cachedRowsRead if the data is
null?otherwise +1 


