Pattern changes caused by commit: ba9a8832d043d876fd18b2027cc933fc6689ca9c

From: Decorator-1
To:   Decorator-0

From: Flyweight-4
To:   Flyweight-5

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4980.txt 

commit ba9a8832d043d876fd18b2027cc933fc6689ca9c
Author: Jonathan Ellis <jbellis@apache.org>

    Kill server on wrapped OOME such as from FileChannel.map
    patch by jbellis; reviewed by slebresne for CASSANDRA-3201



==================================
 Issue CASSANDRA-3201 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3201] When a mmap fails, Cassandra should exit.
-----------------

-----------------
Summary: When a mmap fails, Cassandra should exit.
-----------------

-----------------
Issue type: Improvement
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 13 Sep 2011 15:33:48 +0000
-----------------

-----------------
Resolved at: Fri, 16 Sep 2011 19:14:34 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

When a mmap fails, Cassandra should exit. See <a
href="https://wiki.apache.org/cassandra/ArchitectureInternals#line-60"
class="external-link"
rel="nofollow">https://wiki.apache.org/cassandra/ArchitectureInternals#line-60</a>

Here
is an example stack trace:<br/>ERROR 17:11:36,258 Fatal exception in thread Thread<span
class="error">&#91;FlushWriter:2003,5,main&#93;</span><br/>java.io.IOError:
java.io.IOException: Map failed<br/>        at
org.apache.cassandra.io.util.MmappedSegmentedFile$Builder.createSegments(MmappedSegmentedFile.java:170)<br/>
       at
org.apache.cassandra.io.util.MmappedSegmentedFile$Builder.complete(MmappedSegmentedFile.java:147)<br/>
       at
org.apache.cassandra.io.sstable.SSTableWriter.closeAndOpenReader(SSTableWriter.java:194)<br/>
       at
org.apache.cassandra.io.sstable.SSTableWriter.closeAndOpenReader(SSTableWriter.java:173)<br/>
       at org.apache.cassandra.db.Memtable.writeSortedContents(Memtable.java:253)<br/>    
   at org.apache.cassandra.db.Memtable.access$400(Memtable.java:49)<br/>        at
org.apache.cassandra.db.Memtable$3.runMayThrow(Memtable.java:270)<br/>        at
org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by: java.io.IOException: Map
failed<br/>        at sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:748)<br/>       
at
org.apache.cassandra.io.util.MmappedSegmentedFile$Builder.createSegments(MmappedSegmentedFile.java:162)<br/>
       ... 10 more<br/>Caused by: java.lang.OutOfMemoryError: Map failed<br/>        at
sun.nio.ch.FileChannelImpl.map0(Native Method)<br/>        at
sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:745)<br/>        ... 11 more
 

-----------------

-----------------
Comments: 

New Comment: 
"Caused by: java.lang.OutOfMemoryError" makes it sounds like you hit your address space
limit, is that right? 


New Comment: 
Patch to unwrap the OOME so the "main" OOME-catcher in AbstractCassandraDaemon will shut
down the server. 


New Comment: 
lgtm, +1 


New Comment: 
v2 checks the exception chain in the uncaught exception handler instead of doing a one-off
just for FC.map 


New Comment: 
even better, +1 


New Comment: 
committed 


