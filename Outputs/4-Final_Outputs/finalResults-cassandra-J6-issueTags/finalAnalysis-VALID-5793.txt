Pattern changes caused by commit: aacbb1ca9c0e7a1992dfc92c096dd885ab149154

From: Decorator-1
To:   Decorator-0

From: Facade-1
To:   Facade-0

From: Flyweight-3
To:   Flyweight-5

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5793.txt 

commit aacbb1ca9c0e7a1992dfc92c096dd885ab149154
Author: Brandon Williams <brandonwilliams@apache.org>

    Block on flush before submitting compaction for hints.
    Patch by brandonwilliams, reviewed by jbellis for CASSANDRA-3733



==================================
 Issue CASSANDRA-3733 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3733] Once a host has been hinted to, log messages for it repeat every 10 mins even if no hints are delivered
-----------------

-----------------
Summary: Once a host has been hinted to, log messages for it repeat every 10 mins even if no hints are delivered
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Thu, 12 Jan 2012 16:39:08 +0000
-----------------

-----------------
Resolved at: Thu, 12 Jan 2012 17:03:37 +0000
-----------------

-----------------
Assigned to: Brandon Williams
-----------------

-----------------
Description: 
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent
panelContent"><pre> INFO 15:36:03,977 Started hinted handoff for token:
170141183460469231731687303715884105726 with IP: /10.179.111.137 INFO 15:36:03,978
Finished hinted handoff of 0 rows to endpoint /10.179.111.137 INFO 15:46:31,248 Started
hinted handoff for token: 170141183460469231731687303715884105726 with IP: /10.179.111.137
INFO 15:46:31,249 Finished hinted handoff of 0 rows to endpoint /10.179.111.137 INFO
15:56:29,448 Started hinted handoff for token: 170141183460469231731687303715884105726
with IP: /10.179.111.137 INFO 15:56:29,449 Finished hinted handoff of 0 rows to endpoint
/10.179.111.137 INFO 16:06:09,949 Started hinted handoff for token:
170141183460469231731687303715884105726 with IP: /10.179.111.137 INFO 16:06:09,950
Finished hinted handoff of 0 rows to endpoint /10.179.111.137 INFO 16:16:21,529 Started
hinted handoff for token: 170141183460469231731687303715884105726 with IP: /10.179.111.137
INFO 16:16:21,530 Finished hinted handoff of 0 rows to endpoint
/10.179.111.137</pre></div></div>
Introduced by <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3554" title="Hints are not replayed
unless node was marked down" class="issue-link"
data-issue-key="CASSANDRA-3554"><del>CASSANDRA-3554</del></a>.  The problem is that until
a compaction on hints occurs, tombstones are present causing the isEmpty() check to be
false.
 

-----------------

-----------------
Comments: 

New Comment: 
Why doesn't this take care of it?<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">.       <span
class="code-keyword">if</span> (rowsReplayed &gt; 0)        {           
hintStore.forceFlush();            <span class="code-keyword">try</span>            {     
          CompactionManager.instance.submitMaximal(hintStore, <span
class="code-object">Integer</span>.MAX_VALUE).get();            }            <span
class="code-keyword">catch</span> (Exception e)            {                <span
class="code-keyword">throw</span> <span class="code-keyword">new</span>
RuntimeException(e);            }        }</pre></div></div> 


New Comment: 
Because the flush isn't blocking:<div class="preformatted panel" style="border-width:
1px;"><div class="preformattedContent panelContent"><pre> INFO 16:50:36,248 Started hinted
handoff for token: 113427455640312821154458202477256070484 with IP: /10.179.64.227 INFO
16:50:36,265 Enqueuing flush of Memtable-HintsColumnFamily@1721309039(0/0 serialized/live
bytes, 1 ops) INFO 16:50:36,266 Writing Memtable-HintsColumnFamily@1721309039(0/0
serialized/live bytes, 1 ops) INFO 16:50:36,267 Nothing to compact in HintsColumnFamily. 
Use forceUserDefinedCompaction if you wish to force compaction of single sstables (e.g.
for tombstone collection) INFO 16:50:36,268 Finished hinted handoff of 1 rows to endpoint
/10.179.64.227 INFO 16:50:36,272 Completed flushing
/var/lib/cassandra/data/system/HintsColumnFamily-hc-2-Data.db (100
bytes)</pre></div></div> 


New Comment: 
Patch to make flushes blocking. 


New Comment: 
+1 


New Comment: 
the tombstone buffering on the next attempt could cause OOMs similar to <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3681" title="Multiple threads can
attempt hint handoff to the same target" class="issue-link"
data-issue-key="CASSANDRA-3681"><del>CASSANDRA-3681</del></a>, as well. 


New Comment: 
Committed. 


New Comment: 
Can you commit to 0.8 too? 


