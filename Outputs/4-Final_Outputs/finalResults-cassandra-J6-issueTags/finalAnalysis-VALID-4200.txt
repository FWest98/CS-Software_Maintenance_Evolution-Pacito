Pattern changes caused by commit: cd60613ae03642a841c0fd460205bcf78b10249c

From: Abstract Factory-3
To:   Abstract Factory-2

From: Factory Method-3
To:   Factory Method-2

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4200.txt 

commit cd60613ae03642a841c0fd460205bcf78b10249c
Author: Jonathan Ellis <jbellis@apache.org>

    fix truncate/compaction race
    patch by jbellis; reviewed by slebresne for CASSANDRA-2673



==================================
 Issue CASSANDRA-2673 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2673] AssertionError post truncate
-----------------

-----------------
Summary: AssertionError post truncate
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 20 May 2011 01:06:58 +0000
-----------------

-----------------
Resolved at: Wed, 1 Jun 2011 15:39:24 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

I had 3 nodes with about 100G in a CF. I run truncate on that CF from cassandra-cli. Then
I run cleanup for that CF. I saw this exception shortly after.

 INFO <span
class="error">&#91;FlushWriter:5&#93;</span> 2011-05-20 02:56:42,699 Memtable.java (line
157) Writing Memtable-body@1278535630(26722 bytes, 1 operations)<br/> INFO <span
class="error">&#91;FlushWriter:5&#93;</span> 2011-05-20 02:56:42,706 Memtable.java (line
172) Completed flushing /var/lib/cassandra/data/dnet/body-f-1892-Data.db (26915
bytes)<br/> INFO <span class="error">&#91;NonPeriodicTasks:1&#93;</span> 2011-05-20
02:59:55,981 SSTable.java (line 147) Deleted /var/lib/cassandra/data/dnet/body-f-1892<br/>
INFO <span class="error">&#91;NonPeriodicTasks:1&#93;</span> 2011-05-20 02:59:55,982
SSTable.java (line 147) Deleted /var/lib/cassandra/data/dnet/body-f-1889<br/> INFO <span
class="error">&#91;NonPeriodicTasks:1&#93;</span> 2011-05-20 02:59:55,983 SSTable.java
(line 147) Deleted /var/lib/cassandra/data/dnet/body-f-1890<br/> INFO <span
class="error">&#91;NonPeriodicTasks:1&#93;</span> 2011-05-20 02:59:55,983 SSTable.java
(line 147) Deleted /var/lib/cassandra/data/dnet/body-f-1888<br/> INFO <span
class="error">&#91;NonPeriodicTasks:1&#93;</span> 2011-05-20 02:59:55,984 SSTable.java
(line 147) Deleted /var/lib/cassandra/data/dnet/body-f-1887<br/> INFO <span
class="error">&#91;CompactionExecutor:1&#93;</span> 2011-05-20 03:02:08,724
CompactionManager.java (line 750) Cleaned up to
/var/lib/cassandra/data/dnet/body-tmp-f-1891-Data.db.  25,629,365,173 to 25,629,365,173
(~100% of original) bytes for 884,546 keys.  Time: 1,165,900ms.<br/>ERROR <span
class="error">&#91;CompactionExecutor:1&#93;</span> 2011-05-20 03:02:08,727
AbstractCassandraDaemon.java (line 114) Fatal exception in thread Thread<span
class="error">&#91;CompactionExecutor:1,1,main&#93;</span><br/>java.lang.AssertionError<br/>	at
org.apache.cassandra.io.sstable.SSTableTracker.replace(SSTableTracker.java:108)<br/>	at
org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:1037)<br/>	at
org.apache.cassandra.db.CompactionManager.doCleanupCompaction(CompactionManager.java:769)<br/>	at
org.apache.cassandra.db.CompactionManager.access$500(CompactionManager.java:56)<br/>	at
org.apache.cassandra.db.CompactionManager$2.call(CompactionManager.java:173)<br/>	at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>	at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>	at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>	at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>	at
java.lang.Thread.run(Thread.java:662)
 

-----------------

-----------------
Comments: 

New Comment: 
Looks like we need to move truncate to the compaction executor so they don't race.In the
meantime, retrying the truncate until it works should be fine. 


New Comment: 
patch to move the truncation operation to CompactionManager instead of postFlushExecutor.
(Not sure what the thinking was there, to be honest. Which may mean it's something subtle
I'm missing now, or maybe just that I was smoking crack when I wrote that code originally.
<a href="https://issues.apache.org/jira/browse/CASSANDRA-531" title="truncate support"
class="issue-link" data-issue-key="CASSANDRA-531"><del>CASSANDRA-531</del></a>, the
original truncate ticket, doesn't shed any light here.) 


New Comment: 
+1 


New Comment: 
committed 


