Pattern changes caused by commit: 8480f06e324e0bc2e042b7c1c483e08132d81eb4

From: Decorator-1
To:   Decorator-0

From: Facade-1
To:   Facade-0

From: Flyweight-4
To:   Flyweight-5

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5586.txt 

commit 8480f06e324e0bc2e042b7c1c483e08132d81eb4
Author: Jonathan Ellis <jbellis@apache.org>

    remove nonlocal DC write optimization
    patch by Vijay; reviewed by jbellis for CASSANDRA-3577



==================================
 Issue CASSANDRA-3577 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3577] TimeoutException When using QuorumEach or ALL consistency on Multi-DC
-----------------

-----------------
Summary: TimeoutException When using QuorumEach or ALL consistency on Multi-DC
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 6 Dec 2011 03:30:33 +0000
-----------------

-----------------
Resolved at: Thu, 8 Dec 2011 20:30:40 +0000
-----------------

-----------------
Assigned to: Vijay
-----------------

-----------------
Description: 

Currently we have <br/>1) StorageProxy.sendMessages() sending messages to the first node
in the other DC...  <br/>2) A node in the other DC will remove the ForwardHeader and
sendRR (Adding a MessageID to the Queue).<br/>3) The receiving node receives the mutation,
updates and sends the response to the Original Co-ordinator.<br/>4) Co-Ordinator now
checks for the MessageID (which it never had)

All the Quorum_Each updates fail in the
co-ordinator, this issue started showing up after <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3472" title="Actually uses efficient
cross DC writes" class="issue-link"
data-issue-key="CASSANDRA-3472"><del>CASSANDRA-3472</del></a> the code was introduced in
<a href="https://issues.apache.org/jira/browse/CASSANDRA-2138" title="add option to enable
efficient cross-dc replication" class="issue-link"
data-issue-key="CASSANDRA-2138"><del>CASSANDRA-2138</del></a> .

Simple Fix is to remove
the optimization in 0.8 and fix it in 1.x because it seems to me like it needs a change to
the Message service version.

Possible Solution: We might want send the message ID's to be
used by the all the nodes in other DC (Which is currently generated by the node which
receives the Forward request see: (2) ).
 

-----------------

-----------------
Comments: 

New Comment: 
All we need to do is forward with the original id, no?  Patch attached to do that. 


New Comment: 
(Patch is against 0.8.) 


New Comment: 
But when the Co-Ordinator receives the response with the message ID the message is already
removed because ResponseVerbHandler
does<br/>MessagingService.instance().removeRegisteredCallback(id);<br/>We wont have the ID
there. 


New Comment: 
You're right, we switched to using unique message IDs per target in <a
href="https://issues.apache.org/jira/browse/CASSANDRA-2058" title="Load spikes due to
MessagingService-generated garbage collection" class="issue-link"
data-issue-key="CASSANDRA-2058"><del>CASSANDRA-2058</del></a> so that we can track
timeouts for the dynamic snitch, so my patch won't work.I agree that pre-generating extra
IDs on the coordinator is the easiest fix, and also that we should just disable this
behavior in 0.8 (which was the case until <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3472" title="Actually uses efficient
cross DC writes" class="issue-link"
data-issue-key="CASSANDRA-3472"><del>CASSANDRA-3472</del></a> anyway). 


New Comment: 
removing mutation optimization for .8, i will work on the update to 1.1 shortly. Thanks! 


New Comment: 
committed .8 patch w/ comment pointing to this issue 


New Comment: 
Integrated in Cassandra-0.8 #409 (See <a
href="https://builds.apache.org/job/Cassandra-0.8/409/" class="external-link"
rel="nofollow">https://builds.apache.org/job/Cassandra-0.8/409/</a>)<br/>    remove
nonlocal DC write optimization<br/>patch by Vijay; reviewed by jbellis for <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3577" title="TimeoutException When
using QuorumEach or ALL consistency on Multi-DC" class="issue-link"
data-issue-key="CASSANDRA-3577"><del>CASSANDRA-3577</del></a>jbellis : <a
href="http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1210902"
class="external-link"
rel="nofollow">http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1210902</a><br/>Files
:
<ul>	<li>/cassandra/branches/cassandra-0.8/CHANGES.txt</li>	<li>/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageProxy.java</li></ul> 


New Comment: 
Testing took some additional time, This patch is on 1.1 with an updated
MessagingService.version to handle both older version and new version mutations. 


New Comment: 
Patch doesn't apply to latest trunk for me, can you rebase? 


New Comment: 
Sorry, Rebased to the the trunk. Thanks! 


New Comment: 
v3 attached.  Some cleanup of StorageProxy, switches to FastBAIS, and does a version check
on the receiving side as well as the sending (since we do have released versions in the
wild sending out "bad" FORWARD_HEADERs). 


New Comment: 
+1 Thanks! 


New Comment: 
committed 


New Comment: 
Integrated in Cassandra #1249 (See <a href="https://builds.apache.org/job/Cassandra/1249/"
class="external-link"
rel="nofollow">https://builds.apache.org/job/Cassandra/1249/</a>)<br/>    multi-dc
replication optimization supporting CL &gt; ONE<br/>patch by Vijay and jbellis for <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3577" title="TimeoutException When
using QuorumEach or ALL consistency on Multi-DC" class="issue-link"
data-issue-key="CASSANDRA-3577"><del>CASSANDRA-3577</del></a>jbellis : <a
href="http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1212088"
class="external-link"
rel="nofollow">http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1212088</a><br/>Files
:
<ul>	<li>/cassandra/trunk/CHANGES.txt</li>	<li>/cassandra/trunk/src/java/org/apache/cassandra/db/RowMutationVerbHandler.java</li>	<li>/cassandra/trunk/src/java/org/apache/cassandra/net/MessagingService.java</li>	<li>/cassandra/trunk/src/java/org/apache/cassandra/service/StorageProxy.java</li></ul> 


