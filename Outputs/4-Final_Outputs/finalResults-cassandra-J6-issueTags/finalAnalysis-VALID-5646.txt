Pattern changes caused by commit: db0d3131c2afa9f5bf75e30774d04e6bc56a1d52

From: Facade-1
To:   Facade-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5646.txt 

commit db0d3131c2afa9f5bf75e30774d04e6bc56a1d52
Author: Jonathan Ellis <jbellis@apache.org>

    fix assertion when dropping a columnfamily with no sstables
    patch by jbellis; reviewed by slebresne and tested by Andrew Suffield for CASSANDRA-3614



==================================
 Issue CASSANDRA-3614 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3614] Fatal exception in thread Thread[MigrationStage:1,5,main] (LeveledCompaction)
-----------------

-----------------
Summary: Fatal exception in thread Thread[MigrationStage:1,5,main] (LeveledCompaction)
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Mon, 12 Dec 2011 19:36:42 +0000
-----------------

-----------------
Resolved at: Mon, 12 Dec 2011 20:30:52 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

ERROR 19:29:39,712 Fatal exception in thread Thread<span
class="error">&#91;MigrationStage:1,5,main&#93;</span><br/>java.lang.AssertionError<br/>  
     at
org.apache.cassandra.db.compaction.LeveledManifest.promote(LeveledManifest.java:156)<br/> 
      at
org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:141)<br/>
       at
org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:488)<br/>      
 at org.apache.cassandra.db.DataTracker.removeAllSSTables(DataTracker.java:257)<br/>      
 at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:267)<br/> 
      at org.apache.cassandra.db.Table.unloadCf(Table.java:361)<br/>        at
org.apache.cassandra.db.Table.dropCf(Table.java:343)<br/>        at
org.apache.cassandra.db.migration.DropColumnFamily.applyModels(DropColumnFamily.java:87)<br/>
       at org.apache.cassandra.db.migration.Migration.apply(Migration.java:156)<br/>      
 at
org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:73)<br/>
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)<br/>    
   at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)<br/>       
at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)
 

-----------------

-----------------
Comments: 

New Comment: 
(This is the Debian build of the 1.0.6 RC that Sylvain just put up) 


New Comment: 
Bigger log chunk. This has got something to do with schema migrations. I had just created
the CF, and was trying to do some operations on it. Probably a truncate followed by a
batch insertion of a few dozen rows. INFO <span
class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:42:48,182 Migration.java
(line 119) Applying migration 784303e0-24f9-11e1-0000-0282f5487ffc Add column family:
org.a<br/>pache.cassandra.config.CFMetaData@e90e23[cfId=1083,ksName=CoreQA,cfName=Deal,cfType=Standard,comparator=org.apache.cassandra.db.marshal.UTF8Type,subcolumnc<br/>omparator=&lt;null&gt;,comment=,rowCacheSize=1.0,keyCacheSize=1.0,readRepairChance=1.0,replicateOnWrite=true,gcGraceSeconds=864000,defaultValidator=org.apache.ca<br/>ssandra.db.marshal.UTF8Type,keyValidator=org.apache.cassandra.db.marshal.UTF8Type,minCompactionThreshold=4,maxCompactionThreshold=32,rowCacheSavePeriodInSe<br/>conds=0,keyCacheSavePeriodInSeconds=14400,rowCacheKeysToSave=2147483647,rowCacheProvider=org.apache.cassandra.cache.SerializingCacheProvider@9f2588,mergeSh<br/>ardsChance=0.1,keyAlias=&lt;null&gt;,column_metadata={},compactionStrategyClass=class
org.apache.cassandra.db.compaction.LeveledCompactionStrategy,compactionStra<br/>tegyOptions={sstable_size_in_mb=10},compressionOptions={}]<br/>
INFO <span class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:42:48,183
ColumnFamilyStore.java (line 692) Enqueuing flush of
Memtable-Migrations@5834000(29724/37155 serialized/li<br/>ve bytes, 1 ops)<br/> INFO <span
class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:42:48,183
ColumnFamilyStore.java (line 692) Enqueuing flush of Memtable-Schema@3824284(25583/31978
serialized/live b<br/>ytes, 8 ops)<br/> INFO <span
class="error">&#91;FlushWriter:2&#93;</span> 2011-12-12 19:42:48,184 Memtable.java (line
240) Writing Memtable-Migrations@5834000(29724/37155 serialized/live bytes, 1 ops)<br/>
INFO <span class="error">&#91;FlushWriter:2&#93;</span> 2011-12-12 19:42:48,219
Memtable.java (line 277) Completed flushing
/var/lib/cassandra/data/system/Migrations-hc-135-Data.db (29788 b<br/>ytes)<br/> INFO
<span class="error">&#91;FlushWriter:2&#93;</span> 2011-12-12 19:42:48,220 Memtable.java
(line 240) Writing Memtable-Schema@3824284(25583/31978 serialized/live bytes, 8 ops)<br/>
INFO <span class="error">&#91;CompactionExecutor:3&#93;</span> 2011-12-12 19:42:48,221
CompactionTask.java (line 113) Compacting
[SSTableReader(path='/var/lib/cassandra/data/system/Migratio<br/>ns-hc-132-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Migrations-hc-133-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Mig<br/>rations-hc-134-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Migrations-hc-135-Data.db')]<br/> INFO
<span class="error">&#91;FlushWriter:2&#93;</span> 2011-12-12 19:42:48,247 Memtable.java
(line 277) Completed flushing /var/lib/cassandra/data/system/Schema-hc-135-Data.db (25733
bytes<br/>)<br/> INFO <span class="error">&#91;CompactionExecutor:3&#93;</span> 2011-12-12
19:42:48,371 CompactionTask.java (line 218) Compacted to
[/var/lib/cassandra/data/system/Migrations-hc-136-Data.db,<br/>].  1,521,844 to 1,521,704
(~99% of original) bytes for 1 keys at 9.674733MB/s.  Time: 150ms.<br/> INFO <span
class="error">&#91;CompactionExecutor:3&#93;</span> 2011-12-12 19:42:48,372
CompactionTask.java (line 113) Compacting
[SSTableReader(path='/var/lib/cassandra/data/system/Schema-h<br/>c-135-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Schema-hc-134-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Schema-hc-1<br/>33-Data.db'),
SSTableReader(path='/var/lib/cassandra/data/system/Schema-hc-132-Data.db')]<br/> INFO
<span class="error">&#91;CompactionExecutor:3&#93;</span> 2011-12-12 19:42:48,482
CompactionTask.java (line 218) Compacted to <span
class="error">&#91;/var/lib/cassandra/data/system/Schema-hc-136-Data.db,&#93;</span>. 
<br/>1,187,815 to 1,187,488 (~99% of original) bytes for 83 keys at 10.389695MB/s.  Time:
109ms.<br/> INFO <span class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12
19:43:58,220 Migration.java (line 119) Applying migration
a20e7a60-24f9-11e1-0000-0282f5487ffc Drop column family: Core<br/>QA.Deal<br/> INFO <span
class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:43:58,221
ColumnFamilyStore.java (line 692) Enqueuing flush of
Memtable-Migrations@19716308(29025/36281 serialized/l<br/>ive bytes, 1 ops)<br/> INFO
<span class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:43:58,224
ColumnFamilyStore.java (line 692) Enqueuing flush of Memtable-Schema@13515618(25227/31533
serialized/live <br/>bytes, 8 ops)<br/> INFO <span
class="error">&#91;FlushWriter:3&#93;</span> 2011-12-12 19:43:58,225 Memtable.java (line
240) Writing Memtable-Migrations@19716308(29025/36281 serialized/live bytes, 1 ops)<br/>
INFO <span class="error">&#91;FlushWriter:3&#93;</span> 2011-12-12 19:43:58,248
Memtable.java (line 277) Completed flushing
/var/lib/cassandra/data/system/Migrations-hc-138-Data.db (29089 b<br/>ytes)<br/> INFO
<span class="error">&#91;FlushWriter:3&#93;</span> 2011-12-12 19:43:58,249 Memtable.java
(line 240) Writing Memtable-Schema@13515618(25227/31533 serialized/live bytes, 8 ops)<br/>
INFO <span class="error">&#91;FlushWriter:3&#93;</span> 2011-12-12 19:43:58,275
Memtable.java (line 277) Completed flushing
/var/lib/cassandra/data/system/Schema-hc-138-Data.db (25377 bytes)<br/>ERROR <span
class="error">&#91;MigrationStage:1&#93;</span> 2011-12-12 19:43:58,276
AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread<span
class="error">&#91;MigrationStage:1,5,main&#93;</span><br/>java.lang.AssertionError<br/>  
     at
org.apache.cassandra.db.compaction.LeveledManifest.promote(LeveledManifest.java:156)<br/> 
      at
org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:141)<br/>
       at
org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:488)<br/>      
 at org.apache.cassandra.db.DataTracker.removeAllSSTables(DataTracker.java:257)<br/>      
 at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:267)<br/> 
      at org.apache.cassandra.db.Table.unloadCf(Table.java:361)<br/>        at
org.apache.cassandra.db.Table.dropCf(Table.java:343)<br/>        at
org.apache.cassandra.db.migration.DropColumnFamily.applyModels(DropColumnFamily.java:87)<br/>
       at org.apache.cassandra.db.migration.Migration.apply(Migration.java:156)<br/>      
 at org.apache.cassandra.thrift.CassandraServer$2.call(CassandraServer.java:846)<br/>     
  at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>ERROR <span
class="error">&#91;pool-2-thread-25&#93;</span> 2011-12-12 19:43:58,277 Cassandra.java
(line 3878) Internal error processing
system_drop_column_family<br/>java.lang.RuntimeException:
java.util.concurrent.ExecutionException: java.lang.AssertionError<br/>        at
org.apache.cassandra.thrift.CassandraServer.applyMigrationOnStage(CassandraServer.java:861)<br/>
       at
org.apache.cassandra.thrift.CassandraServer.system_drop_column_family(CassandraServer.java:903)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_drop_column_family.process(Cassandra.java:3872)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:2889)<br/>       
at
org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:187)<br/>
       at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.util.concurrent.ExecutionException: java.lang.AssertionError<br/>        at
java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br/>        at
java.util.concurrent.FutureTask.get(FutureTask.java:83)<br/>        at
org.apache.cassandra.thrift.CassandraServer.applyMigrationOnStage(CassandraServer.java:853)<br/>
       ... 7 more<br/>Caused by: java.lang.AssertionError<br/>        at
org.apache.cassandra.db.compaction.LeveledManifest.promote(LeveledManifest.java:156)<br/> 
      at
org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:141)<br/>
       at
org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:488)<br/>      
 at org.apache.cassandra.db.DataTracker.removeAllSSTables(DataTracker.java:257)<br/>      
 at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:267)<br/> 
      at org.apache.cassandra.db.Table.unloadCf(Table.java:361)<br/>        at
org.apache.cassandra.db.Table.dropCf(Table.java:343)<br/>        at
org.apache.cassandra.db.migration.DropColumnFamily.applyModels(DropColumnFamily.java:87)<br/>
       at org.apache.cassandra.db.migration.Migration.apply(Migration.java:156)<br/>      
 at org.apache.cassandra.thrift.CassandraServer$2.call(CassandraServer.java:846)<br/>     
  at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        ... 3 more<br/> INFO
<span class="error">&#91;MutationStage:62&#93;</span> 2011-12-12 19:43:59,004 NodeId.java
(line 206) Saved local node id: 0d098030-24e6-11e1-0000-0282f5487fff<br/>ERROR <span
class="error">&#91;ReadStage:60&#93;</span> 2011-12-12 19:44:00,322
AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread<span
class="error">&#91;ReadStage:60,5,main&#93;</span><br/>java.lang.RuntimeException:
java.lang.IllegalArgumentException: Unknown table/cf pair (CoreQA.Deal)<br/>        at
org.apache.cassandra.service.RangeSliceVerbHandler.doVerb(RangeSliceVerbHandler.java:60)<br/>
       at
org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:59)<br/>       
at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.lang.IllegalArgumentException: Unknown table/cf pair (CoreQA.Deal)<br/>        at
org.apache.cassandra.db.Table.getColumnFamilyStore(Table.java:159)<br/>        at
org.apache.cassandra.service.RangeSliceVerbHandler.doVerb(RangeSliceVerbHandler.java:48)<br/>
       ... 4 more 


New Comment: 
Thanks for testing &#8211; attached patch should fix that. 


New Comment: 
(Affects at least back to 1.0.3 with <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3399" title="Truncate disregards
running compactions when deleting sstables" class="issue-link"
data-issue-key="CASSANDRA-3399"><del>CASSANDRA-3399</del></a>, possibly older.) 


New Comment: 
+1 


New Comment: 
That fixed it. Thanks for quick response. 


