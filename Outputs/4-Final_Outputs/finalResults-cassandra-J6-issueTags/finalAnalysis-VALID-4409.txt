Pattern changes caused by commit: 6a9a336ad4a4621aeb7bf73a4e6cd15aaf74323d

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4409.txt 

commit 6a9a336ad4a4621aeb7bf73a4e6cd15aaf74323d
Author: Jonathan Ellis <jbellis@apache.org>

    ensure that string tokens do not contain commas
    patch by jbellis; reviewed by slebresne for CASSANDRA-2762



==================================
 Issue CASSANDRA-2762 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2762] Token cannot contain comma (possibly non-alpha/non-numeric too?) in OrderPreservingPartitioner
-----------------

-----------------
Summary: Token cannot contain comma (possibly non-alpha/non-numeric too?) in OrderPreservingPartitioner
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Sat, 11 Jun 2011 01:54:54 +0000
-----------------

-----------------
Resolved at: Wed, 6 Jul 2011 17:11:04 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

It'd appear that when the token contain comma in the OrderPreservingPartitioner case, C*
will fail with assert error:

ERROR <span class="error">&#91;GossipStage:1&#93;</span>
2011-06-09 16:01:05,063 AbstractCassandraDaemon.java (line 112) Fatal exception in thread
Thread<span
class="error">&#91;GossipStage:1,5,main&#93;</span><br/>java.lang.AssertionError<br/>   
at
org.apache.cassandra.service.StorageService.handleStateBootstrap(StorageService.java:685)<br/>
   at org.apache.cassandra.service.StorageService.onChange(StorageService.java:648)<br/>  
 at org.apache.cassandra.gms.Gossiper.doNotifications(Gossiper.java:772)<br/>    at
org.apache.cassandra.gms.Gossiper.applyApplicationStateLocally(Gossiper.java:737)<br/>   
at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:679)<br/>    at
org.apache.cassandra.gms.GossipDigestAck2VerbHandler.doVerb(GossipDigestAck2VerbHandler.java:60)<br/>
   at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:72)<br/>  
 at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>  
 at java.lang.Thread.run(Thread.java:662)
 

-----------------

-----------------
Comments: 

New Comment: 
<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java">    <span class="code-comment">// <span
class="code-keyword">this</span> must be a <span class="code-object">char</span> that
cannot be present in any token</span>    <span class="code-keyword">public</span> <span
class="code-keyword">final</span> <span class="code-keyword">static</span> <span
class="code-object">char</span> DELIMITER = <span class="code-quote">','</span>;    <span
class="code-keyword">public</span> <span class="code-keyword">final</span> <span
class="code-keyword">static</span> <span class="code-object">String</span> DELIMITER_STR =
<span class="code-keyword">new</span> <span class="code-object">String</span>(<span
class="code-keyword">new</span> <span class="code-object">char</span>[] { DELIMITER
});</pre></div></div>Changing to something more obscure would be a backwards-incompatible
change. Not worth it. 


New Comment: 
However we should make sure that we fail-fast invalid initial_token setting, as well as do
not hand out bad tokens during auto bootstrap token selection 


New Comment: 
patch adds TokenFactory.validate, calls it on initial_token or move input, and adds code
to prevent commas in autogenerated tokens 


New Comment: 
v2 does token hacking post-midpoint instead of in midpoint itself, which is confusing (and
unnecessary for merkle tree uses of midpoint which is the main one). 


New Comment: 
nit: the comment " // Hack to prevent giving nodes tokens with strings in them" should
probably read " // Hack to prevent giving nodes tokens with DELIMITER_STR in them"?+1 


New Comment: 
committed w/ that change.also added a final check post-replaceall:<div class="code panel"
style="border-width: 1px;"><div class="codeContent panelContent"><pre class="code-java">  
         <span class="code-keyword">if</span>
(tokenMetadata_.getTokenToEndpointMap().containsKey(token))                <span
class="code-keyword">throw</span> <span class="code-keyword">new</span>
RuntimeException(<span class="code-quote">"Unable to compute unique token <span
class="code-keyword">for</span> <span class="code-keyword">new</span> node -- specify one
manually with initial_token"</span>);</pre></div></div> 


New Comment: 
I also note for the record that if you must use an ordered partitioner, you should almost
certainly be using ByteOrderedPartitioner instead of the obsolete OPP. 


