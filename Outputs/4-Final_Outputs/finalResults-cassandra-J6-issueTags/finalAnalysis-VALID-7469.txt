Pattern changes caused by commit: a500e2835748f19d0c11bc3dfcecc71c50d9cf7e

From: Decorator-1
To:   Decorator-2

From: Flyweight-1
To:   Flyweight-2

From: Mediator-1
To:   Mediator-3

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-7469.txt 

commit a500e2835748f19d0c11bc3dfcecc71c50d9cf7e
Author: Brandon Williams <brandonwilliams@apache.org>

    cqlsh: check for non-empty history file before loading
    Patch by Brian O'Neill, reviewed by brandonwilliams for CASSANDRA-4669



==================================
 Issue CASSANDRA-4669 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4669] Empty .cqlsh_history file causes cqlsh to crash on startup.
-----------------

-----------------
Summary: Empty .cqlsh_history file causes cqlsh to crash on startup.
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 14 Sep 2012 20:55:29 +0000
-----------------

-----------------
Resolved at: Tue, 18 Sep 2012 01:44:50 +0000
-----------------

-----------------
Assigned to: Brian ONeill
-----------------

-----------------
Description: 

Not sure how I got it, but I ended up with an empty .cqlsh_history file.  In that state,
when starting cqlsh, you end up with:

bone@zen:~/dev/boneill42/cassandra-&gt; bin/cqlsh
<br/>Traceback (most recent call last):<br/>  File "bin/cqlsh", line 2588, in
&lt;module&gt;<br/>    main(*read_options(sys.argv<span class="error">&#91;1:&#93;</span>,
os.environ))<br/>  File "bin/cqlsh", line 2543, in main<br/>   
readline.read_history_file(HISTORY)<br/>IOError: <span class="error">&#91;Errno
22&#93;</span> Invalid argument

Its a simple fix to check for a non-empty history file. 
I'll attach the patch.
 

-----------------

-----------------
Comments: 

New Comment: 
Here is the patch. 


New Comment: 
Patch attached. 


New Comment: 
Committed. 


New Comment: 
This patch breaks cqlsh history loading. Also, the original issue isn't an issue at all -
readline handles empty history files perfectly well.<br/>Reverting the commit should fix
the new issue. 


New Comment: 
Reverted. 


New Comment: 
I trust you guys, but you may just want to double check that this isn't an issue.  I can
easily reproduce the problem.  Here is a log.  You can see it working initially.  I
truncate the file, and no joy.bone@zen:~/dev/boneill42/cassandra-&gt; bin/cqlsh
<br/>Connected to Test Cluster at localhost:9160.<br/><span class="error">&#91;cqlsh 2.2.0
| Cassandra 1.1.5 | CQL spec 3.0.0 | Thrift protocol 19.32.0&#93;</span><br/>Use HELP for
help.<br/>cqlsh&gt; quit<br/>bone@zen:~/dev/boneill42/cassandra-&gt; rm -fr
~/.cqlsh_history <br/>bone@zen:~/dev/boneill42/cassandra-&gt; touch
~/.cqlsh_history<br/>bone@zen:~/dev/boneill42/cassandra-&gt; bin/cqlsh <br/>Traceback
(most recent call last):<br/>  File "bin/cqlsh", line 2588, in &lt;module&gt;<br/>   
main(*read_options(sys.argv<span class="error">&#91;1:&#93;</span>, os.environ))<br/> 
File "bin/cqlsh", line 2543, in main<br/>   
readline.read_history_file(HISTORY)<br/>IOError: <span class="error">&#91;Errno
22&#93;</span> Invalid argument<br/>bone@zen:~/dev/boneill42/cassandra-&gt; 


New Comment: 
Maybe we should just catch any error from loading the history, issue a warning, and move
along. 


New Comment: 
Brian, what are your python/readline versions and OS?<blockquote> ➤
bin/cqlsh<br/>Connected to Test Cluster at localhost:9160.<br/><span
class="error">&#91;cqlsh 2.2.0 | Cassandra unknown | CQL spec 3.0.0 | Thrift protocol
19.34.0&#93;</span><br/>Use HELP for help.<br/>cqlsh&gt; quit<br/> ➤ rm -fr
~/.cqlsh_history <br/> ➤ touch ~/.cqlsh_history<br/> ➤ bin/cqlsh <br/>Connected to Test
Cluster at localhost:9160.<br/><span class="error">&#91;cqlsh 2.2.0 | Cassandra unknown |
CQL spec 3.0.0 | Thrift protocol 19.34.0&#93;</span><br/>Use HELP for
help.<br/>cqlsh&gt;</blockquote>Also, shell will write empty .cqlsh_history when you open
it for the first time and close it without entering any commands. And will open just fine
next time.Brandon, or do that, yes. Then we can get rid of os.path.exists(HISTORY) check. 


New Comment: 
Not sure how to tell exact version of readline. (I'm a java head =)<br/>This is on OSX. 
Looks like the version is the one provided by apple in the python install.Here is what
i've got:<br/>bone@zen:~/dev/boneill42/cassandra-&gt; python<br/>Python 2.7.1 (r271:86832,
Jul 31 2011, 19:30:53) <br/><span class="error">&#91;GCC 4.2.1 (Based on Apple Inc. build
5658) (LLVM build 2335.15.00)&#93;</span> on darwin<br/>Type "help", "copyright",
"credits" or "license" for more information.<br/>&gt;&gt;&gt; import
readline<br/>&gt;&gt;&gt; readline<br/>&lt;module 'readline' from
'/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload/readline.so'&gt;FWW,
this can be a really annoying error unless you can read Python.  It doesn't get far enough
to recrete the history file.  So, the problem persists. Your average user would be stuck. 
I first reinstalled Cassandra because I thought something was corrupt.  Fortunately,
python isn't compiled. =) 


New Comment: 
Ah, OS X. Maybe it really does fail on OS X. Works on Ubuntu though. Attached a patch that
catches IOError when reading/writing from/to history file. 


New Comment: 
Beautiful.  Thanks guys. 


