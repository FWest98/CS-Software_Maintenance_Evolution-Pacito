Pattern changes caused by commit: 7954d69001dfb4205c45dde88d2f7b3e9457f31d

From: Decorator-0
To:   Decorator-1

From: Flyweight-5
To:   Flyweight-4

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5084.txt 

commit 7954d69001dfb4205c45dde88d2f7b3e9457f31d
Author: Jonathan Ellis <jbellis@apache.org>

    fix full queue scenario for ParallelCompactionIterator
    patch by jbellis; reviewed by slebresne for CASSANDRA-3270



==================================
 Issue CASSANDRA-3270 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3270] Error during multi-threaded compaction in 0.8
-----------------

-----------------
Summary: Error during multi-threaded compaction in 0.8
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 28 Sep 2011 21:40:20 +0000
-----------------

-----------------
Resolved at: Thu, 29 Sep 2011 22:09:42 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

I'm running 0.8.6 plus the multi-threaded compaction patch in issue 2901.  I'm getting an
error compacting last night:

Error occured during
compaction<br/>java.util.concurrent.ExecutionException: java.lang.ClassCastException:
java.util.concurrent.ThreadPoolExecutor cannot be cast to
org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor<br/>        at
java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br/>        at
java.util.concurrent.FutureTask.get(FutureTask.java:83)<br/>        at
org.apache.cassandra.db.compaction.CompactionManager.performMajor(CompactionManager.java:278)<br/>
       at
org.apache.cassandra.db.ColumnFamilyStore.forceMajorCompaction(ColumnFamilyStore.java:1856)<br/>
       at
org.apache.cassandra.service.StorageService.forceTableCompaction(StorageService.java:1447)<br/>
       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>        at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)<br/>       
at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br/>
       at java.lang.reflect.Method.invoke(Method.java:597)<br/>        at
com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:93)<br/>
       at
com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:27)<br/>
       at
com.sun.jmx.mbeanserver.MBeanIntrospector.invokeM(MBeanIntrospector.java:208)<br/>       
at com.sun.jmx.mbeanserver.PerInterface.invoke(PerInterface.java:120)<br/>        at
com.sun.jmx.mbeanserver.MBeanSupport.invoke(MBeanSupport.java:262)<br/>        at
com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:836)<br/>
       at com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:761)<br/>     
  at
javax.management.remote.rmi.RMIConnectionImpl.doOperation(RMIConnectionImpl.java:1427)<br/>
       at
javax.management.remote.rmi.RMIConnectionImpl.access$200(RMIConnectionImpl.java:72)<br/>  
     at
javax.management.remote.rmi.RMIConnectionImpl$PrivilegedOperation.run(RMIConnectionImpl.java:1265)<br/>
       at
javax.management.remote.rmi.RMIConnectionImpl.doPrivilegedOperation(RMIConnectionImpl.java:1360)<br/>
       at
javax.management.remote.rmi.RMIConnectionImpl.invoke(RMIConnectionImpl.java:788)<br/>     
  at sun.reflect.GeneratedMethodAccessor28.invoke(Unknown Source)<br/>        at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br/>
       at java.lang.reflect.Method.invoke(Method.java:597)<br/>        at
sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:305)<br/>        at
sun.rmi.transport.Transport$1.run(Transport.java:159)<br/>        at
java.security.AccessController.doPrivileged(Native Method)<br/>        at
sun.rmi.transport.Transport.serviceCall(Transport.java:155)<br/>        at
sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:535)<br/>        at
sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:790)<br/>     
  at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:649)<br/> 
      at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:619)<br/>Caused by: java.lang.ClassCastException:
java.util.concurrent.ThreadPoolExecutor cannot be cast to
org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor<br/>        at
org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor$1.rejectedExecution(DebuggableThreadPoolExecutor.java:53)<br/>
       at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:767)<br/>
       at
java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:658)<br/>       
at
java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:92)<br/> 
      at
org.apache.cassandra.db.compaction.ParallelCompactionIterable$Reducer.getCompactedRow(ParallelCompactionIterable.java:211)<br/>
       at
org.apache.cassandra.db.compaction.ParallelCompactionIterable$Reducer.getReduced(ParallelCompactionIterable.java:185)<br/>
       at
org.apache.cassandra.db.compaction.ParallelCompactionIterable$Reducer.getReduced(ParallelCompactionIterable.java:146)<br/>
       at
org.apache.cassandra.utils.ReducingIterator.computeNext(ReducingIterator.java:74)<br/>    
   at
com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)<br/>
       at
com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)<br/>       
at
org.apache.cassandra.db.compaction.ParallelCompactionIterable$Unwrapper.computeNext(ParallelCompactionIterable.java:105)<br/>
       at
org.apache.cassandra.db.compaction.ParallelCompactionIterable$Unwrapper.computeNext(ParallelCompactionIterable.java:92)<br/>
       at
com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)<br/>
       at
com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)<br/>       
at
org.apache.commons.collections.iterators.FilterIterator.setNextObject(FilterIterator.java:183)<br/>
       at
org.apache.commons.collections.iterators.FilterIterator.hasNext(FilterIterator.java:94)<br/>
       at
org.apache.cassandra.db.compaction.CompactionManager.doCompactionWithoutSizeEstimation(CompactionManager.java:573)<br/>
       at
org.apache.cassandra.db.compaction.CompactionManager.doCompaction(CompactionManager.java:507)<br/>
       at
org.apache.cassandra.db.compaction.CompactionManager$4.call(CompactionManager.java:320)<br/>
       at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>       
at java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        ... 3 more
 

-----------------

-----------------
Comments: 

New Comment: 
Patch (against trunk) to fix the problem.  Should also apply to 0.8 + the old 2901 patch
with minimal effort. 


New Comment: 
Applying the patch by hand to 0.8 gives me:    <span class="error">&#91;javac&#93;</span>
src/java/org/apache/cassandra/db/compaction/ParallelCompactionIterable.java:89: cannot
find symbol<br/>    <span class="error">&#91;javac&#93;</span> symbol  : constructor
Reducer(org.apache.commons.collections.iterators.CollatingIterator)<br/>    <span
class="error">&#91;javac&#93;</span> location: class
org.apache.cassandra.db.compaction.ParallelCompactionIterable.Reducer<br/>    <span
class="error">&#91;javac&#93;</span>         return new Unwrapper(new Reducer(iter),
controller);<br/>    <span class="error">&#91;javac&#93;</span>                           
  ^<br/>    <span class="error">&#91;javac&#93;</span>
src/java/org/apache/cassandra/db/compaction/ParallelCompactionIterable.java:146: cannot
find symbol<br/>    <span class="error">&#91;javac&#93;</span> symbol  : constructor
ReducingIterator()<br/>    <span class="error">&#91;javac&#93;</span> location: class
org.apache.cassandra.utils.ReducingIterator&lt;org.apache.cassandra.db.compaction.ParallelCompactionIterable.RowContainer,org.apache.cassandra.db.compaction.ParallelCompactionIterable.CompactedRowContainer&gt;<br/>
   <span class="error">&#91;javac&#93;</span>     private class Reducer extends
ReducingIterator&lt;RowContainer, CompactedRowContainer&gt; implements
CloseableIterator&lt;CompactedRowContainer&gt;<br/>    <span
class="error">&#91;javac&#93;</span>             ^This is probably something trivial, but
I don't know the rest to make it work in 0.8? 


New Comment: 
lgtm, +1@Karl: that error seems completely unrelated to the patch on this ticket, but
seems more like you applied the wrong patch from 2901 (the one for 1.0.0). 


New Comment: 
Patch attached with both 2901 and 3270 rebased and combined for 0.8. 


New Comment: 
committed to trunk 


New Comment: 
Thanks Jonathan.  I will apply this patch to 0.8 trunk and test MT compaction performance
as we discussed in email. 


New Comment: 
Getting this issue applying 2901-v8-2.txt against 0.8 trunk: <a
href="http://pastebin.com/81WQxkYV" class="external-link"
rel="nofollow">http://pastebin.com/81WQxkYV</a> 


New Comment: 
updated v2 to include new files 


New Comment: 
Sorry to be a pain in the butt, but it's not starting up.  I get the same error with 0.8.6
based source or 0.8 trunk.  This is with the updated v2 patch. Exception in thread "main"
java.lang.NoClassDefFoundError: org/apache/cassandra/thrift/CassandraDaemon<br/>Caused by:
java.lang.ClassNotFoundException: org.apache.cassandra.thrift.CassandraDaemon<br/>       
at java.net.URLClassLoader$1.run(URLClassLoader.java:202)<br/>        at
java.security.AccessController.doPrivileged(Native Method)<br/>        at
java.net.URLClassLoader.findClass(URLClassLoader.java:190)<br/>        at
java.lang.ClassLoader.loadClass(ClassLoader.java:307)<br/>        at
sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)<br/>        at
java.lang.ClassLoader.loadClass(ClassLoader.java:248)<br/>Could not find the main class:
org.apache.cassandra.thrift.CassandraDaemon.  Program will exit. 


New Comment: 
Usually that just means ant got confused.  Try "ant realclean" first. 


