Pattern changes caused by commit: 84eeb28e3c60fee44597f4e4c663472ef147c811

From: Decorator-0
To:   Decorator-1

From: Flyweight-5
To:   Flyweight-4

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5211.txt 

commit 84eeb28e3c60fee44597f4e4c663472ef147c811
Author: Jonathan Ellis <jbellis@apache.org>

    ICompactSerializer* -> I[Versioned]Serializer
    patch by jbellis; reviewed by brandonwilliams for CASSANDRA-3333



==================================
 Issue CASSANDRA-3333 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3333] remove more copies from read/write network path
-----------------

-----------------
Summary: remove more copies from read/write network path
-----------------

-----------------
Issue type: Improvement
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 7 Oct 2011 19:16:20 +0000
-----------------

-----------------
Resolved at: Thu, 13 Oct 2011 05:10:17 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

RowMutation.serializedBuffer and ReadVerbHandler both do an extra copy of the serialized
data. We can avoid this be pre-computing the serialized size and allocating an appropriate
buffer.
 

-----------------

-----------------
Comments: 

New Comment: 
01 cleans up the serializer snafu we've been living with<br/>02 actually does the
optimizationPrior to this patch we had three generic serializers:ICompactSerializer, which
is used by Messages, and whose de/serialize methods have version
parametersICompactSerializer2, which does not have versions and whose methods have
DataInput/Output parameters instead of Input/OutputStreams. (The former is a superset of
the later.)ICompactSerializer3, which extends ICS2 and adds serializedSize.To do this
optimization I'd need ICS4, since I want serializedSize AND versioning.Instead, I've
replaced the three old interfaces with just ISerializer and IVersionedSerializer.  Both
use DataInput/Output, and both have a serializedSize method; the difference is that the
former does not have a version parameter. Implementers that don't care about precomputing
size simply implement as UnsupportedOperation.A few serializers (in LegacyBloomFilter and
MerkleTree) still needed a Stream parameter because they are doing JDK serialization under
the hood. None of that code actually cares about using a generic Serializer interface, so
I just made them one-off classes and everything was happy. 


New Comment: 
+1 


New Comment: 
New version of patch 2, covering the rest of the serializations on the read and write
path. Extracted serialize-and-assert-it-matched-claimed-size code into
FBUtilities.serialize. 


New Comment: 
Doesn't quite work:<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre> INFO 08:19:01,875 Creating new commitlog
segment /var/lib/cassandra/commitlog/CommitLog-1318339141875.logERROR 08:19:01,884 Fatal
exception in thread Thread[COMMIT-LOG-WRITER,5,main]java.lang.AssertionError        at
org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:782)        at
org.apache.cassandra.db.RowMutation.getSerializedBuffer(RowMutation.java:278)        at
org.apache.cassandra.db.commitlog.CommitLogSegment.write(CommitLogSegment.java:122)       
at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:605)     
  at
org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:49)
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)       
at java.lang.Thread.run(Thread.java:662)</pre></div></div> 


New Comment: 
updated 02 w/ fixes 


New Comment: 
+1, approximate 10% gain on both reads and writes. 


