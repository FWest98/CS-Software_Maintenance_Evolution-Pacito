Pattern changes caused by commit: 202f3940dc35411f9b2351a026e859e487b94591

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1

From: Template Method-3
To:   Template Method-2


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-7162.txt 

commit 202f3940dc35411f9b2351a026e859e487b94591
Author: Pavel Yaskevich <xedin@apache.org>

    fix "Can't Modify Index Name" problem on CF update
    patch by Pavel Yaskevich; reviewed by Yuki Morishita for CASSANDRA-4439



==================================
 Issue CASSANDRA-4439 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4439] Updating column family using cassandra-cli results in "Cannot modify index name"
-----------------

-----------------
Summary: Updating column family using cassandra-cli results in "Cannot modify index name"
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 13 Jul 2012 22:01:17 +0000
-----------------

-----------------
Resolved at: Wed, 18 Jul 2012 22:16:04 +0000
-----------------

-----------------
Assigned to: Pavel Yaskevich
-----------------

-----------------
Description: 

Using cassandra-cli the following update to a column family worked in 1.1.0:
<div
class="code panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">create keyspace testing;use testing;create column family Albumwith
comparator = UTF8Typeand default_validation_class = UTF8Typeand column_metadata =[   
{column_name: profileId, validation_class: UTF8Type, index_type: KEYS}];update column
family Albumand column_metadata =[    {column_name: profileId, validation_class: UTF8Type,
index_type: KEYS},    {column_name: postedDate, validation_class:
LongType}];</pre></div></div>
After upgrading to 1.1.2, the update statement fails with
the following exception in system.log:
<blockquote>
ERROR <span
class="error">&#91;Thrift:16&#93;</span> 2012-07-13 14:51:54,558
CustomTThreadPoolServer.java (line 204) Error occurred during processing of
message.<br/>java.lang.RuntimeException: java.util.concurrent.ExecutionException:
java.io.IOException: org.apache.cassandra.config.ConfigurationException: Cannot modify
index name<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:373)<br/>        at
org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:188)<br/>    
   at
org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:161)<br/>
       at
org.apache.cassandra.thrift.CassandraServer.system_update_column_family(CassandraServer.java:1063)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:3520)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:3508)<br/>
       at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)<br/>       
at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)<br/>        at
org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)<br/>
       at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.util.concurrent.ExecutionException: java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name<br/>       
at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br/>        at
java.util.concurrent.FutureTask.get(FutureTask.java:83)<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:369)<br/>        ...
11 more<br/>Caused by: java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name<br/>       
at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:676)<br/>        at
org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:463)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:407)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:271)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:211)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        ... 3 more<br/>Caused
by: org.apache.cassandra.config.ConfigurationException: Cannot modify index name<br/>     
  at org.apache.cassandra.config.ColumnDefinition.apply(ColumnDefinition.java:214)<br/>   
    at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:758)<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:672)<br/>        ... 9
more<br/>ERROR <span class="error">&#91;MigrationStage:1&#93;</span> 2012-07-13
14:51:54,561 AbstractCassandraDaemon.java (line 134) Exception in thread Thread<span
class="error">&#91;MigrationStage:1,5,main&#93;</span><br/>java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name<br/>       
at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:676)<br/>        at
org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:463)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:407)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:271)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:211)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name<br/>       
at org.apache.cassandra.config.ColumnDefinition.apply(ColumnDefinition.java:214)<br/>     
  at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:758)<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:672)<br/>        ... 9
more
</blockquote>
After further testing the following works in 1.1.2:
<div class="code
panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">create keyspace testing;use testing;create column family Albumwith
comparator = UTF8Typeand default_validation_class = UTF8Typeand column_metadata =[   
{column_name: profileId, validation_class: UTF8Type, index_name: <span
class="code-quote">'Album_profileId_idx'</span>, index_type: KEYS}];update column family
Albumand column_metadata =[    {column_name: profileId, validation_class: UTF8Type,
index_name: <span class="code-quote">'Album_profileId_idx'</span>, index_type: KEYS},   
{column_name: postedDate, validation_class: LongType}];</pre></div></div>
So it appears
that if you did not specify an index_name when creating the column originally, you cannot
update the column family anymore.
 

-----------------

-----------------
Comments: 

New Comment: 
For some extra information I modified
./src/java/org/apache/cassandra/config/ColumnDefinition.java:214 to show me what the index
name issue was and it appears if you don't specify the index on the update, the index is
automatically created at "Album_profileId_idx_2".  <blockquote>ERROR <span
class="error">&#91;Thrift:1&#93;</span> 2012-07-16 05:50:11,566
CustomTThreadPoolServer.java (line 204) Error occurred during processing of
message.<br/>java.lang.RuntimeException: java.util.concurrent.ExecutionException:
java.io.IOException: org.apache.cassandra.config.ConfigurationException: Cannot modify
index name Album_profileId_idx != Album_profileId_idx_2<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:373)<br/>        at
org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:188)<br/>    
   at
org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:161)<br/>
       at
org.apache.cassandra.thrift.CassandraServer.system_update_column_family(CassandraServer.java:1063)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:3520)<br/>
       at
org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:3508)<br/>
       at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)<br/>       
at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)<br/>        at
org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)<br/>
       at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.util.concurrent.ExecutionException: java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name
Album_profileId_idx != Album_profileId_idx_2<br/>        at
java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br/>        at
java.util.concurrent.FutureTask.get(FutureTask.java:83)<br/>        at
org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:369)<br/>        ...
11 more<br/>Caused by: java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name
Album_profileId_idx != Album_profileId_idx_2<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:676)<br/>        at
org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:463)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:407)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:271)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:211)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        ... 3 more<br/>Caused
by: org.apache.cassandra.config.ConfigurationException: Cannot modify index name
Album_profileId_idx != Album_profileId_idx_2<br/>        at
org.apache.cassandra.config.ColumnDefinition.apply(ColumnDefinition.java:214)<br/>       
at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:758)<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:672)<br/>        ... 9
more<br/>ERROR <span class="error">&#91;MigrationStage:1&#93;</span> 2012-07-16
05:50:11,570 AbstractCassandraDaemon.java (line 134) Exception in thread Thread<span
class="error">&#91;MigrationStage:1,5,main&#93;</span><br/>java.io.IOException:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name
Album_profileId_idx != Album_profileId_idx_2<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:676)<br/>        at
org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:463)<br/>        at
org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:407)<br/>        at
org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:271)<br/>        at
org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:211)<br/>      
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
org.apache.cassandra.config.ConfigurationException: Cannot modify index name
Album_profileId_idx != Album_profileId_idx_2<br/>        at
org.apache.cassandra.config.ColumnDefinition.apply(ColumnDefinition.java:214)<br/>       
at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:758)<br/>        at
org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:672)<br/>        ... 9
more</blockquote>I was able to work around the issue if I specify the auto-generated index
name in the update statement.<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">create keyspace testing;use
testing;create column family Albumwith comparator = UTF8Typeand default_validation_class =
UTF8Typeand column_metadata =[    {column_name: profileId, validation_class: UTF8Type,
index_type: KEYS}];update column family Albumand column_metadata =[    {column_name: <span
class="code-quote">'profileId'</span>, validation_class: UTF8Type, index_name: <span
class="code-quote">'Album_profileId_idx'</span>, index_type: KEYS},    {column_name:
postedDate, validation_class: LongType}];</pre></div></div>Also for anyone wondering, you
can find the auto-generated index name by doing a show schema on the keyspace.  I'm going
to drop the severity since I can work around the issue by adjusting my update statements. 


New Comment: 
Also despite the fact that it says you cannot rename the index, it will rename the index
if you run the command and restart cassandra.  The exception does not stop the schema from
being updated.  Also if you attempt to update the schema again with a corrected index name
after it throws the exception, it will not accept it until you restart.  At which point
your index name has already been changed to the first index name you attempted.An example
of this is:<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java">create keyspace testing;use testing;create column
family Albumwith comparator = UTF8Typeand default_validation_class = UTF8Typeand
column_metadata =[    {column_name: profileId, validation_class: UTF8Type, index_type:
KEYS}];update column family Albumand column_metadata =[    {column_name: <span
class="code-quote">'profileId'</span>, validation_class: UTF8Type, index_name: <span
class="code-quote">'badindex'</span>, index_type: KEYS},    {column_name: postedDate,
validation_class: LongType}];</pre></div></div>The previous update will throw an exception
and if you attempt to run the following it will still throw the exception:<div class="code
panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">update column family Albumand column_metadata =[    {column_name: <span
class="code-quote">'profileId'</span>, validation_class: UTF8Type, index_name: <span
class="code-quote">'Album_profileId_idx'</span>, index_type: KEYS},    {column_name:
postedDate, validation_class: LongType}];</pre></div></div>Also if you restart and do a
show schema, your index is now named "badindex".<div class="code panel"
style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">[<span class="code-keyword">default</span>@testing] show schema;create
keyspace testing  with placement_strategy = <span
class="code-quote">'NetworkTopologyStrategy'</span>  and strategy_options = {datacenter1 :
1}  and durable_writes = <span class="code-keyword">true</span>;use testing;create column
family Album  with column_type = <span class="code-quote">'Standard'</span>  and
comparator = <span class="code-quote">'UTF8Type'</span>  and default_validation_class =
<span class="code-quote">'UTF8Type'</span>  and key_validation_class = <span
class="code-quote">'BytesType'</span>  and read_repair_chance = 0.1  and
dclocal_read_repair_chance = 0.0  and gc_grace = 864000  and min_compaction_threshold = 4 
and max_compaction_threshold = 32  and replicate_on_write = <span
class="code-keyword">true</span>  and compaction_strategy = <span
class="code-quote">'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy'</span>
 and caching = <span class="code-quote">'KEYS_ONLY'</span>  and column_metadata = [   
{column_name : <span class="code-quote">'profileId'</span>,    validation_class :
UTF8Type,    index_name : <span class="code-quote">'badindex'</span>,    index_type : 0}, 
  {column_name : <span class="code-quote">'postedDate'</span>,    validation_class :
LongType}]  and compression_options = {<span
class="code-quote">'sstable_compression'</span> : <span
class="code-quote">'org.apache.cassandra.io.compress.SnappyCompressor'</span>};</pre></div></div> 


New Comment: 
Isn't existingIndexNames supposed to take care of this case? 


New Comment: 
No, it doesn't do that. 


New Comment: 
I have verified this patch fixes my issue.  thanks. 


New Comment: 
Thanks, Alex. addDefaultIndexNames() works just fine when cql where we have all of the
metadata (index_names/index_type) but for cli, where we need to provide all of the column
attributes by hand, it wasn't because index_name should be filled in by user every time
even if it was auto generated, so just checking that index_name is not set there (when no
explicit name were given) is not good enough for thrift access. 


New Comment: 
+1 


New Comment: 
Committed. 


