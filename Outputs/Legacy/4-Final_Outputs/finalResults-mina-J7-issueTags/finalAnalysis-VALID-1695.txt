Pattern changes caused by commit: d021fc1ef7295af8a5b1a9afb3fc9f5328db53ae

From: Facade-4
To:   Facade-5

From: Proxy-0
To:   Proxy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-1695.txt 

commit d021fc1ef7295af8a5b1a9afb3fc9f5328db53ae
Author: Emmanuel Lecharny <elecharny@apache.org>

    o Fix for DIRMINA-687
    o Removed the @version tag
    o Added a LOGGER, but commented it as it breaks the MDCFilterTest for some unknown reason ...
    o Minor refactoring
    o Javadoc addition



==================================
 Issue DIRMINA-687 Description 
=======================================

Project: MINA
-----------------

-----------------
Title: [DIRMINA-687] 2.0.0-M5 REGRESSION: sessionClosed called before doDecode completes
-----------------

-----------------
Summary: 2.0.0-M5 REGRESSION: sessionClosed called before doDecode completes
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Closed
-----------------

-----------------
Created at: Thu, 16 Apr 2009 20:48:40 +0000
-----------------

-----------------
Resolved at: Wed, 13 May 2009 23:25:26 +0000
-----------------

-----------------
Assigned to: Emmanuel LÃ©charny
-----------------

-----------------
Description: 

The problem is described in detail at <a
href="http://markmail.org/message/3iqmkdcukhygxxva" class="external-link"
rel="nofollow">http://markmail.org/message/3iqmkdcukhygxxva</a> .

I did more tests by
setting the CLOSED custom attribute inside sessionClosed and by checking for this
attribute in the middle of doDecode. 

Under some networking conditions on the production
server I can see the following in the logs:

<span class="error">&#91;2009-04-16
22:30:17,329&#93;</span> Session closed in the middle of decoding!<br/><span
class="error">&#91;2009-04-16 22:30:21,126&#93;</span> Session closed in the middle of
decoding!<br/><span class="error">&#91;2009-04-16 22:30:22,345&#93;</span> Session closed
in the middle of decoding!<br/><span class="error">&#91;2009-04-16
22:30:22,969&#93;</span> Session closed in the middle of decoding!<br/><span
class="error">&#91;2009-04-16 22:30:25,217&#93;</span> Session closed in the middle of
decoding!<br/><span class="error">&#91;2009-04-16 22:30:25,840&#93;</span> Session closed
in the middle of decoding!<br/><span class="error">&#91;2009-04-16
22:30:59,958&#93;</span> Session closed in the middle of decoding!

Unfortunately, I
didn't manage to prepare an isolated test case for this issue, must be some race condition
which is tricky to catch.

Most likely the problem is caused by this commit: <a
href="http://svn.apache.org/viewvc?view=rev&amp;revision=762167" class="external-link"
rel="nofollow">http://svn.apache.org/viewvc?view=rev&amp;revision=762167</a> .

As
mentioned, this problem is new to 2.0.0-M5, worked fine for many months with 2.0.0-M4 and
previous builds. Rolling back to M4 builds fixes the problem
instantly.<br/>OrderedThreadPool must guarantee the order of events, sessionClosed must
not be called when doDecode is in progress.
 

-----------------

-----------------
Comments: 

New Comment: 
Once I've understood better what is happening, I managed to write a proper test case for
this bug. It appears that sessionClosed is indeed invoked before doDecode completes the
packet decoding.Output of the test with 2.0.0-M4:<span class="error">&#91;2009-04-17
03:01:19,042&#93;</span> START<br/><span class="error">&#91;2009-04-17
03:01:21,182&#93;</span> 9&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,182&#93;</span> 9&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:21,183&#93;</span> 4&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,183&#93;</span> 4&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:21,183&#93;</span> 10&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,183&#93;</span> 10&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:21,183&#93;</span> 18&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,184&#93;</span> 18&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:21,682&#93;</span> 14&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,682&#93;</span> 20&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:21,682&#93;</span> 14&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:21,682&#93;</span> 20&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:22,177&#93;</span> 13&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:22,177&#93;</span> 17&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:22,177&#93;</span> 13&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:22,177&#93;</span> 17&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:22,184&#93;</span> 2&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:22,184&#93;</span> 2&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:22,185&#93;</span> 5&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:01:22,185&#93;</span> 5&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:01:22,185&#93;</span> Received: 0<br/><span class="error">&#91;2009-04-17
03:01:22,185&#93;</span> Sent: 10<br/><span class="error">&#91;2009-04-17
03:01:22,189&#93;</span> FINISHOutput with 2.0.0-M5:<span class="error">&#91;2009-04-17
03:00:21,577&#93;</span> START<br/><span class="error">&#91;2009-04-17
03:00:22,221&#93;</span> 4&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:00:22,221&#93;</span> 15&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:00:22,719&#93;</span> 4&gt; <span class="error">Unable to render embedded object: File
(session closed before decoding completes) not found.</span><br/><span
class="error">&#91;2009-04-17 03:00:22,719&#93;</span> 15&gt; <span class="error">Unable
to render embedded object: File (session closed before decoding completes) not
found.</span><br/><span class="error">&#91;2009-04-17 03:00:22,719&#93;</span> 15&gt;
<span class="error">Unable to render embedded object: File (decoding for closed session)
not found.</span><br/><span class="error">&#91;2009-04-17 03:00:22,719&#93;</span> 4&gt;
<span class="error">Unable to render embedded object: File (decoding for closed session)
not found.</span><br/><span class="error">&#91;2009-04-17 03:00:22,721&#93;</span> 17&gt;
Session closed<br/><span class="error">&#91;2009-04-17 03:00:22,722&#93;</span> 19&gt;
Session closed<br/><span class="error">&#91;2009-04-17 03:00:22,723&#93;</span> 21&gt;
Session closed<br/><span class="error">&#91;2009-04-17 03:00:23,218&#93;</span> 13&gt;
Session closed<br/><span class="error">&#91;2009-04-17 03:00:23,221&#93;</span> 17&gt;
<span class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:23,221&#93;</span> 17&gt; <span class="error">Unable to render embedded object: File
(decoding for closed session) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:23,222&#93;</span> 19&gt; <span class="error">Unable to render embedded object: File
(session closed before decoding completes) not found.</span><br/><span
class="error">&#91;2009-04-17 03:00:23,222&#93;</span> 19&gt; <span class="error">Unable
to render embedded object: File (decoding for closed session) not found.</span><br/><span
class="error">&#91;2009-04-17 03:00:23,223&#93;</span> 21&gt; <span class="error">Unable
to render embedded object: File (session closed before decoding completes) not
found.</span><br/><span class="error">&#91;2009-04-17 03:00:23,223&#93;</span> 21&gt;
<span class="error">Unable to render embedded object: File (decoding for closed session)
not found.</span><br/><span class="error">&#91;2009-04-17 03:00:23,717&#93;</span> 13&gt;
<span class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:23,717&#93;</span> 13&gt; <span class="error">Unable to render embedded object: File
(decoding for closed session) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:23,719&#93;</span> 4&gt; <span class="error">Unable to render embedded object: File
(session closed before decoding completes) not found.</span><br/><span
class="error">&#91;2009-04-17 03:00:23,719&#93;</span> 15&gt; <span class="error">Unable
to render embedded object: File (session closed before decoding completes) not
found.</span><br/><span class="error">&#91;2009-04-17 03:00:23,719&#93;</span> 4&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:23,719&#93;</span> 15&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:23,721&#93;</span> 6&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:23,721&#93;</span> 6&gt; Session
closed<br/><span class="error">&#91;2009-04-17 03:00:23,722&#93;</span> 10&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:23,722&#93;</span> 9&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:23,722&#93;</span> 10&gt; Session
closed<br/><span class="error">&#91;2009-04-17 03:00:23,722&#93;</span> 9&gt; Session
closed<br/><span class="error">&#91;2009-04-17 03:00:24,221&#93;</span> 17&gt; <span
class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:24,221&#93;</span> 17&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:00:24,222&#93;</span> 19&gt; <span class="error">Unable to render embedded object: File
(session closed before decoding completes) not found.</span><br/><span
class="error">&#91;2009-04-17 03:00:24,222&#93;</span> 19&gt; done decoding<br/><span
class="error">&#91;2009-04-17 03:00:24,223&#93;</span> 21&gt; <span class="error">Unable
to render embedded object: File (session closed before decoding completes) not
found.</span><br/><span class="error">&#91;2009-04-17 03:00:24,223&#93;</span> 21&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:24,717&#93;</span> 2&gt; done
decoding<br/><span class="error">&#91;2009-04-17 03:00:24,717&#93;</span> 13&gt; <span
class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;2009-04-17
03:00:24,717&#93;</span> 2&gt; Session closed<br/><span class="error">&#91;2009-04-17
03:00:24,717&#93;</span> 13&gt; done decoding<br/><span class="error">&#91;2009-04-17
03:00:24,717&#93;</span> Received: 0<br/><span class="error">&#91;2009-04-17
03:00:24,717&#93;</span> Sent: 10<br/><span class="error">&#91;2009-04-17
03:00:24,721&#93;</span> FINISHThe test is designed so that the server session closes
itself from another thread while doDecode is in progress.<br/>M4 continues decoding while
M5 calls sessionClosed even if decoding is in progress which removes session attributes
used in doDecode. Order of events is violated.The test case is sensitive to the position
of the executor in the chain. Executor must be located before the codec. If it's after
decoder, the output will be different (you will not see "done decoding" lines at all and
the bug will be not reproducible).With M5 the test doesn't reproduce the bug in 100% of
runs, so one may need to run several times or increase the number of messages and/or wait
times. 


New Comment: 
To be fixed urgently 


New Comment: 
I looked at the code yesturday. Did it worked on 2.0.0-M4 ?I suspect that we don't check
if some close event has been received when we process some new incomming requests for a
session. It's a bit strange... Will try to analyze the situation again tonite, but it's
not really as simple as I though. The code is a bit convoluted in this area :/ Also the
'javadoc' and 'comments' don't help, to say the least ... 


New Comment: 
&gt; Did it worked on 2.0.0-M4 ? Yes, you can run the attached test and see the difference
yourself. 


New Comment: 
I have run the tests against 2.0.0-M5, and got some error, accordingly to the report. So I
went a bit further last week-end, adding some logs, up to a point I obtained those traces
:<span class="error">&#91;05:56:01&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - START<br/>...<br/><span
class="error">&#91;05:56:02&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - Creation of session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_OPENED to session 4<br/>Queue : <span
class="error">&#91;SESSION_OPENED, &#93;</span><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task SESSION_OPENED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_OPENED event for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - Session 4 is opened<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_OPENED has been fired for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 4<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task MESSAGE_RECEIVED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 4<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task MESSAGE_RECEIVED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_CLOSED to session 4<br/>Queue : <span
class="error">&#91;SESSION_CLOSED, &#93;</span><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task SESSION_CLOSED for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_CLOSED event for session 4<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - 4&gt; Session closed<br/><span
class="error">&#91;05:56:02&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_CLOSED has been fired for session 4<br/><span
class="error">&#91;05:56:03&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 4&gt; <span
class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;05:56:03&#93;</span>-MinaThread
DEBUG <span class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span>
- Event MESSAGE_RECEIVED has been fired for session 4<br/><span
class="error">&#91;05:56:03&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 4&gt; <span
class="error">Unable to render embedded object: File (decoding for closed session) not
found.</span><br/><span class="error">&#91;05:56:04&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 4&gt; <span
class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;05:56:04&#93;</span>-MinaThread
INFO <span class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 4&gt; done
decoding<br/><span class="error">&#91;05:56:04&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
MESSAGE_RECEIVED has been fired for session 4<br/>...<br/><span
class="error">&#91;05:56:04&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Received: 0<br/><span
class="error">&#91;05:56:04&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Sent: 10<br/><span
class="error">&#91;05:56:04&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - FINISH(I'm focusing on
session 4, from the server side, as it's one of the failing session. It's random...)What
puzzle me is that the MESSAGE_RECEIVED event is added twice (but that should not be a
problem). More important, the SESSION_CLOSED event is processed <b>before</b> the
MESSAGE_RECEIVED is completely processed (even if the first message is being processed by
the codec). Still debugging ... 


New Comment: 
Ok, I now understand what happens. The doDecode method in the MyRequestDecoder class
create a new thread, and launch it. This thread does a sleep(500), nothing more. This has
the side effect to let the main thread processing another event. If this new thread is not
created, then the program works well. Here are the logs I got :<span
class="error">&#91;06:38:34&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - START<br/>...<br/><span
class="error">&#91;06:38:34&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - Creation of session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_OPENED to session 5<br/>Queue : <span
class="error">&#91;SESSION_OPENED, &#93;</span><br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task SESSION_OPENED for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_OPENED event for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - Session 5 is opened<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_OPENED has been fired for session 5<br/>...<br/><span
class="error">&#91;06:38:34&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 5<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><br/>...<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task MESSAGE_RECEIVED for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 5<br/>...<br/><span
class="error">&#91;06:38:34&#93;</span>-NioProcessor-2 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 5<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><br/>...<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 1000 ms for session
5<br/><span class="error">&#91;06:38:34&#93;</span>-Thread-0 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 500 ms for session
5<br/>...<br/><span class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task MESSAGE_RECEIVED for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 5<br/><span
class="error">&#91;06:38:34&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 5<br/>...<br/><span
class="error">&#91;06:38:35&#93;</span>-Thread-0 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 500 ms sleep
for session 5<br/>...<br/><span class="error">&#91;06:38:35&#93;</span>-NioProcessor-2
INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_CLOSED to session 5<br/>Queue : <span
class="error">&#91;SESSION_CLOSED, &#93;</span><span
class="error">&#91;06:38:35&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Processing task SESSION_CLOSED for session 5<br/><span
class="error">&#91;06:38:35&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_CLOSED event for session 5<br/><span
class="error">&#91;06:38:35&#93;</span>-MinaThread INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - 5&gt; Session closed<br/><span
class="error">&#91;06:38:35&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_CLOSED has been fired for session 5<br/>...<br/><span
class="error">&#91;06:38:35&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 1000 ms
sleep for session 5<br/><span class="error">&#91;06:38:35&#93;</span>-MinaThread ERROR
<span class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 5&gt; <span
class="error">Unable to render embedded object: File (session closed before decoding
completes) not found.</span><br/><span class="error">&#91;06:38:35&#93;</span>-MinaThread
ERROR <span class="error">&#91;testcase.MyRequestDecoder&#93;</span> - 5&gt; <span
class="error">Unable to render embedded object: File (decoding for closed session) not
found.</span><br/><span class="error">&#91;06:38:35&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 1000 ms for session
5<br/><span class="error">&#91;06:38:35&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
MESSAGE_RECEIVED has been fired for session 5<br/>...<br/><span
class="error">&#91;06:38:37&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Received: 0<br/><span
class="error">&#91;06:38:37&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Sent: 10<br/><span
class="error">&#91;06:38:37&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - FINISHNow, the question is
why does the MinaThread can process another event while the thread is supposed to be
'busy' ? 


New Comment: 
Got it !The previous trace is just confusing. The MinaThread is not sleeping <em>and</em>
executing some other task at the same time. It's just that the executor is processing
incoming events using a pool of threads (called 'workers'), but rename those workers using
the main thread name (ie, 'MinaThread'). This is very bad ...However, this does not solve
the problem : why do we have a session event being processed while another event is
already beoing processed ? This is not what we expect for an
OrderThreadPoolExecutor...Here is the trace :<span class="error">&#91;0&#93;</span>-main
INFO <span class="error">&#91;testcase.MinaRegressionTest&#93;</span> -
START<br/>...<br/><span class="error">&#91;145&#93;</span>-NioProcessor-3 INFO <span
class="error">&#91;testcase.MyIoHandler&#93;</span> - Creation of session 5<br/><span
class="error">&#91;145&#93;</span>-NioProcessor-3 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_OPENED to session 5<br/>Queue : <span
class="error">&#91;SESSION_OPENED, &#93;</span><br/>...<br/><span
class="error">&#91;148&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
<span class="error">&#91;worker-1&#93;</span>Processing task SESSION_OPENEDfor session
5<br/><span class="error">&#91;148&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_OPENED event for session 5<br/><span class="error">&#91;148&#93;</span>-MinaThread
INFO <span class="error">&#91;testcase.MyIoHandler&#93;</span> - Session 5 is
opened<br/><span class="error">&#91;148&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_OPENED has been fired for session 5<br/>...<br/><span
class="error">&#91;153&#93;</span>-NioProcessor-3 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 5<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><br/><span
class="error">&#91;153&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
<span class="error">&#91;worker-1&#93;</span>Processing task MESSAGE_RECEIVEDfor session
5<br/><span class="error">&#91;153&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 5<br/><span
class="error">&#91;153&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 5<br/><span
class="error">&#91;153&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 1000 ms for session
5<br/><span class="error">&#91;153&#93;</span>-Thread-1 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 500 ms for session
5<br/>...<br/><span class="error">&#91;158&#93;</span>-NioProcessor-3 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event MESSAGE_RECEIVED to session 5<br/>Queue : <span
class="error">&#91;MESSAGE_RECEIVED, &#93;</span><br/>...<br/><span
class="error">&#91;161&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
<span class="error">&#91;worker-6&#93;</span>Processing task MESSAGE_RECEIVEDfor session
5<br/><span class="error">&#91;161&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
MESSAGE_RECEIVED event for session 5<br/><span
class="error">&#91;161&#93;</span>-MinaThread INFO <span
class="error">&#91;org.apache.mina.filter.codec.ProtocolCodecFilter&#93;</span> -
Processing a MESSAGE_RECEIVED for session 5<br/>...<br/><span
class="error">&#91;654&#93;</span>-Thread-1 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 500 ms sleep
for session 5<br/><span class="error">&#91;656&#93;</span>-NioProcessor-3 INFO <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
Adding event SESSION_CLOSED to session 5<br/>Queue : <span
class="error">&#91;SESSION_CLOSED, &#93;</span><br/>...<br/><span
class="error">&#91;663&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.filter.executor.OrderedThreadPoolExecutor&#93;</span> -
<span class="error">&#91;worker-9&#93;</span>Processing task SESSION_CLOSEDfor session
5<br/>...<br/><span class="error">&#91;665&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Firing a
SESSION_CLOSED event for session 5<br/><span class="error">&#91;665&#93;</span>-MinaThread
INFO <span class="error">&#91;testcase.MyIoHandler&#93;</span> - 5&gt; Session
closed<br/><span class="error">&#91;665&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
SESSION_CLOSED has been fired for session 5<br/>...<br/><span
class="error">&#91;1153&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 1000 ms
sleep for session 5<br/><span class="error">&#91;1154&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - <span class="error">Unable to
render embedded object: File (session 5 closed before decoding completes) not
found.</span><br/><span class="error">&#91;1154&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
MESSAGE_RECEIVED has been fired for session 5<br/><span
class="error">&#91;1154&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - !decoding for closed session
5<br/><span class="error">&#91;1155&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 1000 ms for session
5<br/><span class="error">&#91;1155&#93;</span>-Thread-11 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Sleep for 500 ms for session
5<br/>...<br/><span class="error">&#91;1655&#93;</span>-Thread-11 DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 500 ms sleep
for session 5<br/>...<br/><span class="error">&#91;2155&#93;</span>-MinaThread DEBUG <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Wake up now from a 1000 ms
sleep for session 5<br/><span class="error">&#91;2155&#93;</span>-MinaThread ERROR <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - <span class="error">Unable to
render embedded object: File (session 5 closed before decoding completes) not
found.</span><br/><span class="error">&#91;2156&#93;</span>-MinaThread INFO <span
class="error">&#91;testcase.MyRequestDecoder&#93;</span> - Done decoding for session
5<br/><span class="error">&#91;2156&#93;</span>-MinaThread DEBUG <span
class="error">&#91;org.apache.mina.core.filterchain.IoFilterEvent&#93;</span> - Event
MESSAGE_RECEIVED has been fired for session 5<br/>...<br/><span
class="error">&#91;2686&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Received: 0<br/><span
class="error">&#91;2686&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - Sent: 10<br/><span
class="error">&#91;2686&#93;</span>-main INFO <span
class="error">&#91;testcase.MinaRegressionTest&#93;</span> - FINISH 


New Comment: 
I have a patch for this problem. Basically, I had removed the code which forbid a new task
to be run while another task was in progress. After having restored the 2.0.0-M4 code
which handles this case, it seems to work well.Still having some issues in other parts of
the code, so I can't commit atm... 


New Comment: 
Fixed with <a href="http://svn.apache.org/viewvc?rev=774589&amp;view=rev"
class="external-link"
rel="nofollow">http://svn.apache.org/viewvc?rev=774589&amp;view=rev</a>.It took me a hell
of a time to understand where the problem came from... We <b>must</b> add some logs in the
code ! 


New Comment: 
Sorry, but is there any idea when M6 or RC1 will be made available? I think this issue in
M5 is causing a lot of headaches for our Red5 users. If I ever meet you (Emmanuel) in
person, I'll buy you a beer. <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/smile.png" height="16"
width="16" align="absmiddle" alt="" border="0"/> 


