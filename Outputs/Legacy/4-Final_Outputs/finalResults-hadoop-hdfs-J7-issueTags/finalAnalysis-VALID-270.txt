Pattern changes caused by commit: 4d6da77b6561cad1424a6bc65c13d85a26362182

From: Mediator-0
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-270.txt 

commit 4d6da77b6561cad1424a6bc65c13d85a26362182
Author: Hairong Kuang <hairong@apache.org>

    HDFS-723. Fix deadlock in DFSClient#DFSOutputStream. Contributed by Hairong Kuang.



==================================
 Issue HDFS-723 Description 
=======================================

Project: Hadoop HDFS
-----------------

-----------------
Title: [HDFS-723] Deadlock in DFSClient#DFSOutputStream
-----------------

-----------------
Summary: Deadlock in DFSClient#DFSOutputStream
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 21 Oct 2009 20:50:09 +0000
-----------------

-----------------
Resolved at: Mon, 26 Oct 2009 21:44:10 +0000
-----------------

-----------------
Assigned to: Hairong Kuang
-----------------

-----------------
Description: 

WhiIe was running some append-related tests, I hit this deadlock:
<div
class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent
panelContent"><pre>Found one Java-level deadlock:============================="Thread-3": 
waiting to lock monitor 0x000000012ee044f0 (object 0x0000000107a0ded0, a
org.apache.hadoop.hdfs.DFSClient$DFSOutputStream),  which is held by "main""main": 
waiting to lock monitor 0x000000012eeb71a8 (object 0x00000001082b0748, a
org.apache.hadoop.hdfs.DFSClient$LeaseChecker),  which is held by "Thread-3"Java stack
information for the threads listed
above:==================================================="Thread-3":	at
org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.close(DFSClient.java:3582)	- waiting to
lock &lt;0x0000000107a0ded0&gt; (a org.apache.hadoop.hdfs.DFSClient$DFSOutputStream)	at
org.apache.hadoop.hdfs.DFSClient$LeaseChecker.close(DFSClient.java:1175)	- locked
&lt;0x00000001082b0748&gt; (a org.apache.hadoop.hdfs.DFSClient$LeaseChecker)	at
org.apache.hadoop.hdfs.DFSClient.close(DFSClient.java:306)	- locked
&lt;0x000000010824d640&gt; (a org.apache.hadoop.hdfs.DFSClient)        - waiting to lock
&lt;0x0000000107a0ded0&gt; (a org.apache.hadoop.hdfs.DFSClient$DFSOutputStream)        at
org.apache.hadoop.hdfs.DFSClient$LeaseChecker.close(DFSClient.java:1175)        - locked
&lt;0x00000001082b0748&gt; (a org.apache.hadoop.hdfs.DFSClient$LeaseChecker)        at
org.apache.hadoop.hdfs.DFSClient.close(DFSClient.java:306)        - locked
&lt;0x000000010824d640&gt; (a org.apache.hadoop.hdfs.DFSClient)        at
org.apache.hadoop.hdfs.DistributedFileSystem.close(DistributedFileSystem.java:325)       
at org.apache.hadoop.fs.FileSystem$Cache.closeAll(FileSystem.java:1835)        - locked
&lt;0x0000000107a77ec8&gt; (a org.apache.hadoop.fs.FileSystem$Cache)        at
org.apache.hadoop.fs.FileSystem$Cache$ClientFinalizer.run(FileSystem.java:1851)        -
locked &lt;0x00000001079daa00&gt; (a
org.apache.hadoop.fs.FileSystem$Cache$ClientFinalizer)"main":        at
org.apache.hadoop.hdfs.DFSClient$LeaseChecker.remove(DFSClient.java:1151)        - waiting
to lock &lt;0x00000001082b0748&gt; (a org.apache.hadoop.hdfs.DFSClient$LeaseChecker)      
 at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.close(DFSClient.java:3609)        -
locked &lt;0x0000000107a0ded0&gt; (a org.apache.hadoop.hdfs.DFSClient$DFSOutputStream)    
   at
org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:61)   
    at org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:86)        at
org.apache.hadoop.hdfs.TestFileAppend4.testAppend(TestFileAppend4.java:99)        at
sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)        at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)        at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)     
  at java.lang.reflect.Method.invoke(Method.java:597)        at
junit.framework.TestCase.runTest(TestCase.java:168)        at
junit.framework.TestCase.runBare(TestCase.java:134)        at
junit.framework.TestResult$1.protect(TestResult.java:110)        at
junit.framework.TestResult.runProtected(TestResult.java:128)        at
junit.framework.TestResult.run(TestResult.java:113)        at
junit.framework.TestCase.run(TestCase.java:124)        at
junit.framework.TestSuite.runTest(TestSuite.java:232)        at
junit.framework.TestSuite.run(TestSuite.java:227)        at
junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)        at
junit.extensions.TestSetup$1.protect(TestSetup.java:23)        at
junit.framework.TestResult.runProtected(TestResult.java:128)        at
junit.extensions.TestSetup.run(TestSetup.java:27)        at
org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:420)
       at
org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:911)
       at
org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:768)</pre></div></div> 

-----------------

-----------------
Comments: 

New Comment: 
Here is patch that changes LeaseChecker.close() so that it does not require a lock on
LeaseChecker to close a file output stream. 


New Comment: 
+1 for the patch. Since the existing test caught this, this need not have a separate test
right? 


New Comment: 
-1 overall.  Here are the results of testing the latest attachment <br/>  <a
href="http://issues.apache.org/jira/secure/attachment/12422869/deadlock.patch"
class="external-link"
rel="nofollow">http://issues.apache.org/jira/secure/attachment/12422869/deadlock.patch</a><br/>
 against trunk revision 828900.    +1 @author.  The patch does not contain any @author
tags.    -1 tests included.  The patch doesn't appear to include any new or modified
tests.<br/>                        Please justify why no new tests are needed for this
patch.<br/>                        Also please list what manual steps were performed to
verify this patch.    +1 javadoc.  The javadoc tool did not generate any warning messages.
   +1 javac.  The applied patch does not increase the total number of javac compiler
warnings.    +1 findbugs.  The patch does not introduce any new Findbugs warnings.    +1
release audit.  The applied patch does not increase the total number of release audit
warnings.    -1 core tests.  The patch failed core unit tests.    +1 contrib tests.  The
patch passed contrib unit tests.Test results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/testReport/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/testReport/</a><br/>Findbugs
warnings: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html</a><br/>Checkstyle
results: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/artifact/trunk/build/test/checkstyle-errors.html"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/artifact/trunk/build/test/checkstyle-errors.html</a><br/>Console
output: <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/console"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/53/console</a>This
message is automatically generated. 


New Comment: 
Integrated in Hadoop-Hdfs-trunk-Commit #83 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/83/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/83/</a>)<br/>
   . Fix deadlock in DFSClient#DFSOutputStream. Contributed by Hairong Kuang. 


New Comment: 
Integrated in Hadoop-Hdfs-trunk-Commit #84 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/84/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/84/</a>)<br/>
   Move the change log of  from section 0.21 to section 0.20.2 


New Comment: 
Integrated in Hdfs-Patch-h2.grid.sp2.yahoo.net #61 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/61/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/61/</a>)<br/>
   Move the change log of  from section 0.21 to section 0.20.2<br/>. Fix deadlock in
DFSClient#DFSOutputStream. Contributed by Hairong Kuang. 


New Comment: 
Here is the patch for 0.21. 


New Comment: 
I identified this bug when I ran the test in <a
href="https://issues.apache.org/jira/browse/HDFS-728" title="Create a comprehensive
functional test for append" class="issue-link"
data-issue-key="HDFS-728"><del>HDFS-728</del></a>. With this patch, the test can run
through.In branch 0.20, TestDatanodeBlockScanner times out with or without my fix. I filed
<a href="https://issues.apache.org/jira/browse/HDFS-734" title="TestDatanodeBlockScanner
times out in branch 0.20" class="issue-link"
data-issue-key="HDFS-734"><del>HDFS-734</del></a> to track this. 


New Comment: 
I've committed this! 


New Comment: 
Integrated in Hdfs-Patch-h5.grid.sp2.yahoo.net #78 (See <a
href="http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/78/"
class="external-link"
rel="nofollow">http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/78/</a>) 


