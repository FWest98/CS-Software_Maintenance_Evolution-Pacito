Pattern changes caused by commit: 5310620826fadd5f68975feb77e01d87b386b19a

From: Facade-1
To:   Facade-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5168.txt 

commit 5310620826fadd5f68975feb77e01d87b386b19a
Author: Jonathan Ellis <jbellis@apache.org>

    close scrubbed sstable fd before deleting it
    patch by jbellis; reviewed by slebresne for CASSANDRA-3318



==================================
 Issue CASSANDRA-3318 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3318] Unable to delete after running scrub
-----------------

-----------------
Summary: Unable to delete after running scrub
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 5 Oct 2011 14:21:03 +0000
-----------------

-----------------
Resolved at: Thu, 6 Oct 2011 15:22:05 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

Another problem with sstable deletions on 1.0. Running scrub produces lot of unable to
delete messages on windows.

ERROR 16:16:37,562 Unable to delete
\var\lib\cassandra\data\test\sipdb-h-711-Dat<br/>a.db (it will be removed on server
restart; we'll also retry after GC)<br/> INFO 16:16:37,577 Scrub of
SSTableReader(path='\var\lib\cassandra\data\test\sip<br/>db-h-711-Data.db') complete:
48396 rows in new sstable and 0 empty (tombstoned)<br/>rows dropped
 

-----------------

-----------------
Comments: 

New Comment: 
Is 711 a pre-scrub or post-scrub sstable? 


New Comment: 
Suspect this also affects 0.7 and 0.8. 


New Comment: 
 INFO 23:05:39,845 Scrub of
SSTableReader(path='\var\lib\cassandra\data\system\S<br/>chema-h-10-Data.db') complete: 8
rows in new sstable and 0 empty (tombstoned) ro<br/>ws dropped<br/>ERROR 23:05:39,845
Unable to delete \var\lib\cassandra\data\system\Schema-h-10-D<br/>ata.db (it will be
removed on server restart; we'll also retry after GC)its table after scrub is finished. 


New Comment: 
that means it's the sstable from before scrub.patch attached to close the readers before
replacing the old sstable with the new one.(the diff is intimidating but it's mostly
indentation changes from combining two try/finally blocks.  recommend using a "smart" diff
tool like intellij's, post-patch application.) 


New Comment: 
(patch is against trunk) 


New Comment: 
+1 


New Comment: 
I'm only going to commit this to 1.0 after all, because before that our
PhantomReference-based deleting is very unlikely to run into this problem, so I'm going to
let the stable releases stay stable. 


