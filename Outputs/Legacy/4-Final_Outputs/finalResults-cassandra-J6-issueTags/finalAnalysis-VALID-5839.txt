Pattern changes caused by commit: 7c374547793c30f62366b2a28a2ca2c1d914f146

From: Facade-1
To:   Facade-0

From: Flyweight-3
To:   Flyweight-4


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5839.txt 

commit 7c374547793c30f62366b2a28a2ca2c1d914f146
Author: Pavel Yaskevich <povel.y@gmail.com>

    fixes NPE exception in ClientState.hasKeyspaceSchemaAccess(...) method introduced by CASSANDRA-3759



==================================
 Issue CASSANDRA-3759 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3759] [patch] don't allow dropping the system keyspace
-----------------

-----------------
Summary: [patch] don't allow dropping the system keyspace
-----------------

-----------------
Issue type: Improvement
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 20 Jan 2012 07:18:06 +0000
-----------------

-----------------
Resolved at: Tue, 24 Jan 2012 20:33:30 +0000
-----------------

-----------------
Assigned to: David Brosius
-----------------

-----------------
Description: 

throw an IRE if user attempts to drop system keyspace
 

-----------------

-----------------
Comments: 

New Comment: 
Can we put this somewhere else (maybe ClientState.hasKeyspaceSchemaAccess) so that CQL and
Thrift go through the same code path?  We have something similar in
hasColumnFamilySchemaAccess:<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">.       <span
class="code-comment">// hardcode disallowing messing with system keyspace</span>       
<span class="code-keyword">if</span> (keyspace.equalsIgnoreCase(Table.SYSTEM_TABLE)
&amp;&amp; perm == Permission.WRITE)            <span class="code-keyword">throw</span>
<span class="code-keyword">new</span> InvalidRequestException(<span
class="code-quote">"system keyspace is not user-modifiable"</span>);</pre></div></div> 


New Comment: 
committed patch attachedk to 3755. 


New Comment: 
After this change is applied, it appears it is impossible to create new keyspaces via CQL
on a fresh C* install. I get the "system keyspace is not user-modifiable" message.New
keyspaces can still successfully be created if you can set your current keyspace to
something that is not 'system', but this isn't an option for a new install.Haven't tried
creating via thrift; maybe that still works. 


New Comment: 
fixes NPE exception in hasKeyspaceSchemaAccess(...) because keyspace is not required to be
always set. 


New Comment: 
+1 


New Comment: 
Committed. 


New Comment: 
Pavel's patch may fix a possible NPE, but it doesn't solve my problem- the new "system
keyspace is not user-modifiable" check and message still stop me from creating keyspaces
on a new installation. 


New Comment: 
<blockquote>New keyspaces can still successfully be created if you can set your current
keyspace to something that is not 'system', but this isn't an option for a new
install</blockquote>We require keyspace to be set, to create keyspaces? 


New Comment: 
<blockquote>We require keyspace to be set, to create keyspaces?</blockquote>I would hope
not. We didn't before. 


New Comment: 
I have tested my patch on the new installation and it allows to create keyspace without
already using one (which was throwing NPE before). This is also indicated by CliTest - it
was failing before. 


New Comment: 
Looks like the patch fixed thrift (and thereby cli). CQL still broken. 


New Comment: 
this happens because cqlsh uses system keyspace by default, I'm going to add new parameter
to the hasKeyspaceSchemaAccess(...) method to identify if that is keyspace what gets
created or not. 


New Comment: 
removed validation from ClientState.hasKeyspaceSchemaAccess(...) and placed it to the
dedicated ThriftValidation.validateKeyspaceNotSystem(String), fixes create/drop/update
keyspaces different from system when inside of that keyspace. 


New Comment: 
+1 


New Comment: 
Committed. 


New Comment: 
Does this mean we can drop system keyspace from cql now? 


