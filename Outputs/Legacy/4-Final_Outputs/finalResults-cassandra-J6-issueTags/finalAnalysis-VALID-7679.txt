Pattern changes caused by commit: b8874ad1a892cfc45c87ed1187d43df356f48315

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-7679.txt 

commit b8874ad1a892cfc45c87ed1187d43df356f48315
Author: Yuki Morishita <yukim@apache.org>

    fix wrong leveled compaction progress calculation; patch by yukim reviewed by jbellis for CASSANDRA-4807



==================================
 Issue CASSANDRA-4807 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4807] Compaction progress counts more than 100%
-----------------

-----------------
Summary: Compaction progress counts more than 100%
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Mon, 15 Oct 2012 15:10:38 +0000
-----------------

-----------------
Resolved at: Tue, 16 Oct 2012 23:12:03 +0000
-----------------

-----------------
Assigned to: Yuki Morishita
-----------------

-----------------
Description: 

'nodetool compactionstats' compaction progress counts more than 100%:
<div class="code
panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">pending tasks: 74          compaction type        keyspace   column
family bytes compacted     bytes total  progress               Validation        KSP      
 CF1           56192578305         84652768917    66.38%               Compaction       
KSP        CF2           162018591           119913592    
135.11%</pre></div></div>
Hadn't experienced this before 1.1.3. Is it due to changes in
1.1.4-1.1.6 ?
 

-----------------

-----------------
Comments: 

New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omid"
class="user-hover" rel="omid">Omid Aladini</a> What compaction strategy are you using? Do
you turn on multithreaded compaction? 


New Comment: 
Yuki, I've seen that too. I've used the following configs:<ul>	<li>LCS with singlethreaded
compaction (CompactionIterable).</li>	<li>snappy compression with chunk_length_kb =
32.</li>	<li>Cassandra 1.1.4.</li></ul> 


New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim"
class="user-hover" rel="yukim">Yuki Morishita</a> LCS with snappy with chunk_length_kb =
64, sstable_size_in_mb = 10 and multithreaded compaction disabled on Cassandra 1.1.6. 


New Comment: 
Alexey, Omid,Thank you both for providing information.<br/>I think this regression comes
from <a href="https://issues.apache.org/jira/browse/CASSANDRA-4587"
title="StackOverflowError in LeveledCompactionStrategy$LeveledScanner.computeNext"
class="issue-link"
data-issue-key="CASSANDRA-4587"><del>CASSANDRA-4587</del></a>.<br/>compactionstats' bytes
compacted comes from LeveledScanner#getCurrentPosition(<a
href="https://github.com/apache/cassandra/blob/cassandra-1.1.6/src/java/org/apache/cassandra/db/compaction/LeveledCompactionStrategy.java#L261"
class="external-link"
rel="nofollow">https://github.com/apache/cassandra/blob/cassandra-1.1.6/src/java/org/apache/cassandra/db/compaction/LeveledCompactionStrategy.java#L261</a>)
when using LCS.We need to reset currentScanner to null after scanning through to the end,
otherwise we would add twice for last scanned SSTable.Patch attached as well as unit test
for this.<br/>(github: <a href="https://github.com/yukim/cassandra/tree/4807"
class="external-link" rel="nofollow">https://github.com/yukim/cassandra/tree/4807</a>) 


New Comment: 
LGTM, +1.When committing, can you add a comment to the computeNext code explaining why we
set to null? 


New Comment: 
Thanks Yuki. It also probably affects compaction throttling, by throttling more than it
should (<a
href="https://github.com/apache/cassandra/blob/cassandra-1.1.6/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L612"
class="external-link"
rel="nofollow">https://github.com/apache/cassandra/blob/cassandra-1.1.6/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L612</a>) 


