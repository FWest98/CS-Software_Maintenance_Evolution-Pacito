Pattern changes caused by commit: 39dd8550194676766a260e4bc92edebf17cf8162

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1

From: Template Method-3
To:   Template Method-2


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-6822.txt 

commit 39dd8550194676766a260e4bc92edebf17cf8162
Author: Jonathan Ellis <jbellis@apache.org>

    fix split generation regression
    patch by Bartomiej Romaski; reviewed by jbellis for CASSANDRA-4259



==================================
 Issue CASSANDRA-4259 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4259] Bug in SSTableReader.getSampleIndexesForRanges(...) causes uneven InputSplits generation for Hadoop mappers
-----------------

-----------------
Summary: Bug in SSTableReader.getSampleIndexesForRanges(...) causes uneven InputSplits generation for Hadoop mappers
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Fri, 18 May 2012 17:07:26 +0000
-----------------

-----------------
Resolved at: Sat, 19 May 2012 22:35:25 +0000
-----------------

-----------------
Assigned to: Bartłomiej Romański
-----------------

-----------------
Description: 

Running a simple mapreduce job on cassandra column family results in creating multiple
small mappers for one half of the ring and one big mapper for the other half. Upper part
(85... - 0) is cut into smaller slices. Lower part (0 - 85...) generates one big input
slice. One mapper processing half of the ring causes huge inefficiency. Also the progress
meter for this mapper is incorrect - it goes to 100% in a couple of seconds, than stays at
100% for an hour or two.

I've investigated the problem a bit. I think it is related to
incorrect output of 'nodetool rangekeysample'. On the node resposible for part (0 - 85...)
the output is empty! On the other node it works fine.

I think the bug is in
SSTableReader.getSampleIndexesForRanges(...). These two lines:

   RowPosition
leftPosition = range.left.maxKeyBound();<br/>   RowPosition rightPosition =
range.left.maxKeyBound();

should be changed to:

   RowPosition leftPosition =
range.left.maxKeyBound();<br/>   RowPosition rightPosition =
range.right.maxKeyBound();

After that fix the output of nodetool is correct and the whole
ring is split into small mappers.

The other half of the ring works fine because of extra
'if' in the code:

   int right = Range.isWrapAround(range.left, range.right)...

This
causes that the bug does not show up in one-node cluster or in the "last" ring partition
in muli-node clusters.

Can anyone look at it and verify my thoughts? I'm rather new to
Cassandra.
 

-----------------

-----------------
Comments: 

New Comment: 
Good detective work! Committed, thanks. 


