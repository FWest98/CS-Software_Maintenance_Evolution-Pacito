Pattern changes caused by commit: 945853076c44d071ba5b554ecb69a080e5719d32

From: Abstract Factory-2
To:   Abstract Factory-1

From: Factory Method-2
To:   Factory Method-1

From: Decorator-1
To:   Decorator-2

From: Facade-1
To:   Facade-0

From: Flyweight-1
To:   Flyweight-2

From: Mediator-1
To:   Mediator-3

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-8387.txt 

commit 945853076c44d071ba5b554ecb69a080e5719d32
Author: Brandon Williams <brandonwilliams@apache.org>

    Handle states for non-vnode clusters correctly.
    Patch by brandonwilliams reviewed by slebresne for CASSANDRA-5127



==================================
 Issue CASSANDRA-5127 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-5127] unsafeAssassinateEndpoint throws NullPointerException and fails to remove node from gossip
-----------------

-----------------
Summary: unsafeAssassinateEndpoint throws NullPointerException and fails to remove node from gossip
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 8 Jan 2013 03:28:24 +0000
-----------------

-----------------
Resolved at: Tue, 8 Jan 2013 19:26:56 +0000
-----------------

-----------------
Assigned to: Brandon Williams
-----------------

-----------------
Description: 

unsafeAssassinateEndpoint() throws NullPointerException and the node still seems to be in
gossip. 

gossip info for node in question:
<div class="code panel" style="border-width:
1px;"><div class="codeContent panelContent"><pre class="code-java">/10.8.30.15 
HOST_ID:d84a5632-d6d5-4b06-8e1b-ae39ab185ca1  RPC_ADDRESS:0.0.0.0  RACK:RAC1  DC:DC1 
REMOVAL_COORDINATOR:REMOVER,b63fe173-5d13-4905-a59f-a78790f4f980  RELEASE_VERSION:1.2.0 
NET_VERSION:6  LOAD:2.64185473948E11 
STATUS:removed,d84a5632-d6d5-4b06-8e1b-ae39ab185ca1,1357874470406 
SCHEMA:5cd8420d-ce3c-3625-8293-67558a24816b</pre></div></div><div class="code panel"
style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">ERROR 19:26:20,078 Exception in thread <span
class="code-object">Thread</span>[GossipStage:1,5,main]java.lang.NullPointerException	at
org.apache.cassandra.service.StorageService.getApplicationStateValue(StorageService.java:1192)	at
org.apache.cassandra.service.StorageService.getTokensFor(StorageService.java:1200)	at
org.apache.cassandra.service.StorageService.handleStateLeft(StorageService.java:1452)	at
org.apache.cassandra.service.StorageService.onChange(StorageService.java:1163)	at
org.apache.cassandra.service.StorageService.onJoin(StorageService.java:1895)	at
org.apache.cassandra.gms.Gossiper.handleMajorStateChange(Gossiper.java:805)	at
org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:856)	at
org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(GossipDigestAckVerbHandler.java:57)	at
org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)	at
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)	at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)	at
java.lang.<span class="code-object">Thread</span>.run(<span
class="code-object">Thread</span>.java:722)</pre></div></div> 

-----------------

-----------------
Comments: 

New Comment: 
This is because there is no TOKENS state for a non-vnode host in 1.2.  Mostly saying this
for myself so I don't forget what to do tomorrow. 


New Comment: 
Hmm, to clarify, the stacktrace you're posting is from a node receiving the assassinate
attempt? Because that stack doesn't point at uAE itself. 


New Comment: 
node i'm trying to assassinate is down. Stacktrace is from the node I executed uAE on. 


New Comment: 
<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java"> WARN [RMI TCP Connection(3166)-10.8.240.170]
2013-01-08 07:42:02,143 Gossiper.java (line 419) Assassinating /10.8.30.15 via gossip INFO
[RMI TCP Connection(3166)-10.8.240.170] 2013-01-08 07:42:02,144 Gossiper.java (line 434)
Sleeping <span class="code-keyword">for</span> 30000ms to ensure /10.8.30.15 does not
change INFO [RMI TCP Connection(3166)-10.8.240.170] 2013-01-08 07:42:32,416 Gossiper.java
(line 767) InetAddress /10.8.30.15 is now dead.</pre></div></div>so that looks
okay.jconsole threw "Problem invoking unsafeAssassinateEndpoint:
java.lang.NullPointerException"<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">/10.8.30.15  DC:DC1 
SCHEMA:5cd8420d-ce3c-3625-8293-67558a24816b  RELEASE_VERSION:1.2.0 
REMOVAL_COORDINATOR:REMOVER,b63fe173-5d13-4905-a59f-a78790f4f980  LOAD:2.64185473948E11 
STATUS:LEFT,1357918952416,21210815907080254728491917739023519863  RPC_ADDRESS:0.0.0.0 
NET_VERSION:6  HOST_ID:d84a5632-d6d5-4b06-8e1b-ae39ab185ca1 
RACK:RAC1</pre></div></div>node is still in gossipinfo though..I assumed that stack trace
which happened at the same time correlated to the npe. 


New Comment: 
logs from another node in the cluster (aka didn't execute the jmx call and is not the
downed node.<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java"> INFO [GossipStage:1] 2013-01-08 07:42:33,258
Gossiper.java (line 767) InetAddress /10.8.30.15 is now dead.ERROR [GossipStage:1]
2013-01-08 07:42:33,267 CassandraDaemon.java (line 133) Exception in thread <span
class="code-object">Thread</span>[GossipStage:1,5,main]java.lang.NullPointerException     
  at
org.apache.cassandra.service.StorageService.getApplicationStateValue(StorageService.java:1192)
       at
org.apache.cassandra.service.StorageService.getTokensFor(StorageService.java:1200)       
at org.apache.cassandra.service.StorageService.handleStateLeft(StorageService.java:1452)  
     at org.apache.cassandra.service.StorageService.onChange(StorageService.java:1163)    
   at org.apache.cassandra.service.StorageService.onJoin(StorageService.java:1895)       
at org.apache.cassandra.gms.Gossiper.handleMajorStateChange(Gossiper.java:805)        at
org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:856)        at
org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(GossipDigestAckVerbHandler.java:57)
       at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)   
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) 
      at java.lang.<span class="code-object">Thread</span>.run(<span
class="code-object">Thread</span>.java:662)ERROR [GossipStage:2] 2013-01-08 07:42:35,274
CassandraDaemon.java (line 133) Exception in thread <span
class="code-object">Thread</span>[GossipStage:2,5,main]java.lang.NullPointerException     
  at
org.apache.cassandra.service.StorageService.getApplicationStateValue(StorageService.java:1192)
       at
org.apache.cassandra.service.StorageService.getTokensFor(StorageService.java:1200)       
at org.apache.cassandra.service.StorageService.handleStateLeft(StorageService.java:1452)  
     at org.apache.cassandra.service.StorageService.onChange(StorageService.java:1163)    
   at org.apache.cassandra.gms.Gossiper.doNotifications(Gossiper.java:917)        at
org.apache.cassandra.gms.Gossiper.applyNewStates(Gossiper.java:908)        at
org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:866)        at
org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(GossipDigestAckVerbHandler.java:57)
       at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)   
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) 
      at java.lang.<span class="code-object">Thread</span>.run(<span
class="code-object">Thread</span>.java:662)</pre></div></div> 


New Comment: 
There are a few cases where we assume that if a host has a HOST_ID, then it must use
vnodes, but that is not the case.  Patch attached to refactor these cases into a
usesVnodes method which checks for both HOST_ID and TOKENS. 


New Comment: 
Agreed on the analysis, but I'd rather hide this directly in getTokenFor (i.e. replace the
'<tt>if vnodes then getTokensFor else TokenFactory.fromString(pieces<span
class="error">&#91;1&#93;</span>)</tt>' by '<tt>getTokenFor(endpoing, pieces<span
class="error">&#91;1&#93;</span>)</tt>' and handle the backward compatibility inside
getTokenFor.In particular, and though that's a nit, I'm not of fan of have a usesVnodes
method because if I'm not mistaken any upgraded would have this method return true even if
only one token is used, right? If so, I'm afraid the method would be misleading. 


New Comment: 
v2 consolidates everything into getTokensFor.<blockquote>I'm not of fan of have a
usesVnodes method because if I'm not mistaken any upgraded would have this method return
true even if only one token is used</blockquote>Not quite, to have the TOKENS app state
you must be on vnodes.  If there's only one token it's handled the old, ugly way by
splitting the STATUS state. 


New Comment: 
+1 on v2, though I still don't like the usesVnodes method name (basically I don't want
anyone starting to use it for anything else than what getTokenFor is doing, which for me
qualify as 'it shouldn't exist') but that's a nit.<blockquote>If there's only one token
it's handled the old, ugly way by splitting the STATUS state.</blockquote>I would suggest
handling the one token case by feeding both the STATUS state <b>and</b> the new TOKENS
state so that in some future version we can just remove the STATUS old ugly way, but
that's work for another ticket in any case. 


New Comment: 
Committed 


