Pattern changes caused by commit: 83f9f455d76ec831666f8ed6d6dcbe811145e830

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-4448.txt 

commit 83f9f455d76ec831666f8ed6d6dcbe811145e830
Author: Jonathan Ellis <jbellis@apache.org>

    avoid including inferred types in CFupdate
    patch by pyaskevich; reviewed by jbellis for CASSANDRA-2809



==================================
 Issue CASSANDRA-2809 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2809] In the Cli, update column family <cf> with comparator; create Column metadata
-----------------

-----------------
Summary: In the Cli, update column family <cf> with comparator; create Column metadata
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 22 Jun 2011 12:54:13 +0000
-----------------

-----------------
Resolved at: Sun, 17 Jul 2011 14:13:54 +0000
-----------------

-----------------
Assigned to: Pavel Yaskevich
-----------------

-----------------
Description: 

Using cassandra-cli, I can't update the comparator of a column family with the type I
want and when I did it with BytesType, Column metadata appear for each of my existing
columns.<br/>Step to reproduce:
<div class="code panel" style="border-width: 1px;"><div
class="codeContent panelContent"><pre class="code-java">[<span
class="code-keyword">default</span>@unknown] create keyspace Test    with
placement_strategy = <span
class="code-quote">'org.apache.cassandra.locator.SimpleStrategy'</span>    and
strategy_options = [{replication_factor:1}];[<span
class="code-keyword">default</span>@unknown] use Test;Authenticated to keyspace:
Test[<span class="code-keyword">default</span>@Test] create column family test;[<span
class="code-keyword">default</span>@Test] describe keyspace;...    ColumnFamily: test     
Key Validation <span class="code-object">Class</span>:
org.apache.cassandra.db.marshal.BytesType      Default column value validator:
org.apache.cassandra.db.marshal.BytesType      Columns sorted by:
org.apache.cassandra.db.marshal.BytesType      Row cache size / save period in seconds:
0.0/0      Key cache size / save period in seconds: 200000.0/14400      Memtable
thresholds: 0.571875/122/1440 (millions of ops/MB/minutes)      GC grace seconds: 864000  
   Compaction min/max thresholds: 4/32      Read repair chance: 1.0      Replicate on
write: <span class="code-keyword">false</span>      Built indexes: []...[<span
class="code-keyword">default</span>@Test] update column family test with comparator =
<span class="code-quote">'LongType'</span>;comparators <span
class="code-keyword">do</span> not match.</pre></div></div>
why?? the CF is empty
<div
class="code panel" style="border-width: 1px;"><div class="codeContent panelContent"><pre
class="code-java">[<span class="code-keyword">default</span>@Test] update column family
test with comparator = <span
class="code-quote">'BytesType'</span>;f8e4dcb0-9cca-11e0-0000-d0583497e7ffWaiting <span
class="code-keyword">for</span> schema agreement...... schemas agree across the
cluster[<span class="code-keyword">default</span>@Test] describe keyspace;...   
ColumnFamily: test      Key Validation <span class="code-object">Class</span>:
org.apache.cassandra.db.marshal.BytesType      Default column value validator:
org.apache.cassandra.db.marshal.BytesType      Columns sorted by:
org.apache.cassandra.db.marshal.BytesType      Row cache size / save period in seconds:
0.0/0      Key cache size / save period in seconds: 200000.0/14400      Memtable
thresholds: 0.571875/122/1440 (millions of ops/MB/minutes)      GC grace seconds: 864000  
   Compaction min/max thresholds: 4/32      Read repair chance: 1.0      Replicate on
write: <span class="code-keyword">false</span>      Built indexes: []...[<span
class="code-keyword">default</span>@Test] set test[ascii(<span
class="code-quote">'row1'</span>)][<span
class="code-object">long</span>(1)]=integer(35);set test[ascii(<span
class="code-quote">'row1'</span>)][<span
class="code-object">long</span>(2)]=integer(36);set test[ascii(<span
class="code-quote">'row1'</span>)][<span
class="code-object">long</span>(3)]=integer(38);set test[ascii(<span
class="code-quote">'row2'</span>)][<span
class="code-object">long</span>(1)]=integer(45);set test[ascii(<span
class="code-quote">'row2'</span>)][<span
class="code-object">long</span>(2)]=integer(42);set test[ascii(<span
class="code-quote">'row2'</span>)][<span
class="code-object">long</span>(3)]=integer(33);[<span
class="code-keyword">default</span>@Test] list test;Using <span
class="code-keyword">default</span> limit of 100-------------------RowKey: 726f7731=&gt;
(column=0000000000000001, value=35, timestamp=1308744931122000)=&gt;
(column=0000000000000002, value=36, timestamp=1308744931124000)=&gt;
(column=0000000000000003, value=38, timestamp=1308744931125000)-------------------RowKey:
726f7732=&gt; (column=0000000000000001, value=45, timestamp=1308744931127000)=&gt;
(column=0000000000000002, value=42, timestamp=1308744931128000)=&gt;
(column=0000000000000003, value=33, timestamp=1308744932722000)2 Rows Returned.[<span
class="code-keyword">default</span>@Test] update column family test with comparator =
<span class="code-quote">'LongType'</span>;comparators <span
class="code-keyword">do</span> not match.</pre></div></div>
same question than before, my
columns contains only long, why I can't?
<div class="code panel" style="border-width:
1px;"><div class="codeContent panelContent"><pre class="code-java">[<span
class="code-keyword">default</span>@Test] update column family test with comparator =
<span class="code-quote">'BytesType'</span>;[<span
class="code-keyword">default</span>@Test] describe keyspace;                              
       Keyspace: Test:  Replication Strategy: org.apache.cassandra.locator.SimpleStrategy 
  Options: [replication_factor:1]  Column Families:    ColumnFamily: test      Key
Validation <span class="code-object">Class</span>:
org.apache.cassandra.db.marshal.BytesType      Default column value validator:
org.apache.cassandra.db.marshal.BytesType      Columns sorted by:
org.apache.cassandra.db.marshal.BytesType      Row cache size / save period in seconds:
0.0/0      Key cache size / save period in seconds: 200000.0/14400      Memtable
thresholds: 0.571875/122/1440 (millions of ops/MB/minutes)      GC grace seconds: 864000  
   Compaction min/max thresholds: 4/32      Read repair chance: 1.0      Replicate on
write: <span class="code-keyword">false</span>      Built indexes: []      Column
Metadata:        Column Name:  (0000000000000001)          Validation <span
class="code-object">Class</span>: org.apache.cassandra.db.marshal.IntegerType       
Column Name:  (0000000000000003)          Validation <span
class="code-object">Class</span>: org.apache.cassandra.db.marshal.IntegerType       
Column Name:  (0000000000000002)          Validation <span
class="code-object">Class</span>:
org.apache.cassandra.db.marshal.IntegerType</pre></div></div>
Column Metadata appear from
nowhere. I don't think that it's expected.
 

-----------------

-----------------
Comments: 

New Comment: 
Changing comparators is not allowed, since the point of a comparator is that data within a
row will be sorted on disk by the comparator's ordering.  Changing the comparator without
rewriting the data would corrupt the sstable.Not sure where that column_metadata comes
from though.  Looks like a bug. 


New Comment: 
Noticed that update_cf doesn't validate the given CFMetaData.  patch to add this.  (Does
not address the column_metadata problem.) 


New Comment: 
That column metadata is a feature: when you use a function call in SET statement it is
storing information about validation class for individual columns locally (without sync
with server) that was added in context of <a
href="https://issues.apache.org/jira/browse/CASSANDRA-1635" title="cli not picking up type
annotation on set" class="issue-link"
data-issue-key="CASSANDRA-1635"><del>CASSANDRA-1635</del></a>. +1 of validate patch. 


New Comment: 
Committed. 


New Comment: 
<blockquote>That column metadata is a feature: when you use a function call in SET
statement it is storing information about validation class for individual columns
locally</blockquote>Ah, I remember that.  But this shouldn't show up in a describe
keyspace or we cause the above confusion. <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/smile.png" height="16"
width="16" align="absmiddle" alt="" border="0"/> 


New Comment: 
How should it be stored on your opinion? 


New Comment: 
I'd probably keep a "local" CFMetadata around and check that first. 


New Comment: 
Integrated in Cassandra-0.8 #216 (See <a
href="https://builds.apache.org/job/Cassandra-0.8/216/" class="external-link"
rel="nofollow">https://builds.apache.org/job/Cassandra-0.8/216/</a>)<br/>    cli validates
CFMetaData on update.<br/>Patch by jbellis, reviewed by Pavel Yaskevich for <a
href="https://issues.apache.org/jira/browse/CASSANDRA-2809" title="In the Cli, update
column family &lt;cf&gt; with comparator; create Column metadata" class="issue-link"
data-issue-key="CASSANDRA-2809"><del>CASSANDRA-2809</del></a>brandonwilliams : <a
href="http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1147261"
class="external-link"
rel="nofollow">http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1147261</a><br/>Files
:
<ul>	<li>/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/thrift/CassandraServer.java</li></ul> 


New Comment: 
I took a look the code now and what I see is that describe keyspace always calling
`thrift.describe_keyspace()` but in the example after adding rows you did a successful
"update column family test with comparator = 'BytesType';" which persisted changes in
column metadata. I think this is actually a good thing to have we just need to document
that, what do you think, Jonathan? 


New Comment: 
To make sure we're on the same page, here's what I'm talking about:<div
class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent
panelContent"><pre>      Column Metadata:        Column Name:  (0000000000000001)         
Validation Class: org.apache.cassandra.db.marshal.IntegerType        Column Name: 
(0000000000000003)</pre></div></div>We shouldn't be persisting that or showing it to the
user as part of describe keyspace. 


New Comment: 
Ok, I will attach a patch fixing this in a few. 


New Comment: 
patch for version 0.7 but can be applied on 0.8 also. 


New Comment: 
does this fix the describe problem too, or just the update one? 


New Comment: 
Describe too. 


New Comment: 
committed 


