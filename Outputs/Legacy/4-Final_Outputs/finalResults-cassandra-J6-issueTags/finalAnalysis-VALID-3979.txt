Pattern changes caused by commit: 5f8991c73a6f43fbe9c7e0d8906e751c21d54412

From: Abstract Factory-3
To:   Abstract Factory-2

From: Factory Method-3
To:   Factory Method-2

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-3979.txt 

commit 5f8991c73a6f43fbe9c7e0d8906e751c21d54412
Author: Jonathan Ellis <jbellis@apache.org>

    recognize attempt todrop just the index while leaving the column definition
    patch by jbellis; reviewed by brandonwilliams for CASSANDRA-2619



==================================
 Issue CASSANDRA-2619 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2619] secondary index not dropped until restart
-----------------

-----------------
Summary: secondary index not dropped until restart
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Sat, 7 May 2011 00:36:24 +0000
-----------------

-----------------
Resolved at: Mon, 9 May 2011 07:09:24 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

when dropping the secondary index (via cassandra-cli), the describe keyspace still shows
the Built index entry. Only after a restart of the CassandraDaemon then the Built Index
entry is gone. This seems indicate a problem with the index not really been dropped
completed.

to test, use a single node, create an index, then drop it from the cli (issue
an update column family ... with metadata fields but not the index info)

below is the
original:

  Column Families:<br/>    ColumnFamily: inode<br/>    "Stores file meta
data"<br/>      Key Validation Class: org.apache.cassandra.db.marshal.BytesType<br/>     
Default column value validator: org.apache.cassandra.db.marshal.BytesType<br/>     
Columns sorted by: org.apache.cassandra.db.marshal.BytesType<br/>      Row cache size /
save period in seconds: 0.0/0<br/>      Key cache size / save period in seconds:
0.0/14400<br/>      Memtable thresholds: 0.103125/22/1440 (millions of
ops/MB/minutes)<br/>      GC grace seconds: 60<br/>      Compaction min/max thresholds:
4/32<br/>      Read repair chance: 1.0<br/>      Replicate on write: false<br/>      <font
color="red">Built indexes: <span class="error">&#91;inode.path,
inode.sentinel&#93;</span></font><br/>      Column Metadata:<br/>        Column Name: path
(70617468)<br/>          Validation Class: org.apache.cassandra.db.marshal.BytesType<br/> 
        <font color="red">Index Name: path<br/>          Index Type: KEYS</font><br/>     
  Column Name: sentinel (73656e74696e656c)<br/>          Validation Class:
org.apache.cassandra.db.marshal.BytesType<br/>          <font color="red">Index Name:
sentinel<br/>          Index Type: KEYS</font>

issue an update:
<div class="preformatted
panel" style="border-width: 1px;"><div class="preformattedContent
panelContent"><pre>[default@unknown] use cfs;Authenticated to keyspace: cfs[default@cfs]
update column family inode with comparator=BytesType and
column_metadata=[{column_name:70617468, validation_class:BytesType},
{column_name:73656e74696e656c,validation_class:BytesType}];fca46d00-783c-11e0-0000-242d50cf1fffWaiting
for schema agreement...... schemas agree across the cluster</pre></div></div>
describe the
keyspace again:<br/>Keyspace: cfs:<br/>  Replication Strategy:
org.apache.cassandra.locator.NetworkTopologyStrategy<br/>    Options: <span
class="error">&#91;Brisk:1, Cassandra:0&#93;</span><br/>  Column Families:<br/>   
ColumnFamily: inode<br/>    "Stores file meta data"<br/>      Key Validation Class:
org.apache.cassandra.db.marshal.BytesType<br/>      Default column value validator:
org.apache.cassandra.db.marshal.BytesType<br/>      Columns sorted by:
org.apache.cassandra.db.marshal.BytesType<br/>      Row cache size / save period in
seconds: 0.0/0<br/>      Key cache size / save period in seconds: 0.0/14400<br/>     
Memtable thresholds: 0.103125/22/1440 (millions of ops/MB/minutes)<br/>      GC grace
seconds: 60<br/>      Compaction min/max thresholds: 4/32<br/>      Read repair chance:
1.0<br/>      Replicate on write: false<br/>      <font color="red">Built indexes: <span
class="error">&#91;inode.path, inode.sentinel&#93;</span></font><br/>      Column
Metadata:<br/>        Column Name: path (70617468)<br/>          Validation Class:
org.apache.cassandra.db.marshal.BytesType<br/>        Column Name: sentinel
(73656e74696e656c)<br/>          Validation Class:
org.apache.cassandra.db.marshal.BytesType

<b>notice the red line on Built
Indexes</b>

restart CassandraDaemon, describe again:

Keyspace: cfs:<br/>  Replication
Strategy: org.apache.cassandra.locator.NetworkTopologyStrategy<br/>    Options: <span
class="error">&#91;Brisk:1, Cassandra:0&#93;</span><br/>  Column Families:<br/>   
ColumnFamily: inode<br/>    "Stores file meta data"<br/>      Key Validation Class:
org.apache.cassandra.db.marshal.BytesType<br/>      Default column value validator:
org.apache.cassandra.db.marshal.BytesType<br/>      Columns sorted by:
org.apache.cassandra.db.marshal.BytesType<br/>      Row cache size / save period in
seconds: 0.0/0<br/>      Key cache size / save period in seconds: 0.0/14400<br/>     
Memtable thresholds: 0.103125/22/1440 (millions of ops/MB/minutes)<br/>      GC grace
seconds: 60<br/>      Compaction min/max thresholds: 4/32<br/>      Read repair chance:
1.0<br/>      Replicate on write: false<br/>      <font color="red">Built indexes:
[]</font><br/>      Column Metadata:<br/>        Column Name: path (70617468)<br/>        
 Validation Class: org.apache.cassandra.db.marshal.BytesType<br/>        Column Name:
sentinel (73656e74696e656c)<br/>          Validation Class:
org.apache.cassandra.db.marshal.BytesType

on another note, upon re-create the index, it
does not appear the index is actually rebuilt. There is no need to restart CassandraDaemon
for the Built Index to show up from the describe. But the update goes very fast. We could
tell the index is not being rebuilt because we were getting NPE from:
<div
class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent
panelContent"><pre>java.lang.RuntimeException: java.lang.NullPointerException	at
org.apache.cassandra.service.IndexScanVerbHandler.doVerb(IndexScanVerbHandler.java:51)	at
org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:72)	at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)	at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)	at
java.lang.Thread.run(Thread.java:662)Caused by: java.lang.NullPointerException	at
org.apache.cassandra.db.ColumnFamilyStore.satisfies(ColumnFamilyStore.java:1647)	at
org.apache.cassandra.db.ColumnFamilyStore.scan(ColumnFamilyStore.java:1594)	at
org.apache.cassandra.service.IndexScanVerbHandler.doVerb(IndexScanVerbHandler.java:42)</pre></div></div>
and
after re-create the index, the exception resurface (the exception does not surface upon
drop).

If we drop the index files and remove them, then re-create the index, the NPE is
resolved: 
<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>$ find /var/lib/cassandra/data/cfs -name
"*path*" -o -name "*sentinel* -exec rm {} \;"</pre></div></div> 

-----------------

-----------------
Comments: 

New Comment: 
Patch attached. There are 3 main things going on here:<ul class="alternate"
type="square">	<li>move DefsTest to config package (so it can access
CFMetaData.column_metadata) and add a test to expose the bug</li>	<li>clarify the
CFMetaData.apply code to make it clear where it's dealing w/ column addition/removal and
not indexes per se (this is where I thought the bug was at first)</li>	<li>the actual fix,
which is the 3 line change to CFS.reload</li></ul>(Note that as a workaround, you can
simply drop the column definition altogether instead of leaving the validator intact while
removing the index type.) 


New Comment: 
NOTE: because svn is retarded, you need to help patch figure out how to apply this, by
first running<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>cp
test/unit/org/apache/cassandra/db/DefsTest.java
test/unit/org/apache/cassandra/config/DefsTest.java</pre></div></div> 


New Comment: 
+1 


New Comment: 
Integrated in Cassandra-0.7 #474 (See <a
href="https://builds.apache.org/hudson/job/Cassandra-0.7/474/" class="external-link"
rel="nofollow">https://builds.apache.org/hudson/job/Cassandra-0.7/474/</a>)<br/>   
recognize attempt todrop just the index while leaving the column definition<br/>patch by
jbellis; reviewed by brandonwilliams for <a
href="https://issues.apache.org/jira/browse/CASSANDRA-2619" title="secondary index not
dropped until restart" class="issue-link"
data-issue-key="CASSANDRA-2619"><del>CASSANDRA-2619</del></a> 


