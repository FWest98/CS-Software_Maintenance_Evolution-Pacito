Pattern changes caused by commit: c5f4f3b2be60652b380806c6928d8ec480d06941

From: Abstract Factory-3
To:   Abstract Factory-2

From: Factory Method-3
To:   Factory Method-2


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-3404.txt 

commit c5f4f3b2be60652b380806c6928d8ec480d06941
Author: Gary Dusbabek <gdusbabek@apache.org>

    initialize localendpoint in gossiper earlier. patch by gdusbabek, reviewed by jbellis. CASSANDRA-2228



==================================
 Issue CASSANDRA-2228 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2228] Race conditions when reinitialisating nodes (OOM + Nullpointer)
-----------------

-----------------
Summary: Race conditions when reinitialisating nodes (OOM + Nullpointer)
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 23 Feb 2011 15:50:49 +0000
-----------------

-----------------
Resolved at: Thu, 3 Mar 2011 22:59:53 +0000
-----------------

-----------------
Assigned to: Gary Dusbabek
-----------------

-----------------
Description: 

I had a corrupt system table which wouldn't compact anymore and I deleted the files and
restarted cassandra and let it take the same token/ip address.

I experienced the same
errors when I'm adding a newly installed node under the same token/ip address before
calling repair.

1)<br/>After a few seconds/minutes, I get a OOM error:

 INFO <span
class="error">&#91;FlushWriter:1&#93;</span> 2011-02-23 16:40:28,958 Memtable.java (line
164) Completed flushing /cassandra/data/system/Schema-f-15-Data.db (8037 bytes)<br/> INFO
<span class="error">&#91;MigrationStage:1&#93;</span> 2011-02-23 16:40:28,965
Migration.java (line 133) Applying migration 3e30e76b-1e3f-11e0-8369-5a9c1faed4ae Add
keyspace: table_userentriesrep factor:3rep
strategy:SimpleStrategy{org.apache.cassandra.config.CFMetaData@58925d9<span
class="error">&#91;cfId=1024,tableName=table_userentries,cfName=table_userentries,cfType=Standard,comparator=org.apache.cassandra.db.marshal.BytesType@b44dff0,subcolumncomparator=&lt;null&gt;,comment=,rowCacheSize=0.0,keyCacheSize=200000.0,readRepairChance=0.0,gcGraceSeconds=86400,defaultValidator=org.apache.cassandra.db.marshal.BytesType@b44dff0,minCompactionThreshold=4,maxCompactionThreshold=32,rowCacheSavePeriodInSeconds=0,keyCacheSavePeriodInSeconds=3600,memtableFlushAfterMins=60,memtableThroughputInMb=64,memtableOperationsInMillions=10.0,column_metadata={}&#93;</span>,
org.apache.cassandra.config.CFMetaData@11ab7246<span
class="error">&#91;cfId=1025,tableName=table_userentries,cfName=table_userentries_meta,cfType=Standard,comparator=org.apache.cassandra.db.marshal.BytesType@b44dff0,subcolumncomparator=&lt;null&gt;,comment=,rowCacheSize=0.0,keyCacheSize=200000.0,readRepairChance=0.0,gcGraceSeconds=86400,defaultValidator=org.apache.cassandra.db.marshal.BytesType@b44dff0,minCompactionThreshold=4,maxCompactionThreshold=32,rowCacheSavePeriodInSeconds=0,keyCacheSavePeriodInSeconds=3600,memtableFlushAfterMins=60,memtableThroughputInMb=64,memtableOperationsInMillions=10.0,column_metadata={}&#93;</span>}<br/>
INFO <span class="error">&#91;MigrationStage:1&#93;</span> 2011-02-23 16:40:28,965
ColumnFamilyStore.java (line 666) switching in a fresh Memtable for Migrations at
CommitLogContext(file='/cassandra/commitlog/CommitLog-1298475572022.log',
position=226075)<br/> INFO <span class="error">&#91;MigrationStage:1&#93;</span>
2011-02-23 16:40:28,966 ColumnFamilyStore.java (line 977) Enqueuing flush of
Memtable-Migrations@2121008793(12529 bytes, 1 operations)<br/> INFO <span
class="error">&#91;FlushWriter:1&#93;</span> 2011-02-23 16:40:28,966 Memtable.java (line
157) Writing Memtable-Migrations@2121008793(12529 bytes, 1 operations)<br/> INFO <span
class="error">&#91;MigrationStage:1&#93;</span> 2011-02-23 16:40:28,966
ColumnFamilyStore.java (line 666) switching in a fresh Memtable for Schema at
CommitLogContext(file='/cassandra/commitlog/CommitLog-1298475572022.log',
position=226075)<br/> INFO <span class="error">&#91;MigrationStage:1&#93;</span>
2011-02-23 16:40:28,967 ColumnFamilyStore.java (line 977) Enqueuing flush of
Memtable-Schema@139610466(8370 bytes, 15 operations)<br/> INFO <span
class="error">&#91;ScheduledTasks:1&#93;</span> 2011-02-23 16:40:28,972 StatusLogger.java
(line 89) table_sourcedetection.table_sourcedetection                 0,0                
0/0            0/200000<br/>ERROR <span class="error">&#91;FlushWriter:1&#93;</span>
2011-02-23 16:41:01,240 AbstractCassandraDaemon.java (line 114) Fatal exception in thread
Thread<span
class="error">&#91;FlushWriter:1,5,main&#93;</span><br/>java.lang.OutOfMemoryError: Java
heap space<br/>        at
java.nio.HeapByteBuffer.&lt;init&gt;(HeapByteBuffer.java:39)<br/>        at
java.nio.ByteBuffer.allocate(ByteBuffer.java:312)<br/>        at
org.apache.cassandra.io.util.BufferedRandomAccessFile.&lt;init&gt;(BufferedRandomAccessFile.java:126)<br/>
       at
org.apache.cassandra.io.sstable.SSTableWriter.&lt;init&gt;(SSTableWriter.java:75)<br/>    
   at org.apache.cassandra.db.Memtable.writeSortedContents(Memtable.java:158)<br/>       
at org.apache.cassandra.db.Memtable.access$000(Memtable.java:51)<br/>        at
org.apache.cassandra.db.Memtable$1.runMayThrow(Memtable.java:176)<br/>        at
org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)

2) If I restart then, I'm getting an
Nullpointer exception. The OOM error will only appear once.

ERROR <span
class="error">&#91;main&#93;</span> 2011-02-23 16:42:32,782 AbstractCassandraDaemon.java
(line 333) Exception encountered during startup.<br/>java.lang.NullPointerException<br/>  
     at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:768)<br/>       
at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:925)<br/>     
  at
org.apache.cassandra.service.MigrationManager.passiveAnnounce(MigrationManager.java:105)<br/>
       at
org.apache.cassandra.service.MigrationManager.applyMigrations(MigrationManager.java:161)<br/>
       at
org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:185)<br/>
       at
org.apache.cassandra.service.AbstractCassandraDaemon.activate(AbstractCassandraDaemon.java:316)<br/>
       at
org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:79)

Killing and
restarting the node multiple times will eventually "fix" these errors.

Steps to
reproduce. Remove complete data directory and restart node with same token/ip.
 

-----------------

-----------------
Comments: 

New Comment: 
The normal heap usage of the node is about half of the allocated heap:Gossip active    :
true<br/>Load             : 30.99 GB<br/>Generation No    : 1298476238<br/>Uptime
(seconds) : 308<br/>Heap Memory (MB) : 1544.41 / 2493.38 


New Comment: 
The OOM is because flushing allocates a buffer the size of in_memory_compaction_limit. 
Sounds like you need to lower that.The NPE looks like a bug. 


New Comment: 
What is listen_address in cassandra.yaml?  I'm having a hard time conceiving of a way for
FBUtilities.getLocalAddress() to return null. 


New Comment: 
Hi,I'm on vacation until March 14th.For urgent matters, please contact:<br/>Christophe
Folschette (christophe.folschette@trendiction.com)<br/>+352 20 33 35 32 


New Comment: 
It looks like we're doing Migration stuff before Gossiper.start is called.One possible
solution: initialize Gossiper.localEndpoint in constructor instead of in start. 


New Comment: 
CHM throws NPE when the key is null.  To me, then, the bug is that FBU.getLocalAddress()
is somehow returning null.  I checked yesterday: even if local_address is unspecified, it
ends up returning localhost. 


New Comment: 
My point was that we can call put before initializing localEndpoint_ to FBU.gLA, so it's
naturally going to be null. 


New Comment: 
aha. I was looking in the trunk code (no chance of null).  I see the problem in the 0.7
branch. 


New Comment: 
+1 


New Comment: 
committed 


