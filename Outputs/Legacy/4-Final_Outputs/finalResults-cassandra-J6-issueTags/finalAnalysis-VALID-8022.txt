Pattern changes caused by commit: e128ab0022d591923a9b5576ab4ef7c000a191a5

From: Abstract Factory-1
To:   Abstract Factory-2

From: Factory Method-1
To:   Factory Method-2

From: Decorator-2
To:   Decorator-1

From: Facade-0
To:   Facade-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-8022.txt 

commit e128ab0022d591923a9b5576ab4ef7c000a191a5
Author: Pavel Yaskevich <xedin@apache.org>

    remove special RM method for schema mutations deserialization in addition to CASSANDRA-4880



==================================
 Issue CASSANDRA-4880 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4880] Endless loop flushing+compacting system/schema_keyspaces and system/schema_columnfamilies
-----------------

-----------------
Summary: Endless loop flushing+compacting system/schema_keyspaces and system/schema_columnfamilies
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 30 Oct 2012 20:18:18 +0000
-----------------

-----------------
Resolved at: Fri, 24 Jan 2014 18:47:32 +0000
-----------------

-----------------
Assigned to: Pavel Yaskevich
-----------------

-----------------
Description: 

After upgrading a node from 1.1.2 to 1.1.6, the startup sequence entered a loop as seen
here:

<a href="http://mina.naguib.ca/misc/cassandra_116_startup_loop.txt"
class="external-link"
rel="nofollow">http://mina.naguib.ca/misc/cassandra_116_startup_loop.txt</a>

Stopping and
starting the node entered the same loop.

Reverting back to 1.1.2 started successfully.
 

-----------------

-----------------
Comments: 

New Comment: 
We also see this after upgrading a node from 1.1.0 -&gt; 1.1.6 in our ring. We also saw
increased flush writes begin continuously on the other 1.1.0 nodes in the ring after the
1.1.6 was started, but not as rapidly as on the 1.1.6 node. There were also periodic
HintedHandoffs occurring around the ring after the 1.1.6 node came up. 


New Comment: 
Is schema synchronization confused?  I can't think of any other reason for continuous
flush here. 


New Comment: 
I'm pretty sure that's what's happening, but it's not clear why.  You can artificially
reproduce this by manually injecting a conflict, such as a "Column family ID mismatch"
though that error isn't present here. 


New Comment: 
Bisects to <a href="https://issues.apache.org/jira/browse/CASSANDRA-4561" title="update
column family fails" class="issue-link"
data-issue-key="CASSANDRA-4561"><del>CASSANDRA-4561</del></a> 


New Comment: 
can you try 1.1.6 + <a href="https://issues.apache.org/jira/browse/CASSANDRA-4837"
title="IllegalStateException when upgrading schema" class="issue-link"
data-issue-key="CASSANDRA-4837"><del>CASSANDRA-4837</del></a> ? 


New Comment: 
No help <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/sad.png" height="16" width="16"
align="absmiddle" alt="" border="0"/> 


New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams"
class="user-hover" rel="brandon.williams">Brandon Williams</a> Can you attach schema_*
sstables that could trigger this behavior to the ticket please (if you have them)? 


New Comment: 
Sent to Pavel privately. 


New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mheffner"
class="user-hover" rel="mheffner">Mike Heffner</a> and <a
href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=minaguib"
class="user-hover" rel="minaguib">Mina Naguib</a> Can you please execute following
commands in CLI and post output here - "use system;" and "list schema_keyspaces"? 


New Comment: 
<a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin"
class="user-hover" rel="xedin">Pavel Yaskevich</a> Here's mine (after some very minor name
obfuscation):<div class="code panel" style="border-width: 1px;"><div class="codeContent
panelContent"><pre class="code-java">[<span class="code-keyword">default</span>@system]
list schema_keyspaces;Using <span class="code-keyword">default</span> limit of 100Using
<span class="code-keyword">default</span> column limit of 100-------------------RowKey:
AdKS=&gt; (column=durable_writes, value=<span class="code-keyword">true</span>,
timestamp=1336233003898)=&gt; (column=name, value=AdKS, timestamp=1336233003898)=&gt;
(column=strategy_class, value=org.apache.cassandra.locator.NetworkTopologyStrategy,
timestamp=1336233003898)=&gt; (column=strategy_options, value={<span
class="code-quote">"DCMTL"</span>:<span class="code-quote">"2"</span>,<span
class="code-quote">"DCLA"</span>:<span class="code-quote">"2"</span>,<span
class="code-quote">"DCLON"</span>:<span class="code-quote">"2"</span>},
timestamp=1336233003898)1 Row Returned.Elapsed time: 3 msec(s).</pre></div></div>Tomorrow
I'll run a test with cassandra 1.1.6 + <a
href="https://issues.apache.org/jira/browse/CASSANDRA-4837" title="IllegalStateException
when upgrading schema" class="issue-link"
data-issue-key="CASSANDRA-4837"><del>CASSANDRA-4837</del></a> just to add a second vote to
Brandon's test whether it helps or not. 


New Comment: 
This is after we removed the 1.1.6 node, but:<div class="code panel" style="border-width:
1px;"><div class="codeContent panelContent"><pre class="code-java">Using <span
class="code-keyword">default</span> limit of 100Using <span
class="code-keyword">default</span> column limit of 100-------------------RowKey:
KSName=&gt; (column=durable_writes, value=<span class="code-keyword">true</span>,
timestamp=5397847727343)=&gt; (column=name, value=KSName, timestamp=5397847727343)=&gt;
(column=strategy_class, value=org.apache.cassandra.locator.NetworkTopologyStrategy,
timestamp=5397847727343)=&gt; (column=strategy_options, value={<span
class="code-quote">"us-east"</span>:<span class="code-quote">"3"</span>},
timestamp=5397847727343)1 Row Returned.Elapsed time: 132 msec(s).</pre></div></div> 


New Comment: 
it looks like it wasn't a good idea to involve timestamps in computing schema version (was
super easy to do), I will work on improving things to make a migration from older versions
(which System.nanoTime() bug) as smooth as possible. 


New Comment: 
I made start timestamp schema timestamp repair account and fix any timestamps that are
grater than current timestamp and introduced new version in MessagingVersion as it's the
only way to fix infinite loop in schema due to broken nano timestamps that we can't
properly fix in &lt;= 1.1.6.Edit: Also note that once this is committed we would have to
increase VERSION number for cassandra-1.2. 


New Comment: 
Assigning Brandon as reviewer because he was initially involved. 


New Comment: 
Hmm, this unfortunate but I don't see any way around it, either.  +1 


New Comment: 
Committed. 


New Comment: 
I think something's still wrong in 1.1, concurrent schema changes aren't settling: <a
href="http://buildbot.datastax.com:8010/builders/cassandra-1.1/builds/567/steps/shell/logs/stdio"
class="external-link"
rel="nofollow">http://buildbot.datastax.com:8010/builders/cassandra-1.1/builds/567/steps/shell/logs/stdio</a>Everything
works in 1.2. 


New Comment: 
Could that be that those two stub nodes running on different versions - one on recent and
one on previous? That would explain why they have disagreement. It's tested on rolling
restart by <a href="https://issues.apache.org/jira/browse/CASSANDRA-4837"
title="IllegalStateException when upgrading schema" class="issue-link"
data-issue-key="CASSANDRA-4837"><del>CASSANDRA-4837</del></a>. 


New Comment: 
Nope, those tests all run with the same version. 


New Comment: 
Interesting... Ok, I will try to figure it out asap. 


New Comment: 
We don't need special RM deserialization handler any more, verified that tests are now
passing. 


New Comment: 
+1 


New Comment: 
Committed. 


New Comment: 
I have encountered similar bug after I upgrade one of my 1.2.2 node to 1.2.12.<br/>Was
using FreeBSD 8.2 + diablo-jre-1.6.0.07.02_18.Before I upgrading the node to 1.2.12, I
changed JVM to openjdk-7.25.15_2 (in retrospective probably not a good idea ...), saw
flipping Memtable flushes, changes JVM back to diablo-jre-1.6.0.07.02_18, and still seeing
rapid flushes. Now I've taken the 1.2.12 node offline (but not decommissioned it).After
that I see tens of Memtable flushes on the 1.2.12 per second, while once or twice a second
on nodes with 1.2.2.Attached files are the flipping schema versions. 


New Comment: 
Run the node with 1.2.2 again, and the schema converged. Further upgrading JVM to
openjdk-7.25.15_2 and Cassandra to 1.2.12 didn't reproduce the problem. Strange, but at
least my cluster now upgrading fine ... 


New Comment: 
I can easily reproduce it by having one DC with 1.2.2 and another with 1.2.12/1.2.13. see
<a href="http://pastebin.com/YZKUQLXz" class="external-link"
rel="nofollow">http://pastebin.com/YZKUQLXz</a><br/>If I grep for only
InternalResponseStage logs I get <a href="http://pastebin.com/htnXZCiT"
class="external-link" rel="nofollow">http://pastebin.com/htnXZCiT</a> which always
displays same account of ops and serialized/live bytes per column family. Column family
system/schema_columns is also concerned by this issue. 


New Comment: 
When I upgrade one node from 1.2.2 to 1.2.13 for 2h I get the previous messages with a
raise of CPU(as it flush and compact continually) on all nodes <a
href="http://picpaste.com/pics/Screen_Shot_2014-01-24_at_09.18.50-ggcCDVqd.1390551670.png"
class="external-link"
rel="nofollow">http://picpaste.com/pics/Screen_Shot_2014-01-24_at_09.18.50-ggcCDVqd.1390551670.png</a><br/>After
that, everything is fine and I can upgrade other nodes without any important raise of cpus
load. when I start the upgrade, the more nodes I upgrade at the same time (at the
beginning), the higher the cpu load is <a
href="http://picpaste.com/pics/Screen_Shot_2014-01-23_at_17.45.56-I3fdEQ2T.1390552036.png"
class="external-link"
rel="nofollow">http://picpaste.com/pics/Screen_Shot_2014-01-23_at_17.45.56-I3fdEQ2T.1390552036.png</a> 


New Comment: 
This ticket was closed more than a year ago.  Please open a new ticket if you encounter
the issue, because it's probably not related to this one. 


