Pattern changes caused by commit: 827de3f2099065c2b6ebff3907155d42861dc5b1

From: Decorator-2
To:   Decorator-1

From: Flyweight-2
To:   Flyweight-1

From: Mediator-3
To:   Mediator-1

From: Strategy-0
To:   Strategy-1

From: Template Method-3
To:   Template Method-2


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-6811.txt 

commit 827de3f2099065c2b6ebff3907155d42861dc5b1
Author: Jonathan Ellis <jbellis@apache.org>

    log MOVING mode earlier
    patch by jbellis; reviewed by Nick Bailey for CASSANDRA-4252



==================================
 Issue CASSANDRA-4252 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4252] Set operation mode to MOVING earlier
-----------------

-----------------
Summary: Set operation mode to MOVING earlier
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 16 May 2012 22:15:19 +0000
-----------------

-----------------
Resolved at: Fri, 18 May 2012 16:33:32 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

Right now when moving a node we set the OperationMode only once we've calculated the
necessary ranges to transfer and if there actually are ranges to transfer. Due to the
sleep for ring settling this means there are 30 seconds where the node is moving but the
operation mode isn't set accordingly. Additionally if it turns out no data needs to be
transferred then the move will complete without ever switching the OperationMode to
moving.
 

-----------------

-----------------
Comments: 

New Comment: 
What difference does it make as long as we set MOVING before streamRanges / requestRanges? 


New Comment: 
From a monitoring application perspective its just nicer to set the mode immediately so
that when a move is initiated the operation mode of the node changes immediately rather
than waiting 30ish seconds. Also so in the admittedly uncommon case of no data being
transferred the operation mode gets set to moving at all, which it currently won't. 


New Comment: 
<blockquote>just nicer to set the mode immediately so that when a move is initiated the
operation mode of the node changes immediately rather than waiting 30ish
seconds</blockquote>Fair enough.<blockquote>in the admittedly uncommon case of no data
being transferred the operation mode gets set to moving at all</blockquote>I think it's
inside that check to avoid logging "fetching new ranges and streaming old ranges" when
there's nothing to stream, which is also misleading.Since we don't "push" modes I don't
think there's any difference between not setting it at all, and setting it only to set
back to NORMAL a nanosecond later. 


New Comment: 
Ah you are right. I was under the impression we did the RING_DELAY sleep no matter what,
but apparently not.Regarding the 'fetching new ranges...' log message, we can call setMode
multiple times (a pattern we use for other modes). So we can just call setMode earlier on
with a more accurate log message in addition to the later call. 


New Comment: 
Patch attached. 


New Comment: 
+1 


