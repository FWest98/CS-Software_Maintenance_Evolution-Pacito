Pattern changes caused by commit: 190fb8c8eaf8127228118ab5559e21c4d694f21e

From: Facade-1
To:   Facade-0

From: Flyweight-3
To:   Flyweight-4


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5744.txt 

commit 190fb8c8eaf8127228118ab5559e21c4d694f21e
Author: Jonathan Ellis <jbellis@apache.org>

    dynamic HH page size
    patch by jbellis; reviewed by brandonwilliams for CASSANDRA-3624



==================================
 Issue CASSANDRA-3624 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3624] Hinted Handoff - related OOM
-----------------

-----------------
Summary: Hinted Handoff - related OOM
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 13 Dec 2011 20:34:48 +0000
-----------------

-----------------
Resolved at: Wed, 4 Jan 2012 16:04:13 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

One of our nodes had collected alot of hints for another node, so when the dead node came
back and the row mutations were read back from disk, the node died with an OOM-exception
(and kept dying after restart, even with increased heap (from 8G to 12G)). The heap dump
contained alot of SuperColumns and our application does not use those (but HH does). 

I'm
guessing that each mutation is big so that PAGE_SIZE*&lt;mutation_size&gt; does not fit in
memory (will check this tomorrow)

A simple fix (if my assumption above is correct) would
be to reduce the PAGE_SIZE in HintedHandOffManager.java to something like 10 (or even 1?)
to reduce the memory pressure. The performance hit would be small since we are doing the
hinted handoff throttle delay sleep before sending every <b>mutation</b> anyway (not every
page), thoughts?

If anyone runs in to the same problem, I got the node started again by
simply removing the HintsColumnFamily* files.
 

-----------------

-----------------
Comments: 

New Comment: 
That makes sense.  (How big are your mutations?)We added adaptive page sizing back in <a
href="https://issues.apache.org/jira/browse/CASSANDRA-2652" title="Hinted handoff needs to
adjust page size for lage columns to avoid OOM" class="issue-link"
data-issue-key="CASSANDRA-2652"><del>CASSANDRA-2652</del></a>, but apparently removed it
for the <a href="https://issues.apache.org/jira/browse/CASSANDRA-2045" title="Simplify HH
to decrease read load when nodes come back" class="issue-link"
data-issue-key="CASSANDRA-2045"><del>CASSANDRA-2045</del></a> redesign. 


New Comment: 
Patch to add back adaptive page sizing, and drops the default size to 128 columns. 


New Comment: 
<blockquote>The performance hit would be small since we are doing the hinted handoff
throttle delay sleep before sending every mutation anyway </blockquote>True, but this is
likely to change (see Jake's comments to <a
href="https://issues.apache.org/jira/browse/CASSANDRA-3554" title="Hints are not replayed
unless node was marked down" class="issue-link"
data-issue-key="CASSANDRA-3554"><del>CASSANDRA-3554</del></a>). 


New Comment: 
Marcus, are you able to test the attached patch? 


New Comment: 
not yet, i might be able to do it today thoughthis happened in a production cluster so i
will have to try to reproduce somewhere else 


New Comment: 
I have this problem too but i do not have large rows, i have huge number of small rows
(max 180 bytes serialized) 


New Comment: 
My OOM during HH must have been caused by something else, most likely background
compaction. I tried to use HH to deliver 2 million rows on 750MB heap and it worked fine. 


New Comment: 
rebased 


New Comment: 
+1 


New Comment: 
minor nit: typo in 'behavr' in the comment 


