Pattern changes caused by commit: 48a072dac26e89991bed9e0a0226d3880389db99

From: Abstract Factory-3
To:   Abstract Factory-2

From: Factory Method-3
To:   Factory Method-2

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-3718.txt 

commit 48a072dac26e89991bed9e0a0226d3880389db99
Author: Sylvain Lebresne <slebresne@apache.org>

    Don't all cleanup if ring is not joined (since this wiped all data)
    patch by slebresne; reviewed by jbellis for CASSANDRA-2428



==================================
 Issue CASSANDRA-2428 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2428] Running cleanup on a node with join_ring=false removes all data
-----------------

-----------------
Summary: Running cleanup on a node with join_ring=false removes all data
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 6 Apr 2011 21:58:45 +0000
-----------------

-----------------
Resolved at: Thu, 7 Apr 2011 21:00:57 +0000
-----------------

-----------------
Assigned to: Sylvain Lebresne
-----------------

-----------------
Description: 

If you need to bring up a node with join_ring=false for operator maintenance, and this
node already has data, it will end up removing the data on the node. We noticed this when
we were calling cleanup on a specific CF.
 

-----------------

-----------------
Comments: 

New Comment: 
If curious why we were running join_ring = false after the node had data, it was because
we had ran out of space on a node, and many SSTables had been created, but unable to
compact. When we brought the node back online after moving some data off, the number of
SSTables being read w/ live traffic caused us to run out of file descriptors. So we
decided to run join_ring=false on bootup, and let compaction run without taking on
traffic. This worked really well, and we wanted to finalize our cleanup process. 


New Comment: 
The ability of not joining on startup is a convenience feature but is honestly a bit half
backed. In particular the token ranges are not set correctly. That's the reason why
cleanup gets an empty list of ranges when querying the local ranges and thus clean
everything.Attached patch band-aid this by refusing to do a cleanup compaction. I don't
think we want to do more for 0.7. We could make join_ring=false better so that it sets the
ranges based and what's in the system tables, but let's fix the dangerous behavior first
and let that for another ticket. 


New Comment: 
Sylvain-That seems like the right plan. 


New Comment: 
+1 


New Comment: 
Committed as r1090007 


