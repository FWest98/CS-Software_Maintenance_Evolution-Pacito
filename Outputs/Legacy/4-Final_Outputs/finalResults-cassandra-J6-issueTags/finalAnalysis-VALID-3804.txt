Pattern changes caused by commit: 86f6184d0d09f3f3a2c6d080c88e31810f373020

From: Abstract Factory-3
To:   Abstract Factory-2

From: Factory Method-3
To:   Factory Method-2

From: Mediator-2
To:   Mediator-1


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-3804.txt 

commit 86f6184d0d09f3f3a2c6d080c88e31810f373020
Author: Jonathan Ellis <jbellis@apache.org>

    avoid caching token-only decoratedkeys
    patch by jbellis; reviewed by slebresne for CASSANDRA-2416



==================================
 Issue CASSANDRA-2416 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-2416] NullPointerException in CacheWriter.saveCache()
-----------------

-----------------
Summary: NullPointerException in CacheWriter.saveCache()
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 5 Apr 2011 09:28:57 +0000
-----------------

-----------------
Resolved at: Mon, 18 Apr 2011 16:56:52 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

I've seen NullPointerException of CacheWriter in our cluster (replication 3).

ERROR
<span class="error">&#91;CompactionExecutor:1&#93;</span> 2011-04-05 09:57:42,968
AbstractCassandraDaemon.java (line 112) Fatal exception in thread Thread<span
class="error">&#91;CompactionExecutor:1,1,main&#93;</span><br/>java.lang.RuntimeException:
java.lang.NullPointerException<br/>        at
org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)<br/>        at
java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)<br/>        at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br/>        at
java.util.concurrent.FutureTask.run(FutureTask.java:138)<br/>        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>  
     at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>      
 at java.lang.Thread.run(Thread.java:662)<br/>Caused by:
java.lang.NullPointerException<br/>        at
org.apache.cassandra.utils.ByteBufferUtil.writeWithLength(ByteBufferUtil.java:275)<br/>   
    at org.apache.cassandra.io.sstable.CacheWriter.saveCache(CacheWriter.java:84)<br/>    
   at
org.apache.cassandra.db.CompactionManager$10.runMayThrow(CompactionManager.java:960)<br/> 
      at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)<br/>     
  ... 6 more
 

-----------------

-----------------
Comments: 

New Comment: 
Patch to avoid storing DecoratedKeys with null key (which are generated by getRangeSlice)
in the key cache. 


New Comment: 
Why not do that in cacheKey directly to be sure we don't miss places ? 


New Comment: 
Because attempting to cache a DK that is really just a token is a semantic error that we
shouldn't just paper over.  v2 adds an assert to make that clear. 


New Comment: 
+1 


New Comment: 
committed 


