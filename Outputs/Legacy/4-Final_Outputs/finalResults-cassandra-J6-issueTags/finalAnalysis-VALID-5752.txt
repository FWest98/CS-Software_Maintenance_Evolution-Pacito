Pattern changes caused by commit: 70a350e6e975c8c1aaaa5ed732f090974621355c

From: Decorator-1
To:   Decorator-0

From: Flyweight-4
To:   Flyweight-5

From: Strategy-1
To:   Strategy-0


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-5752.txt 

commit 70a350e6e975c8c1aaaa5ed732f090974621355c
Author: Jonathan Ellis <jbellis@apache.org>

    use correct list of replicas for LOCAL_QUORUM reads when read repair is disabled
    patch by jbellis; reviewed by Vijay for CASSANDRA-3696



==================================
 Issue CASSANDRA-3696 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-3696] Adding another datacenter's node results in 0 rows returned on first datacenter
-----------------

-----------------
Summary: Adding another datacenter's node results in 0 rows returned on first datacenter
-----------------

-----------------
Issue type: Bug
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Wed, 4 Jan 2012 19:02:33 +0000
-----------------

-----------------
Resolved at: Thu, 5 Jan 2012 22:42:28 +0000
-----------------

-----------------
Assigned to: Jonathan Ellis
-----------------

-----------------
Description: 

On Cassandra-1.0.5:<br/>1. Create a node in C* with a fresh installation and create a
keyspace on that node with one column family -

CREATE KEYSPACE test <br/>WITH
placement_strategy = 'SimpleStrategy' <br/>and
strategy_options=
{replication_factor:1}
;

use test; <br/>create column family cf1;

2.
Insert values into cf1 -

set cf1<span
class="error">&#91;ascii(&#39;k&#39;)&#93;</span><span
class="error">&#91;ascii(&#39;c&#39;)&#93;</span> = ascii('v');

get cf1<span
class="error">&#91;ascii(&#39;k&#39;)&#93;</span>; <br/>=&gt; (column=63, value=v,
timestamp=1325689630397000) <br/>Returned 1 results.

3. update the strategy options from
simple to networktopology with 
{Cassandra:1, Backup:1}
 <br/>4. read from cf1 to make
sure the options change doesn't affect anything -

consistencylevel as LOCAL_QUORUM;
<br/>get cf1<span class="error">&#91;ascii(&#39;k&#39;)&#93;</span>; <br/>=&gt;
(column=63, value=v, timestamp=1325689630397000) <br/>Returned 1 results.

5. start a
second node in the Backup datacenter <br/>6. read from cf1 again (on the first node)
-

consistencylevel as LOCAL_QUORUM; <br/>get cf1<span
class="error">&#91;ascii(&#39;k&#39;)&#93;</span>; <br/>Returned 0 results.

After about
60 seconds, "get cf1<span class="error">&#91;ascii(&#39;k&#39;)&#93;</span>" started to
return results again. 

Also, when running at a CL of ONE on 1.0's head, we were able to
see issues as well.

But, if more than one node was added to the second datacenter, then
replication_strategy is changed, it seems okay.
 

-----------------

-----------------
Comments: 

New Comment: 
ONE is expected to not return results in this situation, if it happens to query the new
node.  But LOCAL_QUORUM against the first node should be fine.Can you post the debug log
of a query failing at LOCAL_QUORUM?  1.0 head preferred but 1.0.5 is fine if you already
have it. 


New Comment: 
I can reproduce this reliably, but only if read repair is on.  With it off, everything
works.  Here is failed read:<div class="preformatted panel" style="border-width:
1px;"><div class="preformattedContent panelContent"><pre>DEBUG [pool-2-thread-7]
2012-01-05 01:00:51,523 CassandraServer.java (line 323) get_sliceDEBUG [pool-2-thread-7]
2012-01-05 01:00:51,523 StorageProxy.java (line 603) Command/ConsistencyLevel is
SliceFromReadCommand(table='Keyspace1', key='303637',
column_parent='QueryPath(columnFamilyName='Standard1', superColumnName='null',
columnName='null')', start='', finish='', reversed=false, count=5)/LOCAL_QUORUMDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,523 PropertyFileSnitch.java (line 90) Could not find
end point information for cassandra-1/10.179.65.102, will use defaultDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,523 PropertyFileSnitch.java (line 90) Could not find
end point information for /10.179.111.137, will use defaultDEBUG [pool-2-thread-7]
2012-01-05 01:00:51,523 ReadCallback.java (line 77) Blockfor/repair is 1/true; setting up
requests to /10.179.64.227,/10.179.111.137DEBUG [pool-2-thread-7] 2012-01-05 01:00:51,523
PropertyFileSnitch.java (line 90) Could not find end point information for
/10.179.111.137, will use defaultDEBUG [pool-2-thread-7] 2012-01-05 01:00:51,523
StorageProxy.java (line 624) reading data from /10.179.64.227DEBUG [pool-2-thread-7]
2012-01-05 01:00:51,524 StorageProxy.java (line 644) reading digest from
/10.179.111.137DEBUG [RequestResponseStage:9] 2012-01-05 01:00:51,526
ResponseVerbHandler.java (line 44) Processing response on a callback from
4145@/10.179.111.137DEBUG [RequestResponseStage:10] 2012-01-05 01:00:51,526
ResponseVerbHandler.java (line 44) Processing response on a callback from
4144@/10.179.64.227DEBUG [RequestResponseStage:9] 2012-01-05 01:00:51,526
AbstractRowResolver.java (line 66) Preprocessed digest responseDEBUG
[RequestResponseStage:10] 2012-01-05 01:00:51,526 AbstractRowResolver.java (line 66)
Preprocessed data responseDEBUG [RequestResponseStage:9] 2012-01-05 01:00:51,527
PropertyFileSnitch.java (line 90) Could not find end point information for
/10.179.111.137, will use defaultDEBUG [pool-2-thread-7] 2012-01-05 01:00:51,527
StorageProxy.java (line 672) Read: 3 ms.</pre></div></div>In this case, 10.179.65.102 and
10.179.111.137 are in the first datacenter, and 10.179.64.227 is in the second.  Both DCs
have an RF of one, .102 is always the coordinator and the client is using a single
connection.For comparison, here is a successful local read where read repair did not fire
(set to 10%):<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>DEBUG [pool-2-thread-7] 2012-01-05
01:00:51,519 CassandraServer.java (line 323) get_sliceDEBUG [pool-2-thread-7] 2012-01-05
01:00:51,519 StorageProxy.java (line 603) Command/ConsistencyLevel is
SliceFromReadCommand(table='Keyspace1', key='303632',
column_parent='QueryPath(columnFamilyName='Standard1', superColumnName='null',
columnName='null')', start='', finish='', reversed=false, count=5)/LOCAL_QUORUMDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,519 PropertyFileSnitch.java (line 90) Could not find
end point information for cassandra-1/10.179.65.102, will use defaultDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,520 ReadCallback.java (line 77) Blockfor/repair is
1/false; setting up requests to cassandra-1/10.179.65.102DEBUG [pool-2-thread-7]
2012-01-05 01:00:51,520 PropertyFileSnitch.java (line 90) Could not find end point
information for cassandra-1/10.179.65.102, will use defaultDEBUG [pool-2-thread-7]
2012-01-05 01:00:51,520 StorageProxy.java (line 619) reading data locallyDEBUG
[ReadStage:93] 2012-01-05 01:00:51,520 StorageProxy.java (line 763) LocalReadRunnable
reading SliceFromReadCommand(table='Keyspace1', key='303632',
column_parent='QueryPath(columnFamilyName='Standard1', superColumnName='null',
columnName='null')', start='', finish='', reversed=false, count=5)DEBUG [ReadStage:93]
2012-01-05 01:00:51,520 CollationController.java (line 192) collectAllDataDEBUG
[ReadStage:93] 2012-01-05 01:00:51,521 SliceQueryFilter.java (line 123) collecting 0 of 5:
C0:false:34@1325724968371DEBUG [ReadStage:93] 2012-01-05 01:00:51,521
SliceQueryFilter.java (line 123) collecting 1 of 5: C1:false:34@1325724968371DEBUG
[ReadStage:93] 2012-01-05 01:00:51,521 SliceQueryFilter.java (line 123) collecting 2 of 5:
C2:false:34@1325724968371DEBUG [ReadStage:93] 2012-01-05 01:00:51,521
SliceQueryFilter.java (line 123) collecting 3 of 5: C3:false:34@1325724968371DEBUG
[ReadStage:93] 2012-01-05 01:00:51,521 SliceQueryFilter.java (line 123) collecting 4 of 5:
C4:false:34@1325724968371DEBUG [pool-2-thread-7] 2012-01-05 01:00:51,522 StorageProxy.java
(line 672) Read: 2 ms.</pre></div></div>And one where it asked .137 for data (but did not
leave the DC or repair):<div class="preformatted panel" style="border-width: 1px;"><div
class="preformattedContent panelContent"><pre>DEBUG [pool-2-thread-7] 2012-01-05
01:00:51,514 CassandraServer.java (line 323) get_sliceDEBUG [pool-2-thread-7] 2012-01-05
01:00:51,514 StorageProxy.java (line 603) Command/ConsistencyLevel is
SliceFromReadCommand(table='Keyspace1', key='303731',
column_parent='QueryPath(columnFamilyName='Standard1', superColumnName='null',
columnName='null')', start='', finish='', reversed=false, count=5)/LOCAL_QUORUMDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,514 PropertyFileSnitch.java (line 90) Could not find
end point information for cassandra-1/10.179.65.102, will use defaultDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,514 PropertyFileSnitch.java (line 90) Could not find
end point information for /10.179.111.137, will use defaultDEBUG [pool-2-thread-7]
2012-01-05 01:00:51,514 PropertyFileSnitch.java (line 90) Could not find end point
information for /10.179.111.137, will use defaultDEBUG [pool-2-thread-7] 2012-01-05
01:00:51,515 ReadCallback.java (line 77) Blockfor/repair is 1/false; setting up requests
to /10.179.111.137DEBUG [pool-2-thread-7] 2012-01-05 01:00:51,515 PropertyFileSnitch.java
(line 90) Could not find end point information for /10.179.111.137, will use defaultDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,515 StorageProxy.java (line 624) reading data from
/10.179.111.137DEBUG [RequestResponseStage:12] 2012-01-05 01:00:51,517
ResponseVerbHandler.java (line 44) Processing response on a callback from
4143@/10.179.111.137DEBUG [RequestResponseStage:12] 2012-01-05 01:00:51,517
AbstractRowResolver.java (line 66) Preprocessed data responseDEBUG
[RequestResponseStage:12] 2012-01-05 01:00:51,517 PropertyFileSnitch.java (line 90) Could
not find end point information for /10.179.111.137, will use defaultDEBUG
[pool-2-thread-7] 2012-01-05 01:00:51,517 StorageProxy.java (line 672) Read: 2
ms.</pre></div></div> 


New Comment: 
Fix attached.  The problem is we were only pulling out the local-dc replicas when RR was
enabled.  We still need to force a local-DC replica to the front of the endpoints list
otherwise, since that will get the data read. 


New Comment: 
(patch is against 1.0 but probably needed by 0.8 too.) 


New Comment: 
+1 


