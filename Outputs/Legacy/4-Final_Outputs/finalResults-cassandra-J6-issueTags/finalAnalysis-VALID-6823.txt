Pattern changes caused by commit: 4a3fa3c85ac4bebbc430eaec36c5e0aa67236c85

From: Decorator-1
To:   Decorator-2

From: Flyweight-1
To:   Flyweight-2

From: Mediator-1
To:   Mediator-3

From: Strategy-1
To:   Strategy-0

From: Template Method-2
To:   Template Method-3


=========================
       NEW GIT LOG
=========================

This commit refers to file: VALID-6823.txt 

commit 4a3fa3c85ac4bebbc430eaec36c5e0aa67236c85
Author: Jonathan Ellis <jbellis@apache.org>

    serializedSize fixes
    patch by yukim; reviewed by jbellis for CASSANDRA-4247



==================================
 Issue CASSANDRA-4247 Description 
=======================================

Project: Cassandra
-----------------

-----------------
Title: [CASSANDRA-4247] More-efficient serialization for IndexScanCommand and RangeSliceCommand
-----------------

-----------------
Summary: More-efficient serialization for IndexScanCommand and RangeSliceCommand
-----------------

-----------------
Issue type: Improvement
-----------------

-----------------
Current status: Resolved
-----------------

-----------------
Created at: Tue, 15 May 2012 21:06:30 +0000
-----------------

-----------------
Resolved at: Mon, 21 May 2012 21:02:19 +0000
-----------------

-----------------
Assigned to: Yuki Morishita
-----------------

-----------------
Description: 

These two classes embed a Thrift struct to simplify de/serialization. This means we
serialize to byte[] twice on the write path: once to get the size, and again to actually
send the message.

We should serialize manually like the other commands in VERSION_12.
 

-----------------

-----------------
Comments: 

New Comment: 
Patch attached to directly de/serialize from/to stream.Not related to this ticket, but I
also attached SerializationsTest fixes. 


New Comment: 
Committed 0002.0001 gets us about halfway there; on the write path for RSCS,
serialize(expr).length in serializedSize still has to write it out to a byte[] that we
promptly discard.v2 cuts Thrift serialization out entirely so we can calculate size
without creating a byte[] copy. 


New Comment: 
v2 wasn't fully baked yet... taking another stab at it 


New Comment: 
Pushed to <a href="https://github.com/jbellis/cassandra/branches/4247-3"
class="external-link"
rel="nofollow">https://github.com/jbellis/cassandra/branches/4247-3</a> with some
additional cleanup of versioning that is obsolete post-<a
href="https://issues.apache.org/jira/browse/CASSANDRA-3617" title="Clean up and optimize
Message" class="issue-link" data-issue-key="CASSANDRA-3617"><del>CASSANDRA-3617</del></a> 


New Comment: 
Ah, your approach is better. <img class="emoticon"
src="https://issues.apache.org/jira/images/icons/emoticons/smile.png" height="16"
width="16" align="absmiddle" alt="" border="0"/>But I think there is a problem in
serialization order. When performing range slice, first we check whether SlicePredicate's
column_names is specified, and if it is we ignore slice_range. So we need to check
column_names != null and serialize column_names first instead of range != null and
serialize range. If we specified both range and column names in predicate, we would get
unexpected result. 


New Comment: 
Isn't this what we're checking for in ThriftValidation?<div class="code panel"
style="border-width: 1px;"><div class="codeContent panelContent"><pre class="code-java">. 
     <span class="code-keyword">if</span> (predicate.column_names == <span
class="code-keyword">null</span> &amp;&amp; predicate.slice_range == <span
class="code-keyword">null</span>)            <span class="code-keyword">throw</span> <span
class="code-keyword">new</span> InvalidRequestException(<span
class="code-quote">"predicate column_names and slice_range may not both be <span
class="code-keyword">null</span>"</span>);        <span class="code-keyword">if</span>
(predicate.column_names != <span class="code-keyword">null</span> &amp;&amp;
predicate.slice_range != <span class="code-keyword">null</span>)            <span
class="code-keyword">throw</span> <span class="code-keyword">new</span>
InvalidRequestException(<span class="code-quote">"predicate column_names and slice_range
may not both be present"</span>);</pre></div></div> 


New Comment: 
Oh, I missed that part. +1 then.You also need to update test/data/1.2/ by doing <tt>ant
msg-ser-gen-test</tt> since serialized format is changed for RSC. But that ant command
fails because there is an error in MerkleTree serializedSize, so I pushed fix and new
version of test data here: <a href="https://github.com/yukim/cassandra/commits/4247-4"
class="external-link" rel="nofollow">https://github.com/yukim/cassandra/commits/4247-4</a> 


